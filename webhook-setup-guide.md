# 포트원 웹훅 설정 가이드

이 가이드는 포트원(PortOne) 결제 시스템의 웹훅을 설정하는 방법을 안내합니다. 웹훅을 통해 결제 상태 변경 시 자동으로 알림을 받아 결제 처리의 안정성을 높일 수 있습니다.

## 웹훅 설정 단계

### 1. 포트원 관리자 콘솔 접속
- [포트원 관리자 콘솔](https://admin.portone.io/)에 로그인합니다.

### 2. 개발 설정 메뉴로 이동
- 좌측 메뉴에서 **개발 설정** > **웹훅(Webhook)** 항목을 선택합니다.

### 3. 웹훅 URL 설정
- **웹훅 URL 추가** 버튼을 클릭합니다.
- 다음 URL을 입력합니다: `https://plantbid-ko.replit.app/api/portone/webhook`
  (Replit 배포 URL에 맞게 수정하세요)

### 4. 웹훅 시크릿 설정 (선택사항)
- 보안을 위해 웹훅 시크릿 키를 설정할 수 있습니다.
- 시크릿 키 생성 후 서버의 환경 변수 `PORTONE_WEBHOOK_SECRET`에 동일한 값을 설정해야 합니다.

### 5. 이벤트 유형 선택
- **결제 상태 변경(PAYMENT_STATUS_CHANGED)** 이벤트를 선택합니다.
- 필요한 경우 다른 이벤트 유형도 선택할 수 있습니다.

### 6. 저장 및 테스트
- 설정을 저장합니다.
- "테스트 웹훅 발송" 버튼을 클릭하여 웹훅 연결을 테스트합니다.

## 웹훅 테스트

웹훅이 올바르게 설정되었는지 확인하기 위해 다음을 수행하세요:

1. 서버 로그 확인:
   ```
   웹훅 이벤트 수신 시 [웹훅] 프리픽스로 시작하는 로그 메시지가 출력됩니다.
   ```

2. 테스트 엔드포인트 접속:
   ```
   http://localhost:5000/api/portone/webhook/test
   ```
   이 엔드포인트에 접속하면 웹훅 URL 정보를 확인할 수 있습니다.

## 주의사항

1. 웹훅 URL은 반드시 HTTPS 프로토콜을 사용해야 합니다 (실제 배포 환경에서).
2. 포트원 서버에서 접근 가능한 공개 URL이어야 합니다.
3. 웹훅 요청에 대해 항상 200 OK 응답을 반환해야 합니다 (오류가 발생해도).

## 웹훅 이벤트 형식

포트원에서 전송하는 웹훅 이벤트의 기본 형식은 다음과 같습니다:

```json
{
  "eventType": "PAYMENT_STATUS_CHANGED",
  "data": {
    "payment": {
      "status": "COMPLETED",
      "paymentKey": "5zJ4xY7m0kODnyRpQWGrN2xqGlNvLrKwv1M9ENjbeoPaZdL6",
      "orderId": "order_1234567890",
      "amount": 15000,
      "method": "card",
      "requestedAt": "2023-01-01T12:00:00+09:00",
      "approvedAt": "2023-01-01T12:01:00+09:00",
      "cancellations": [
        {
          "cancelledAt": "2023-01-01T13:00:00+09:00",
          "reason": "고객 요청에 의한 취소"
        }
      ]
    }
  }
}
```

---

이 설정을 완료하면 결제 상태 변경 시 자동으로 알림을 받아 데이터베이스를 동기화할 수 있습니다.