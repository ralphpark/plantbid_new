import { useState, useEffect, useRef } from "react";
import { useToast } from "@/hooks/use-toast";
import { useAuth } from "@/hooks/use-auth";
import { useKoreanTime } from "@/lib/use-korean-time";
import { Redirect, useLocation, useRoute } from "wouter";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { Card, CardContent } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { TypingEffect } from "@/components/ui/typing-effect";
import { 
  Select, 
  SelectContent, 
  SelectItem, 
  SelectTrigger, 
  SelectValue 
} from "@/components/ui/select";
import { 
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger
} from "@/components/ui/accordion";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
  DialogClose,
  DialogDescription
} from "@/components/ui/dialog";
import { Skeleton } from "@/components/ui/skeleton";
import { Slider } from "@/components/ui/slider";
import { useQuery, useMutation } from "@tanstack/react-query";
import { Header } from "@/components/layout/header";
import { Footer } from "@/components/layout/footer";
import { Loader2, Send, Bot, User, ExternalLink, X, Plus, MessageSquareText, Leaf, Search, Crosshair, MapPin, CheckCircle, Store } from "lucide-react";
import { cn } from "@/lib/utils";
import { apiRequest, queryClient } from "@/lib/queryClient";
import { startNewAIConversation } from "@/lib/api-utils";
import GoogleMapWrapper from "@/components/map/google-map";
import { DashboardLayout } from "@/components/layout/dashboard-layout";
import { ConversationDrawer } from "@/components/conversation/conversation-drawer";

// ì‹ë¬¼ ì¶”ì²œ íƒ€ì… ì •ì˜
interface PlantRecommendation {
  name: string;
  description: string;
  careInstructions: string;
  priceRange: string;
  imageUrl?: string;
}

// ìƒí’ˆ ì •ë³´ íƒ€ì… ì •ì˜
interface ProductInfo {
  id?: number;
  name: string;
  price: number;
  description?: string;
  imageUrl?: string;
  vendorName?: string;
  storeName?: string;
  basePrice?: number; // ê¸°ë³¸ê°€
  bidPrice?: number; // ì‹¤ì œ ì…ì°°ê°€
  vendorProfileImageUrl?: string;
  vendorId?: number;
  vendorColor?: string;
}

// ì±„íŒ… ë©”ì‹œì§€ íƒ€ì… ì •ì˜
interface ChatMessage {
  role: "user" | "assistant" | "vendor";
  content: string;
  timestamp: Date;
  recommendations?: PlantRecommendation[];
  imageUrl?: string; // ì°¸ê³  ì´ë¯¸ì§€ URL
  product?: ProductInfo; // ìƒí’ˆ ì •ë³´ (íŒë§¤ì ì…ì°° ì‹œ)
  vendorId?: number; // íŒë§¤ì ID (íŒë§¤ì ë©”ì‹œì§€ì¸ ê²½ìš°)
  vendorName?: string; // íŒë§¤ì ì´ë¦„ (íŒë§¤ì ë©”ì‹œì§€ì¸ ê²½ìš°)
  storeName?: string; // ìƒì  ì´ë¦„ (íŒë§¤ì ë©”ì‹œì§€ì¸ ê²½ìš°)
  vendorColor?: string; // íŒë§¤ì ìƒ‰ìƒ (íŒë§¤ì ë©”ì‹œì§€ì¸ ê²½ìš°)
}

export default function AIConsultationPage() {
  const { user } = useAuth();
  const { toast } = useToast();
  const { formatTime } = useKoreanTime();
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const chatContainerRef = useRef<HTMLDivElement>(null);
  const [location, setLocation] = useLocation();
  const [match, params] = useRoute("/ai-consultation");
  const [input, setInput] = useState("");
  const [conversationId, setConversationId] = useState<number | null>(null);
  const [selectedMode, setSelectedMode] = useState<string | null>(null);
  // ì´ˆê¸° ë©”ì‹œì§€ë¡œ ëŒ€í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤
  const [messages, setMessages] = useState<ChatMessage[]>([]);
  const [isProcessing, setIsProcessing] = useState(false);
  const [selectedPlant, setSelectedPlant] = useState<string | null>(null);
  const [region, setRegion] = useState<string>("");
  const [isSelectingRegion, setIsSelectingRegion] = useState(false);
  const [infoDialogOpen, setInfoDialogOpen] = useState(false);
  const [currentPlantInfo, setCurrentPlantInfo] = useState<PlantRecommendation | null>(null);
  const [isCreatingNewConversation, setIsCreatingNewConversation] = useState(false);
  
  // ì´ë¯¸ì§€ ì—…ë¡œë“œ ê´€ë ¨ ìƒíƒœ
  const [selectedImage, setSelectedImage] = useState<File | null>(null);
  const [uploadedImageUrl, setUploadedImageUrl] = useState<string | null>(null);
  const [isUploading, setIsUploading] = useState(false);
  
  // ì¶”ê°€ ìƒíƒœë“¤
  const [interactionMode, setInteractionMode] = useState<"initial" | "ai-recommendation" | "manual-selection" | "location-selection" | "bid-requested">("initial");
  const [searchResults, setSearchResults] = useState<any[]>([]);
  const [isSearching, setIsSearching] = useState(false);
  const [searchTerm, setSearchTerm] = useState("");
  const [selectedLocation, setSelectedLocation] = useState<{
    address: string;
    lat: number;
    lng: number;
    radius: number;
  } | null>(null);

  // ìŠ¤í¬ë¡¤ì„ í•­ìƒ ìµœì‹  ë©”ì‹œì§€ë¡œ ì´ë™ - messagesê°€ ë³€ê²½ë  ë•Œë§Œ ì‹¤í–‰
  useEffect(() => {
    const chatContainer = document.getElementById('chat-container');
    if (chatContainer) {
      // setTimeoutìœ¼ë¡œ ì•½ê°„ ì§€ì—°ì‹œì¼œ DOMì´ ì™„ì „íˆ ì—…ë°ì´íŠ¸ëœ í›„ ìŠ¤í¬ë¡¤í•˜ë„ë¡ í•¨
      const timeoutId = setTimeout(() => {
        console.log('ì±„íŒ…ì°½ ìŠ¤í¬ë¡¤ ìë™ ì´ë™');
        chatContainer.scrollTo({
          top: chatContainer.scrollHeight,
          behavior: 'smooth'
        });
      }, 100);
      
      // í´ë¦°ì—… í•¨ìˆ˜
      return () => clearTimeout(timeoutId);
    }
  }, [messages]);

  // URL íŒŒë¼ë¯¸í„°ì—ì„œ ëŒ€í™” ID ê°€ì ¸ì˜¤ê¸° (í˜ì´ì§€ ë¡œë“œ ì‹œ í•œë²ˆë§Œ ê°€ì ¸ì˜´)
  const searchParams = new URLSearchParams(window.location.search);
  const conversationIdParam = searchParams.get('conversation');
  
  // í˜ì´ì§€ ë¡œë“œ ì‹œ ë§ˆì§€ë§‰ ëŒ€í™” ê°€ì ¸ì˜¤ê¸° ë˜ëŠ” íŠ¹ì • ëŒ€í™” ê°€ì ¸ì˜¤ê¸°
  useEffect(() => {
    const loadConversationOnMount = async () => {
      // ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ì—†ìœ¼ë©´ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
      if (!user) {
        console.log("ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•˜ì§€ ì•Šì•„ ëŒ€í™”ë¥¼ ê°€ì ¸ì˜¤ì§€ ì•ŠìŒ");
        return;
      }

      try {
        // URLì— ëŒ€í™” IDê°€ ìˆìœ¼ë©´ í•´ë‹¹ ëŒ€í™”ë¥¼ ë¡œë“œ
        if (conversationIdParam) {
          console.log(`í˜ì´ì§€ ë¡œë“œ ì‹œ ëŒ€í™” ID: ${conversationIdParam} ê°€ì ¸ì˜¤ê¸°`);
          const response = await fetch(`/api/conversations/${conversationIdParam}`, {
            credentials: 'include'
          });
          
          if (!response.ok) {
            console.error("ëŒ€í™” ë¡œë“œ ì‹¤íŒ¨:", response.status);
            return;
          }
          
          const conversation = await response.json();
          console.log("ì„œë²„ì—ì„œ ë°›ì€ ëŒ€í™” ë°ì´í„°:", conversation);
          
          // showLastConversation íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ ëŒ€í™” ë‚´ìš©ì„ ë°”ë¡œ í‘œì‹œ
          const showLastConversation = new URLSearchParams(window.location.search).get('showLastConversation');
          if (showLastConversation === 'true') {
            // ëŒ€í™” ë‚´ìš© í™•ì¥ì´ ì§„í–‰ë˜ë©´ ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ setTimeoutìœ¼ë¡œ ì•½ê°„ ì§€ì—°
            setTimeout(() => {
              console.log('ë§ˆì§€ë§‰ ëŒ€í™” í‘œì‹œ ì¤€ë¹„ ì¤‘...');
              // ì±„íŒ…ì°½ ìŠ¤í¬ë¡¤ì„ ë§ˆì§€ë§‰ìœ¼ë¡œ ì´ë™
              const chatContainer = document.getElementById('chat-container');
              if (chatContainer) {
                console.log('ì±„íŒ…ì°½ ìŠ¤í¬ë¡¤ ì´ë™');
                chatContainer.scrollTo({
                  top: chatContainer.scrollHeight,
                  behavior: 'smooth'
                });
              }
            }, 300);
          }
          
          // ìƒíƒœ ì—…ë°ì´íŠ¸
          setConversationId(conversation.id);
          
          if (conversation.messages && conversation.messages.length > 0) {
            const mappedMessages = conversation.messages.map((msg: any) => ({
              role: msg.role,
              content: msg.content,
              timestamp: new Date(msg.timestamp),
              recommendations: msg.recommendations || [],
              product: msg.product, // ìƒí’ˆ ì •ë³´ ìœ ì§€
              vendorId: msg.vendorId,
              vendorName: msg.vendorName,
              storeName: msg.storeName,
              vendorColor: msg.vendorColor
            }));
            setMessages(mappedMessages);
          }
        } else {
          // URLì— ëŒ€í™” IDê°€ ì—†ìœ¼ë©´ ë§ˆì§€ë§‰ ëŒ€í™”ë¥¼ ê°€ì ¸ì™€ì„œ í‘œì‹œ
          console.log("ë¡œê·¸ì¸ í›„ ë§ˆì§€ë§‰ ëŒ€í™” ê°€ì ¸ì˜¤ê¸° ì‹œë„");
          
          // ì „ì²´ ëŒ€í™” ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          const conversationsResponse = await fetch("/api/conversations", {
            credentials: 'include'
          });
          
          if (!conversationsResponse.ok) {
            console.error("ëŒ€í™” ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", conversationsResponse.status);
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì´ˆê¸° ë©”ì‹œì§€ í‘œì‹œ
            setInitialAssistantMessage();
            return;
          }
          
          const conversations = await conversationsResponse.json();
          
          if (conversations && conversations.length > 0) {
            // ë§ˆì§€ë§‰ ëŒ€í™”(ê°€ì¥ ìµœê·¼ì— ìˆ˜ì •ëœ ëŒ€í™”) ê°€ì ¸ì˜¤ê¸°
            const lastConversation = conversations[0]; // APIê°€ ì •ë ¬ëœ ê²°ê³¼ë¥¼ ë°˜í™˜í•œë‹¤ê³  ê°€ì •
            console.log(`ë§ˆì§€ë§‰ ëŒ€í™” ê°€ì ¸ì˜¤ê¸°: ID ${lastConversation.id}`);
            
            // ë§ˆì§€ë§‰ ëŒ€í™” ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const response = await fetch(`/api/conversations/${lastConversation.id}`, {
              credentials: 'include'
            });
            
            if (response.ok) {
              const conversation = await response.json();
              console.log("ë§ˆì§€ë§‰ ëŒ€í™” ë°ì´í„°:", conversation);
              
              // ìƒíƒœ ì—…ë°ì´íŠ¸
              setConversationId(conversation.id);
              
              // URL ì—…ë°ì´íŠ¸ (URLì´ ë³€ê²½ë˜ì–´ë„ ì‹¤ì œ í˜ì´ì§€ ì´ë™ì€ ì—†ìŒ)
              setLocation(`/ai-consultation?conversation=${conversation.id}&showLastConversation=true`);
              
              if (conversation.messages && conversation.messages.length > 0) {
                // ë©”ì‹œì§€ ë§¤í•‘
                const mappedMessages = conversation.messages.map((msg: any) => ({
                  role: msg.role,
                  content: msg.content,
                  timestamp: new Date(msg.timestamp),
                  recommendations: msg.recommendations || [],
                  product: msg.product, // ìƒí’ˆ ì •ë³´ ìœ ì§€
                  vendorId: msg.vendorId,
                  vendorName: msg.vendorName,
                  storeName: msg.storeName,
                  vendorColor: msg.vendorColor
                }));
                
                setMessages(mappedMessages);
                
                // ì±„íŒ…ì°½ ìŠ¤í¬ë¡¤ ì´ë™
                setTimeout(() => {
                  const chatContainer = document.getElementById('chat-container');
                  if (chatContainer) {
                    console.log('ë§ˆì§€ë§‰ ëŒ€í™” ìë™ ìŠ¤í¬ë¡¤ ì´ë™');
                    chatContainer.scrollTo({
                      top: chatContainer.scrollHeight,
                      behavior: 'smooth'
                    });
                  }
                }, 300);
                
                return; // ì„±ê³µì ìœ¼ë¡œ ë§ˆì§€ë§‰ ëŒ€í™”ë¥¼ ê°€ì ¸ì™”ìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œ í•¨ìˆ˜ ì¢…ë£Œ
              }
            } else {
              console.error("ë§ˆì§€ë§‰ ëŒ€í™” ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", response.status);
            }
          }
          
          // ë§ˆì§€ë§‰ ëŒ€í™”ê°€ ì—†ê±°ë‚˜ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨ ì‹œ ì´ˆê¸° ë©”ì‹œì§€ í‘œì‹œ
          console.log("ë§ˆì§€ë§‰ ëŒ€í™”ê°€ ì—†ê±°ë‚˜ ì˜¤ë¥˜ ë°œìƒ, ì´ˆê¸° ë©”ì‹œì§€ í‘œì‹œ");
          setInitialAssistantMessage();
        }
      } catch (error) {
        console.error("ëŒ€í™” ë¡œë“œ ì¤‘ ì˜ˆì™¸ ë°œìƒ:", error);
        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì´ˆê¸° ë©”ì‹œì§€ í‘œì‹œ
        setInitialAssistantMessage();
      }
    };
    
    // ì´ˆê¸° ì–´ì‹œìŠ¤í„´íŠ¸ ë©”ì‹œì§€ ì„¤ì • í•¨ìˆ˜ ì¶”ì¶œ
    const setInitialAssistantMessage = () => {
      console.log("ì´ˆê¸° ì–´ì‹œìŠ¤í„´íŠ¸ ë©”ì‹œì§€ ì„¤ì •");
      setConversationId(null);
      setSelectedMode(null);
      setInteractionMode("initial");
      
      // ëŒ€í™”í˜• UIì˜ ì²« ë©”ì‹œì§€ ì„¤ì •
      setMessages([
        {
          role: "assistant",
          content: "ì•ˆë…•í•˜ì„¸ìš”? ë‹¹ì‹ ì˜ ì‹ë¬¼ìƒí™œì„ ë„ìš¸ ì¸ê³µì§€ëŠ¥ ì‹¬ë‹¤ì…ë‹ˆë‹¤. ì‹ë¬¼ ì¶”ì²œë°©ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”",
          timestamp: new Date()
        }
      ]);
    };
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ í•œ ë²ˆë§Œ ì‹¤í–‰ 
    // userë¥¼ ì˜ì¡´ì„±ì— ì¶”ê°€í•˜ì—¬ ë¡œê·¸ì¸ ìƒíƒœê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ë§ˆì§€ë§‰ ëŒ€í™”ë¥¼ ê°€ì ¸ì˜¤ë„ë¡ í•¨
    loadConversationOnMount();
  }, [user, conversationIdParam]);
  
  // ëŒ€í™” IDê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ê°•ì œë¡œ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ queryKeyì— timestamp ì¶”ê°€
  const queryTimestamp = useRef(Date.now()).current;
  
  // URLì—ì„œ conversationId ë³€í™” ê°ì§€ëŠ” ë” ì´ìƒ í•„ìš” ì—†ìŒ (í˜ì´ì§€ê°€ ìƒˆë¡œê³ ì¹¨ ë˜ë¯€ë¡œ)
  // í˜ì´ì§€ ë¡œë“œ ì‹œì—ë§Œ ëŒ€í™” ë°ì´í„°ë¥¼ í•œ ë²ˆ ê°€ì ¸ì˜´
  
  // íŠ¹ì • ëŒ€í™”ë§Œ ê°€ì ¸ì˜¤ê¸° (íŒŒë¼ë¯¸í„°ê°€ ìˆì„ ë•Œë§Œ)
  const { data: conversationData } = useQuery({
    queryKey: conversationIdParam ? 
      [`/api/conversations/${conversationIdParam}`, queryTimestamp] : 
      ["/api/none", queryTimestamp],
    queryFn: async () => {
      if (!user || !conversationIdParam) return null;
      try {
        const url = `/api/conversations/${conversationIdParam}`;
        console.log("Fetching specific conversation from:", url);
        const response = await fetch(url);
        if (!response.ok) {
          console.error("Failed to fetch conversation:", response.status);
          return null;
        }
        const data = await response.json();
        console.log("Fetched conversation data:", data);
        return data;
      } catch (error) {
        console.error("Failed to fetch conversation:", error);
        return null;
      }
    },
    enabled: !!user && !!conversationIdParam, // íŒŒë¼ë¯¸í„°ê°€ ìˆì„ ë•Œë§Œ ì‹¤í–‰
  });

  // ëŒ€í™” ë‚´ìš© ë¡œë“œ - conversationDataê°€ ë³€ê²½ë  ë•Œë§Œ ì‹¤í–‰
  useEffect(() => {
    if (conversationData) {
      setConversationId(conversationData.id);
      
      if (conversationData.messages && conversationData.messages.length > 0) {
        setMessages(conversationData.messages.map((msg: any) => ({
          role: msg.role,
          content: msg.content,
          timestamp: new Date(msg.timestamp),
          recommendations: msg.recommendations
        })));
      }
    }
  }, [conversationData]);
  
  // ìƒˆ ëŒ€í™” ìƒì„± í›„ ìƒíƒœ ë³€ê²½
  useEffect(() => {
    if (isCreatingNewConversation && !conversationId) {
      // AI ì‘ë‹µ ìš”ì²­ ë° ìƒˆ ëŒ€í™” ìƒì„±
      const createNewConversation = async () => {
        try {
          const response = await apiRequest("POST", "/api/conversations");
          if (!response.ok) {
            throw new Error("Failed to create new conversation");
          }
          
          const data = await response.json();
          setConversationId(data.id);
          
          // URL ì—…ë°ì´íŠ¸
          setLocation(`/ai-consultation?conversation=${data.id}`);
          
          // ì¿¼ë¦¬ ë¬´íš¨í™”
          queryClient.invalidateQueries({ queryKey: ["/api/conversations"] });
        } catch (error) {
          console.error("Error creating new conversation:", error);
          toast({
            title: "ìƒˆ ëŒ€í™” ìƒì„± ì‹¤íŒ¨",
            description: "ìƒˆ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
            variant: "destructive",
          });
        } finally {
          setIsCreatingNewConversation(false);
        }
      };
      
      createNewConversation();
    }
  }, [isCreatingNewConversation, conversationId]);

  // í˜„ì¬ íƒ€ì´í•‘ ì¤‘ì¸ ë©”ì‹œì§€ ìƒíƒœ ê´€ë¦¬
  const [typingMessage, setTypingMessage] = useState<ChatMessage | null>(null);
  const [isTyping, setIsTyping] = useState(false);
  
  // ì´ë¯¸ì§€ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬
  const handleImageSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files.length > 0) {
      setSelectedImage(e.target.files[0]);
    }
  };
  
  // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
  const uploadImage = async () => {
    if (!selectedImage) return null;
    
    setIsUploading(true);
    
    try {
      const formData = new FormData();
      formData.append('image', selectedImage);
      
      const response = await fetch('/api/upload-image', {
        method: 'POST',
        body: formData,
      });
      
      if (!response.ok) {
        throw new Error('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
      
      const data = await response.json();
      setUploadedImageUrl(data.imageUrl);
      return data.imageUrl;
    } catch (error) {
      console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
      toast({
        title: 'ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨',
        description: 'ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
        variant: 'destructive',
      });
      return null;
    } finally {
      setIsUploading(false);
    }
  };
  
  // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì·¨ì†Œ
  const handleCancelImage = () => {
    setSelectedImage(null);
    setUploadedImageUrl(null);
  };
  
  // ë©”ì‹œì§€ ì „ì†¡ ì²˜ë¦¬
  const handleSendMessage = async () => {
    if (!input.trim() || isProcessing) return;
    
    // ë©”ì‹œì§€ ì…ë ¥ê°’ ì €ì¥ ë° ì´ˆê¸°í™”
    const messageContent = input.trim();
    setInput("");
    setIsProcessing(true);
    
    // ì´ë¯¸ì§€ê°€ ì„ íƒë˜ì—ˆì§€ë§Œ ì•„ì§ ì—…ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš°, ì—…ë¡œë“œ ì§„í–‰
    let imageUrl = uploadedImageUrl;
    if (selectedImage && !uploadedImageUrl) {
      imageUrl = await uploadImage();
    }
    
    // ë¨¼ì € ì‚¬ìš©ì ë©”ì‹œì§€ ë°”ë¡œ í™”ë©´ì— ì¶”ê°€
    const userMessage: ChatMessage = {
      role: "user",
      content: messageContent,
      timestamp: new Date(),
      recommendations: [],
      imageUrl: imageUrl || undefined
    };
    
    setMessages(prevMessages => [...prevMessages, userMessage]);
    
    try {
      // ì„œë²„ì— ë©”ì‹œì§€ ì „ì†¡
      const response = await apiRequest("POST", "/api/ai/chat", {
        conversationId: conversationId,
        message: messageContent,
        userId: user?.id,
        imageUrl: imageUrl // ì´ë¯¸ì§€ URL ì¶”ê°€
      });
      
      if (!response.ok) {
        throw new Error("Failed to get AI response");
      }
      
      const data = await response.json();
      
      // ëŒ€í™” ID ì—†ì—ˆìœ¼ë©´ ìƒˆë¡œ ì„¤ì •
      if (data.conversationId && !conversationId) {
        setConversationId(data.conversationId);
      }
      
      // ìƒˆ ì‘ë‹µ ë©”ì‹œì§€ ê°ì²´ ìƒì„±
      const assistantMessage: ChatMessage = {
        role: "assistant",
        content: data.content,
        timestamp: new Date(),
        recommendations: data.recommendations || []
      };
      
      // íƒ€ì´í•‘ íš¨ê³¼ë¡œ ë©”ì‹œì§€ í‘œì‹œ ì‹œì‘
      setTypingMessage(assistantMessage);
      setIsTyping(true);
      
      // ì‘ë‹µ ë©”ì‹œì§€ í‘œì‹œ ì™„ë£Œ í›„ ìˆ˜í–‰í•  ì‘ì—…
      setTimeout(() => {
        // ì‹¤ì œ ëŒ€í™” ë‚´ìš© ê°€ì ¸ì˜¤ê¸° (ì¶”ì²œ ì •ë³´ê°€ í¬í•¨ëœ ì „ì²´ ëŒ€í™”)
        const fetchFullConversation = async () => {
          try {
            const convResponse = await fetch(`/api/conversations/${data.conversationId || conversationId}`);
            if (!convResponse.ok) {
              throw new Error("Failed to fetch conversation");
            }
            
            const convData = await convResponse.json();
            
            // ì „ì²´ ëŒ€í™” ë©”ì‹œì§€ë¡œ ìƒíƒœ ì—…ë°ì´íŠ¸
            if (convData && convData.messages) {
              // ëª¨ë“  ë©”ì‹œì§€ì— ëŒ€í•´ timestampë¥¼ Date ê°ì²´ë¡œ ë³€í™˜í•˜ê³ , 
              // ì„œë²„ ì‘ë‹µì— recommendatrions ë°°ì—´ì´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
              const updatedMessages = convData.messages.map((msg: any) => {
                const messageWithTimestamp = {
                  ...msg,
                  timestamp: new Date(msg.timestamp),
                  recommendations: msg.recommendations || []
                };
                
                return messageWithTimestamp;
              });
              
              // ë””ë²„ê¹…: recommendations ë°ì´í„° í™•ì¸
              updatedMessages.forEach((msg: ChatMessage, idx: number) => {
                if (msg.recommendations && msg.recommendations.length > 0) {
                  console.log(`ë©”ì‹œì§€ #${idx}ì— ì¶”ì²œ ë°ì´í„° ${msg.recommendations.length}ê°œ ìˆìŒ:`, 
                    msg.recommendations.map((r: any) => r.name).join(', '));
                }
              });
              
              // plantRecommendationsê°€ ìˆìœ¼ë©´ ë§ˆì§€ë§‰ ì–´ì‹œìŠ¤í„´íŠ¸ ë©”ì‹œì§€ì— ì ìš©
              if (convData.plantRecommendations && convData.plantRecommendations.length > 0) {
                console.log("ì„œë²„ì—ì„œ ë°›ì€ ì‹ë¬¼ ì¶”ì²œ ë°ì´í„°:", convData.plantRecommendations.length, "ê°œ");
                
                // ë§ˆì§€ë§‰ ì–´ì‹œìŠ¤í„´íŠ¸ ë©”ì‹œì§€ ì°¾ê¸°
                const lastAssistantIndex = updatedMessages
                  .map((msg: ChatMessage, idx: number) => msg.role === 'assistant' ? idx : -1)
                  .filter((idx: number) => idx !== -1)
                  .pop();
                
                if (lastAssistantIndex !== undefined) {
                  console.log(`ë§ˆì§€ë§‰ ì–´ì‹œìŠ¤í„´íŠ¸ ë©”ì‹œì§€(${lastAssistantIndex})ì— ì¶”ì²œ ë°ì´í„° ì¶”ê°€`);
                  updatedMessages[lastAssistantIndex].recommendations = convData.plantRecommendations;
                }
              }
              
              setMessages(updatedMessages);
              
              // ì½˜ì†”ì— ëŒ€í™” ë‚´ìš© ë¡œê¹… (ë””ë²„ê¹…ìš©)
              console.log("ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ì „ì²´ ëŒ€í™”:", convData);
              console.log("í”ŒëœíŠ¸ ì¶”ì²œ:", convData.plantRecommendations);
            }
          } catch (error) {
            console.error("Error fetching conversation:", error);
          } finally {
            // íƒ€ì´í•‘ ìƒíƒœ ì¢…ë£Œ
            setTypingMessage(null);
            setIsTyping(false);
            setIsProcessing(false);
          }
        };
        
        fetchFullConversation();
      }, 1000); // íƒ€ì´í•‘ì´ ëë‚œ í›„ 1ì´ˆ í›„ì— ëŒ€í™” ë‚´ìš© ì—…ë°ì´íŠ¸
      
    } catch (error) {
      console.error("Error sending message:", error);
      toast({
        title: "ì˜¤ë¥˜ ë°œìƒ",
        description: "ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
        variant: "destructive",
      });
      setIsProcessing(false);
      setIsTyping(false);
      setTypingMessage(null);
    }
  };

  // ì‹ë¬¼ ì„ íƒ ì²˜ë¦¬
  const handleSelectPlant = (plantName: string) => {
    setSelectedPlant(plantName);
    
    // ì¤‘ìš”: ìƒí˜¸ì‘ìš© ëª¨ë“œë¥¼ ìœ„ì¹˜ ì„ íƒ ëª¨ë“œë¡œ ë³€ê²½
    setInteractionMode("location-selection");
    
    // ì„ íƒ ë©”ì‹œì§€ ì¶”ê°€
    setMessages(prev => [
      ...prev,
      {
        role: "user",
        content: `"${plantName}"ì„(ë¥¼) ì„ íƒí–ˆìŠµë‹ˆë‹¤.`,
        timestamp: new Date()
      }
    ]);
    
    // ì§€ì—­ ì„ íƒ ì•ˆë‚´ ë° ì§€ë„ ì¶”ê°€
    if (!isSelectingRegion) {
      setIsSelectingRegion(true);
      
      // í†µí•©ëœ ë©”ì‹œì§€ í•œ ë²ˆë§Œ ì¶”ê°€
      setTimeout(() => {
        setMessages(prev => [
          ...prev,
          {
            role: "assistant",
            content: "ë°°ì†¡ì´ë‚˜ ì„ ë¬¼ì„ ìœ„í•œ ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”. ì§€ë„ì—ì„œ ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ê²€ìƒ‰í•´ì„œ ì°¾ìœ¼ì„¸ìš”. í•´ë‹¹ ì§€ì—­ì˜ íŒë§¤ìë“¤ì—ê²Œ ì…ì°° ìš”ì²­ì´ ì „ì†¡ë©ë‹ˆë‹¤.",
            timestamp: new Date()
          }
        ]);
      }, 100);
    }
  };
  
  // ìƒì„¸ì •ë³´ ë³´ê¸° ì²˜ë¦¬ (ì‹ë¬¼ ì„ íƒê³¼ ë¶„ë¦¬)
  const handleViewDetails = (e: React.MouseEvent, plantAccordion: string) => {
    // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
    e.stopPropagation();
  };
  
  // ì‹ë¬¼ ì •ë³´ ëª¨ë‹¬ ì—´ê¸°
  const handleShowPlantInfo = (plant: PlantRecommendation) => {
    setCurrentPlantInfo(plant);
    setInfoDialogOpen(true);
  };
  
  // íŒë§¤ì ì…ì°° ì„ íƒ ì²˜ë¦¬ í•¨ìˆ˜
  const handleSelectBid = (message: ChatMessage) => {
    if (!message.product || !message.product.bidPrice) {
      toast({
        title: "ì…ì°° ì„ íƒ ë¶ˆê°€",
        description: "ì‹¤ì œ ì…ì°°ê°€ê°€ ì œì‹œëœ ìƒí’ˆë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
        variant: "destructive",
      });
      return;
    }
    
    // ìƒí’ˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const product = message.product;
    
    // ê²°ì œ í˜ì´ì§€ë¡œ ì´ë™
    setLocation(`/payment?vendor=${message.vendorId}&product=${product.id}&price=${product.bidPrice}&name=${encodeURIComponent(product.name)}&store=${encodeURIComponent(message.storeName || '')}`);
  };

  // ì§€ì—­ ì„ íƒ ë° ì…ì°° ìš”ì²­ ì²˜ë¦¬
  const handleRequestBids = async () => {
    if (!selectedPlant || !region.trim() || !user) {
      toast({
        title: "ì •ë³´ ë¶€ì¡±",
        description: "ì‹ë¬¼ê³¼ ì§€ì—­ ì •ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.",
        variant: "destructive",
      });
      return;
    }
    
    setIsProcessing(true);
    
    try {
      // ìœ„ì¹˜ ê¸°ë°˜ ì •ë³´ê°€ ìˆìœ¼ë©´ í¬í•¨
      const requestData: any = {
        userId: user.id,
        plantName: selectedPlant,
        region: region,
        storeName: region, // storeNameì„ regionìœ¼ë¡œ ì„¤ì • (ì„œë²„ì—ì„œ í•„ìˆ˜ë¡œ ìš”êµ¬)
        conversationId: conversationId
      };
      
      // ìœ„ì¹˜ ì •ë³´ê°€ ìˆìœ¼ë©´ ì¶”ê°€
      if (selectedLocation) {
        requestData.lat = selectedLocation.lat;
        requestData.lng = selectedLocation.lng;
        requestData.radius = selectedLocation.radius;
      }
      
      const response = await apiRequest("POST", "/api/bids/request", requestData);
      
      if (!response.ok) {
        throw new Error("Failed to request bids");
      }
      
      const data = await response.json();
      
      // ì…ì°° ìš”ì²­ ì™„ë£Œ ë©”ì‹œì§€
      const successMessage = selectedLocation 
        ? `ì„ íƒí•œ ìœ„ì¹˜(${region}) ë°˜ê²½ ${selectedLocation.radius}km ì´ë‚´ì˜ íŒë§¤ìë“¤ì—ê²Œ ì…ì°° ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. 2ì‹œê°„ ë‚´ì— ì…ì°° ê²°ê³¼ë¥¼ ì•Œë ¤ë“œë¦¬ê² ìŠµë‹ˆë‹¤.`
        : `${region} ì§€ì—­ì˜ íŒë§¤ìë“¤ì—ê²Œ ì…ì°° ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. 2ì‹œê°„ ë‚´ì— ì…ì°° ê²°ê³¼ë¥¼ ì•Œë ¤ë“œë¦¬ê² ìŠµë‹ˆë‹¤.`;
        
      // 1. ë¨¼ì € ì…ì°° ì™„ë£Œ ë©”ì‹œì§€ ì¶”ê°€ 
      setMessages(prev => [
        ...prev,
        {
          role: "assistant",
          content: successMessage,
          timestamp: new Date()
        }
      ]);
      
      // ìë™ ìŠ¤í¬ë¡¤
      setTimeout(() => {
        if (messagesEndRef.current) {
          messagesEndRef.current.scrollIntoView({ behavior: "smooth" });
        }
        // modeë„ ì—¬ê¸°ì„œ ë³€ê²½ - ì§€ë„ ì»¨í…Œì´ë„ˆ ì´í›„ì— ë©”ì‹œì§€ê°€ í‘œì‹œë˜ë„ë¡
        setInteractionMode("bid-requested");
      }, 300);
      
      toast({
        title: "ì…ì°° ìš”ì²­ ì™„ë£Œ",
        description: "ì§€ì—­ íŒë§¤ìë“¤ì—ê²Œ ì…ì°° ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤.",
      });
      
      // ì…ì°° ìš”ì²­ í›„ì—ë„ UI ìœ ì§€ (ModeëŠ” ì´ë¯¸ ìœ„ì—ì„œ ë³€ê²½ë¨)
    } catch (error) {
      console.error("Error requesting bids:", error);
      toast({
        title: "ì˜¤ë¥˜ ë°œìƒ",
        description: "ì…ì°° ìš”ì²­ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
        variant: "destructive",
      });
    } finally {
      setIsProcessing(false);
    }
  };

  // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
  if (!user) {
    return <Redirect to="/auth" />;
  }

  return (
    <DashboardLayout>
      <div className="container max-w-4xl mx-auto px-4 py-6">
        <div className="flex flex-col gap-2 mb-6">
          <div className="flex items-center justify-between">
            <h1 className="text-3xl font-bold">ì¸ê³µì§€ëŠ¥ ì‹ë¬¼ ìƒë‹´</h1>
            <div className="flex items-center gap-2">
              <Button
                onClick={() => setLocation("/recommendation")}
                variant="secondary"
                className="gap-1"
              >
                <Leaf className="h-4 w-4 mr-1" />
                ì¶”ì²œ ë§ˆë²•ì‚¬
              </Button>
              <ConversationDrawer />
              <Button
                onClick={() => {
                  // ëª¨ë“  ìƒíƒœ ì´ˆê¸°í™”
                  setSelectedMode(null);
                  setConversationId(null);
                  setSelectedPlant(null);
                  setRegion("");
                  setInteractionMode("initial");
                  setSearchResults([]);
                  setSearchTerm("");
                  setIsSearching(false);
                  setIsSelectingRegion(false);
                  setSelectedLocation(null);
                  // ì´ˆê¸° ë©”ì‹œì§€ ì„¤ì • - ì„ íƒ í™”ë©´ í‘œì‹œ
                  const initialMessage: ChatMessage = {
                    role: "assistant", 
                    content: "ì•ˆë…•í•˜ì„¸ìš”? ë‹¹ì‹ ì˜ ì‹ë¬¼ìƒí™œì„ ë„ìš¸ ì¸ê³µì§€ëŠ¥ ì‹¬ë‹¤ì…ë‹ˆë‹¤. ì‹ë¬¼ ì¶”ì²œë°©ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.", 
                    timestamp: new Date()
                  };
                  setMessages([initialMessage]);
                  
                  // URL ì´ˆê¸°í™”
                  setLocation("/ai-consultation");
                  
                  // ì´ˆê¸°í™” ë¡œê·¸
                  console.log("ìƒˆ ëŒ€í™” ë²„íŠ¼ í´ë¦­: ëª¨ë“  ìƒíƒœ ì´ˆê¸°í™”ë˜ê³  ì´ˆê¸° ë©”ì‹œì§€ ì„¤ì •ë¨");
                }}
                disabled={isCreatingNewConversation}
                variant="outline"
                className="gap-1"
              >
                {isCreatingNewConversation ? (
                  <Loader2 className="h-4 w-4 animate-spin" />
                ) : (
                  <Plus className="h-4 w-4" />
                )}
                ìƒˆ ëŒ€í™”
              </Button>
            </div>
          </div>
          
          {conversationId && (
            <div className="flex items-center text-sm text-muted-foreground">
              <MessageSquareText className="h-4 w-4 mr-1.5" />
              <span>ëŒ€í™” #{conversationId}</span>
              {messages.length > 0 && (
                <>
                  <span className="mx-2">â€¢</span>
                  <span>{messages.length}ê°œ ë©”ì‹œì§€</span>
                </>
              )}
            </div>
          )}
        </div>
        
        {/* ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ */}
        <div 
          className="bg-background border rounded-lg p-4 mb-4 h-[calc(100vh-240px)] overflow-y-auto" 
          id="chat-container"
          ref={chatContainerRef}>
          
          {/* ëŒ€í™” ë©”ì‹œì§€ ì˜ì—­ì´ ë¹„ì–´ìˆê±°ë‚˜, ìƒˆ ëŒ€í™”ì¸ ê²½ìš° ì´ˆê¸° ëŒ€í™”í˜• UI í‘œì‹œ */}
          {messages.length === 1 && messages[0].content.includes("ì•ˆë…•í•˜ì„¸ìš”? ë‹¹ì‹ ì˜ ì‹ë¬¼ìƒí™œì„ ë„ìš¸ ì¸ê³µì§€ëŠ¥ ì‹¬ë‹¤ì…ë‹ˆë‹¤") && (
            <>
              {/* ì´ˆê¸° ì•ˆë‚´ ë©”ì‹œì§€ */}
              <div className="flex justify-start mb-4">
                <div className="flex items-start max-w-[80%]">
                  <Avatar className="h-8 w-8 mr-2">
                    <AvatarImage src="" />
                    <AvatarFallback>AI</AvatarFallback>
                  </Avatar>
                  
                  <div className="flex flex-col gap-1">
                    <Card className="p-3">
                      <CardContent className="p-0">
                        <p>{messages[0].content}</p>
                        
                        <div className="mt-4 flex flex-col gap-3">
                          <Button
                            onClick={async () => {
                              setSelectedMode("ai");
                              setInteractionMode("ai-recommendation");
                              
                              // ëŒ€í™” ì‹œì‘ ì²˜ë¦¬ ì‹œì‘
                              setIsProcessing(true);
                              // setIsCreatingNewConversation(true) ì œê±° - ì´ ë¶€ë¶„ì´ ì¤‘ë³µ ëŒ€í™” ìƒì„±ì˜ ì›ì¸
                              
                              try {
                                console.log("AI ì¶”ì²œ ë²„íŠ¼ í´ë¦­: ëŒ€í™” ì‹œì‘ë¨");
                                // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒˆ ëŒ€í™” ìƒì„± ìš”ì²­
                                const data = await startNewAIConversation(user?.id!);
                                
                                // ì„œë²„ì—ì„œ ë°›ì€ ì‘ë‹µìœ¼ë¡œ ì „ì²´ ëŒ€í™” êµ¬ì„±
                                if (data.conversationId) {
                                  console.log("ëŒ€í™” ID ì„¤ì •:", data.conversationId);
                                  // ëŒ€í™” ID ì„¤ì •
                                  setConversationId(data.conversationId);
                                  
                                  // ëŒ€í™” ë‚´ìš© ì¶”ì¶œ
                                  if (data.messages && data.messages.length > 0) {
                                    console.log("ìƒˆ ë©”ì‹œì§€ ì ìš©:", data.messages.length, "ê°œ");
                                    // ì„œë²„ì—ì„œ ë°›ì€ ë©”ì‹œì§€ë¡œ êµì²´ (timestamps ë³€í™˜ í¬í•¨)
                                    const formattedMessages = data.messages.map((msg: any) => ({
                                      ...msg, 
                                      timestamp: new Date(msg.timestamp)
                                    }));
                                    
                                    console.log("ë³€í™˜ëœ ë©”ì‹œì§€:", formattedMessages);
                                    setMessages(formattedMessages);
                                    
                                    // URL ì—…ë°ì´íŠ¸ (ìƒˆ ëŒ€í™” ID ë°˜ì˜)
                                    console.log("URL ì—…ë°ì´íŠ¸");
                                    setLocation(`/ai-consultation?conversation=${data.conversationId}`);
                                  } else {
                                    console.log("ì„œë²„ì—ì„œ ë°›ì€ ë©”ì‹œì§€ê°€ ì—†ìŒ");
                                  }
                                } else {
                                  console.log("ì„œë²„ì—ì„œ ëŒ€í™” IDë¥¼ ë°›ì§€ ëª»í•¨");
                                }
                              } catch (error) {
                                console.error("Error starting conversation:", error);
                                toast({
                                  title: "ì˜¤ë¥˜ ë°œìƒ",
                                  description: "ëŒ€í™” ì‹œì‘ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
                                  variant: "destructive",
                                });
                              } finally {
                                setIsProcessing(false);
                                setIsCreatingNewConversation(false);
                              }
                            }}
                            variant="outline"
                            className="flex items-center justify-start h-auto py-2 px-3 gap-2 bg-muted hover:bg-muted/80"
                          >
                            <Bot className="h-5 w-5 text-primary" />
                            <div className="flex flex-col items-start">
                              <span className="font-medium">AI ì¶”ì²œ</span>
                              <span className="text-xs text-muted-foreground">AIê°€ ëª‡ ê°€ì§€ ì§ˆë¬¸ì„ í†µí•´ ë‹¹ì‹ ì—ê²Œ ë§ëŠ” ì‹ë¬¼ì„ ì¶”ì²œí•´ ë“œë¦½ë‹ˆë‹¤</span>
                            </div>
                          </Button>
                          
                          <Button
                            onClick={() => {
                              setSelectedMode("manual");
                              setInteractionMode("manual-selection");
                              
                              // ì‚¬ìš©ì ë©”ì‹œì§€ì™€ ì‘ë‹µ ìƒì„±
                              const userMessage: ChatMessage = {
                                role: "user",
                                content: "ì§ì ‘ ì„ íƒìœ¼ë¡œ ì§„í–‰í• ê²Œìš”.",
                                timestamp: new Date()
                              };
                              
                              const assistantMessage: ChatMessage = {
                                role: "assistant",
                                content: "ì‹ë¬¼ì„ ì§ì ‘ ê²€ìƒ‰í•˜ì—¬ ì„ íƒí•˜ëŠ” ëª¨ë“œì…ë‹ˆë‹¤. ì•„ë˜ì—ì„œ ì›í•˜ëŠ” ì‹ë¬¼ì„ ê²€ìƒ‰í•´ë³´ì„¸ìš”.",
                                timestamp: new Date()
                              };
                              
                              // ë©”ì‹œì§€ ì„¤ì •
                              setMessages([userMessage, assistantMessage]);
                              
                              console.log("ì§ì ‘ ì„ íƒ ë²„íŠ¼ í´ë¦­: ëŒ€í™” ìƒíƒœ ì—…ë°ì´íŠ¸ë¨");
                            }}
                            variant="outline"
                            className="flex items-center justify-start h-auto py-2 px-3 gap-2 bg-muted hover:bg-muted/80"
                          >
                            <Search className="h-5 w-5 text-primary" />
                            <div className="flex flex-col items-start">
                              <span className="font-medium">ì§ì ‘ ì„ íƒ</span>
                              <span className="text-xs text-muted-foreground">ì›í•˜ëŠ” ì‹ë¬¼ì„ ì§ì ‘ ê²€ìƒ‰í•˜ê³  ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</span>
                            </div>
                          </Button>
                        </div>
                      </CardContent>
                    </Card>
                    
                    {/* íƒ€ì„ìŠ¤íƒ¬í”„ */}
                    <div className="text-xs text-muted-foreground text-left">
                      {formatTime(new Date())}
                    </div>
                  </div>
                </div>
              </div>
            </>
          )}
          
          {/* ì±„íŒ… ë©”ì‹œì§€ í‘œì‹œ - ëŒ€í™”ê°€ ì‹œì‘ëœ ê²½ìš° í‘œì‹œ */}
          {!(messages.length === 1 && messages[0].content.includes("ì•ˆë…•í•˜ì„¸ìš”? ë‹¹ì‹ ì˜ ì‹ë¬¼ìƒí™œì„ ë„ìš¸ ì¸ê³µì§€ëŠ¥ ì‹¬ë‹¤ì…ë‹ˆë‹¤")) && messages.map((message, index) => (
            <div
              key={index}
              className={cn(
                "flex mb-4",
                message.role === "user" ? "justify-end" : "justify-start"
              )}
            >
              <div
                className={cn(
                  "flex max-w-[80%]",
                  message.role === "user" ? "flex-row-reverse" : "flex-row"
                )}
              >
                {/* ì•„ë°”íƒ€ */}
                <div className="flex-shrink-0 mx-2">
                  <Avatar>
                    <AvatarFallback>
                      {message.role === "user" 
                        ? <User size={18} /> 
                        : message.role === "vendor" 
                          ? <Store size={18} /> 
                          : <Bot size={18} />}
                    </AvatarFallback>
                    {message.role === "assistant" && (
                      <AvatarImage src="/assets/plant-bot-avatar.png" />
                    )}
                  </Avatar>
                </div>
                
                {/* ë©”ì‹œì§€ ë‚´ìš© */}
                <div>
                  <Card
                    className={cn(
                      "mb-1",
                      message.role === "user"
                        ? "bg-primary text-primary-foreground"
                        : message.role === "vendor"
                          ? "bg-white border border-gray-200"
                          : "bg-muted"
                    )}
                  >
                    <CardContent className="p-3">
                      {/* ë©”ì‹œì§€ ë‚´ìš© í‘œì‹œ */}
                      {/* ì°¸ê³  ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì´ë¯¸ì§€ ë¨¼ì € í‘œì‹œ */}
                      {message.imageUrl && (
                        <div className="mb-3">
                          <div className="w-full max-w-[240px] h-auto rounded-md overflow-hidden">
                            <img 
                              src={message.imageUrl} 
                              alt="ì°¸ê³  ì´ë¯¸ì§€" 
                              className="w-full h-auto object-cover"
                              onError={(e) => {
                                console.log('ì°¸ê³  ì´ë¯¸ì§€ ë¡œë“œ ì˜¤ë¥˜:', message.imageUrl);
                                e.currentTarget.src = '/assets/plants/default-plant.png';
                              }}
                            />
                          </div>
                          <div className="text-xs text-muted-foreground mt-1">
                            ì°¸ê³  ì´ë¯¸ì§€
                          </div>
                        </div>
                      )}
                      
                      <div className="whitespace-pre-wrap">
                        {/* JSON í¬ë§·ì¸ ê²½ìš° í¬ë§·íŒ…í•˜ì—¬ í‘œì‹œ */}
                        {message.content && message.content.includes('"recommendations":') ? (
                          <>
                            {/* JSONì´ í¬í•¨ëœ ë©”ì‹œì§€ëŠ” recommendations ë¶€ë¶„ì„ ì œì™¸í•˜ê³  í‘œì‹œ */}
                            {message.content.split('"recommendations":')[0]
                              .replace(/{|"content":|"|}|,$/g, '')
                              .trim()}
                          </>
                        ) : message.role !== "vendor" || !message.product ? (
                          message.role === 'assistant' && isTyping && typingMessage && 
                          typingMessage.timestamp.getTime() === message.timestamp.getTime() ? (
                            <TypingEffect 
                              text={message.content} 
                              speed={20}
                            />
                          ) : (
                            // ì¤„ë°”ê¿ˆ ì½”ë“œë¥¼ ì‹¤ì œ ì¤„ë°”ê¿ˆìœ¼ë¡œ ë³€í™˜í•˜ì—¬ í‘œì‹œ
                            message.content.replace(/\\n/g, '\n')
                          )
                        ) : null}
                        
                        {/* íŒë§¤ì ë©”ì‹œì§€ì—ì„œ ìƒí’ˆ ì •ë³´ í‘œì‹œ - ìƒˆ ë””ìì¸ */}
                        {message.role === "vendor" && message.product && (
                          <div className="mt-3">
                            <div className="flex flex-col items-start">
                              {/* íŒë§¤ì ì •ë³´ í—¤ë” */}
                              {message.vendorName && (
                                <div className="mb-2 flex items-center">
                                  <div 
                                    className="w-4 h-4 rounded-full mr-1.5" 
                                    style={message.vendorColor ? {backgroundColor: message.vendorColor} : {backgroundColor: '#6E56CF'}}
                                  ></div>
                                  <span className="font-medium">{message.vendorName}</span>
                                  {message.storeName && (
                                    <span className="text-sm text-muted-foreground ml-1">({message.storeName})</span>
                                  )}
                                </div>
                              )}
                              
                              {/* ìƒí’ˆ ì¹´ë“œ - ìƒˆ ë””ìì¸ */}
                              <div className="bg-background rounded-lg overflow-hidden border w-full mb-3 shadow-sm hover:shadow-md transition-all duration-200">
                                <div className="flex flex-col md:flex-row">
                                  {/* ì´ë¯¸ì§€ ì˜ì—­ */}
                                  {message.product.imageUrl && (
                                    <div className="md:w-1/3 overflow-hidden bg-muted">
                                      <img 
                                        src={message.product.imageUrl} 
                                        alt={message.product.name}
                                        className="w-full h-full object-cover aspect-square md:aspect-auto"
                                        onError={(e) => {
                                          console.log('ìƒí’ˆ ì´ë¯¸ì§€ ë¡œë“œ ì˜¤ë¥˜:', message.product.imageUrl);
                                          e.currentTarget.src = '/assets/plants/default-plant.png';
                                        }}
                                      />
                                    </div>
                                  )}
                                  
                                  {/* ìƒí’ˆ ì •ë³´ ì˜ì—­ */}
                                  <div className="p-4 flex flex-col justify-between md:w-2/3">
                                    <div>
                                      {/* ìƒí’ˆëª…ê³¼ ê¸°ë³¸ê°€ */}
                                      <div className="flex justify-between items-start mb-2">
                                        <h3 className="text-lg font-semibold">{message.product.name}</h3>
                                        {message.product.basePrice && (
                                          <span className="line-through text-muted-foreground text-sm">
                                            {message.product.basePrice.toLocaleString()}ì›
                                          </span>
                                        )}
                                      </div>
                                      
                                      {/* ì…ì°°ê°€/íŒë§¤ê°€ í‘œì‹œ */}
                                      {message.product.bidPrice ? (
                                        <div className="font-bold text-xl text-primary mb-3">
                                          {message.product.bidPrice.toLocaleString()}ì›
                                        </div>
                                      ) : message.product.price ? (
                                        <div className="font-bold text-xl mb-3">
                                          {message.product.price.toLocaleString()}ì›
                                        </div>
                                      ) : null}
                                      
                                      {/* ìƒí’ˆ ì„¤ëª… */}
                                      {message.product.description && (
                                        <p className="text-sm text-muted-foreground mb-3">
                                          {message.product.description}
                                        </p>
                                      )}
                                      
                                      {/* íŒë§¤ì ìƒí˜¸ í‘œì‹œ (ì‘ê²Œ) */}
                                      <div className="flex items-center mb-3">
                                        <div 
                                          className="w-3 h-3 rounded-full mr-1.5" 
                                          style={message.vendorColor ? {backgroundColor: message.vendorColor} : {backgroundColor: '#6E56CF'}}
                                        ></div>
                                        <span className="text-xs text-muted-foreground">
                                          {message.storeName || message.vendorName}
                                        </span>
                                      </div>
                                    </div>
                                    
                                    {/* êµ¬ë§¤ ë²„íŠ¼ */}
                                    <Button 
                                      className={message.product.bidPrice ? "bg-primary hover:bg-primary/90" : ""}
                                      variant={message.product.bidPrice ? "default" : "outline"}
                                      onClick={() => handleSelectBid(message)}
                                      disabled={!message.product.bidPrice}
                                    >
                                      {message.product.bidPrice 
                                        ? "ì´ ìƒí’ˆ êµ¬ë§¤í•˜ê¸°" 
                                        : "ì…ì°°ê°€ ì—†ìŒ (êµ¬ë§¤ ë¶ˆê°€)"}
                                    </Button>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        )}
                        
                        {/* ì¶”ì²œ ì‹ë¬¼ì´ ìˆìœ¼ë©´ ë³„ë„ë¡œ í‘œì‹œ */}
                        {message.recommendations && message.recommendations.length > 0 && (
                          <div className="mt-3 pt-3 border-t">
                            <div className="font-medium mb-2">ğŸŒ¿ ì¶”ì²œ ì‹ë¬¼:</div>
                            <div className="space-y-4">
                              {message.recommendations.map((plant: PlantRecommendation, idx: number) => (
                                <div key={idx} className="bg-background/50 rounded-md p-3 shadow-sm">
                                  <div className="flex justify-between items-start">
                                    <h3 className="font-medium text-primary">{plant.name || `ì¶”ì²œ ì‹ë¬¼ ${idx+1}`}</h3>
                                    <Badge variant="outline" className="ml-2">
                                      {plant.priceRange || "ê°€ê²© ì •ë³´ ì—†ìŒ"}
                                    </Badge>
                                  </div>
                                  <p className="text-sm mt-1 text-muted-foreground">{plant.description || "ì„¤ëª… ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."}</p>
                                  {plant.careInstructions && (
                                    <div className="mt-2">
                                      <h4 className="text-xs font-medium uppercase tracking-wide text-muted-foreground">ê´€ë¦¬ ë°©ë²•</h4>
                                      <p className="text-sm">{plant.careInstructions}</p>
                                    </div>
                                  )}
                                  
                                  <div className="flex justify-between mt-3">
                                    <Button 
                                      size="sm" 
                                      variant="outline"
                                      onClick={() => handleShowPlantInfo(plant)}
                                      className="text-xs"
                                    >
                                      ì‹ë¬¼ ìƒì„¸ì •ë³´
                                    </Button>
                                    <Button 
                                      size="sm"
                                      onClick={() => {
                                        handleSelectPlant(plant.name);
                                        setInteractionMode("location-selection");
                                      }}
                                      className="text-xs"
                                    >
                                      ì´ ì‹ë¬¼ ì„ íƒí•˜ê¸°
                                    </Button>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                      
                      {/* ì…ì°° ìš”ì²­ ì™„ë£Œ í›„ ë²„íŠ¼ì€ ì‚¬ìš©ì ìš”ì²­ì— ë”°ë¼ ì‚­ì œí•¨ */}
                      
                      {/* ì´ˆê¸° ì„ íƒ ì˜µì…˜ - ì²« ë©”ì‹œì§€ì—ë§Œ í‘œì‹œ */}
                      {message.role === "assistant" && 
                       message.content.includes("ì‹ë¬¼ ì¶”ì²œì„ ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ì§„í–‰í• ê¹Œìš”?") && 
                       interactionMode === "initial" && (
                        <div className="mt-4 space-y-3">
                          <h3 className="font-medium">ì¶”ì²œ ë°©ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”:</h3>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <Button 
                              variant="outline"
                              className="flex flex-col items-center gap-2 p-4 h-auto"
                              onClick={async () => {
                                // ëŒ€í™” ìƒíƒœì™€ ì²˜ë¦¬ ìƒíƒœ ì„¤ì •
                                setInteractionMode("ai-recommendation");
                                setIsProcessing(true);
                                
                                console.log("ê¸°ì¡´ UIì˜ AI ì¶”ì²œ ë²„íŠ¼ í´ë¦­: ìƒˆ ëŒ€í™” ìƒì„±");
                                
                                try {
                                  // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ìƒˆ ëŒ€í™” ìƒì„± ìš”ì²­
                                  const data = await startNewAIConversation(user?.id!);
                                  
                                  // ì´ì œ conversationIdë¥¼ ì„¤ì •í•˜ê³  í•´ë‹¹ URLë¡œ ì´ë™
                                  if (data.conversationId) {
                                    setConversationId(data.conversationId);
                                    
                                    // ëŒ€í™” ë‚´ìš© ì¶”ì¶œ
                                    if (data.messages && data.messages.length > 0) {
                                      // ì„œë²„ì—ì„œ ë°›ì€ ë©”ì‹œì§€ë¡œ êµì²´ (timestamps ë³€í™˜ í¬í•¨)
                                      setMessages(data.messages.map((msg: any) => ({
                                        ...msg,
                                        timestamp: new Date(msg.timestamp)
                                      })));
                                      
                                      // URL ì—…ë°ì´íŠ¸ (ìƒˆ ëŒ€í™” ID ë°˜ì˜)
                                      setLocation(`/ai-consultation?conversation=${data.conversationId}`);
                                    }
                                  }
                                } catch (error) {
                                  console.error("Error starting conversation:", error);
                                  toast({
                                    title: "ì˜¤ë¥˜ ë°œìƒ",
                                    description: "ëŒ€í™” ì‹œì‘ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.",
                                    variant: "destructive",
                                  });
                                } finally {
                                  setIsProcessing(false);
                                }
                              }}
                            >
                              <Bot className="h-8 w-8 text-primary mb-1" />
                              <span className="font-medium">AI ì¶”ì²œ</span>
                              <span className="text-xs text-center text-muted-foreground">
                                ì§ˆë¬¸ì— ë‹µí•˜ê³  AIê°€ ë§ì¶¤ ì‹ë¬¼ì„ ì¶”ì²œë°›ê¸°
                              </span>
                            </Button>
                            
                            <Button 
                              variant="outline"
                              className="flex flex-col items-center gap-2 p-4 h-auto"
                              onClick={async () => {
                                setInteractionMode("manual-selection");
                                
                                // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
                                const userMessage: ChatMessage = {
                                  role: "user",
                                  content: "ì§ì ‘ ì„ íƒìœ¼ë¡œ ì§„í–‰í• ê²Œìš”.",
                                  timestamp: new Date()
                                };
                                
                                // ì–´ì‹œìŠ¤í„´íŠ¸ ë©”ì‹œì§€ ì¶”ê°€
                                const assistantMessage: ChatMessage = {
                                  role: "assistant",
                                  content: "ì•Œê² ìŠµë‹ˆë‹¤. ì‹ë¬¼ ì´ë¦„ì„ ê²€ìƒ‰í•˜ì—¬ ì„ íƒí•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                                  timestamp: new Date()
                                };
                                
                                setMessages(prev => [...prev, userMessage, assistantMessage]);
                              }}
                            >
                              <Search className="h-8 w-8 text-primary mb-1" />
                              <span className="font-medium">ì§ì ‘ ì„ íƒ</span>
                              <span className="text-xs text-center text-muted-foreground">
                                ì§ì ‘ ì‹ë¬¼ì„ ê²€ìƒ‰í•˜ê³  ì„ íƒí•˜ê¸°
                              </span>
                            </Button>
                          </div>
                        </div>
                      )}
                      
                      {/* ì‹ë¬¼ ê²€ìƒ‰ ì¸í„°í˜ì´ìŠ¤ - ì§ì ‘ ì„ íƒ ëª¨ë“œì¼ ë•Œ í‘œì‹œ */}
                      {message.role === "assistant" && 
                       (message.content.includes("ì‹ë¬¼ ì´ë¦„ì„ ê²€ìƒ‰í•˜ì—¬ ì„ íƒí•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤") || 
                        message.content.includes("ì§ì ‘ ê²€ìƒ‰í•˜ì—¬ ì„ íƒí•˜ëŠ” ëª¨ë“œ")) && 
                       interactionMode === "manual-selection" && (
                        <div className="mt-4 border rounded-md p-3 bg-background">
                          <div className="space-y-4">
                            <div className="flex gap-2">
                              <div className="relative flex-1">
                                <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                                <Input
                                  placeholder="ì‹ë¬¼ ì´ë¦„ ê²€ìƒ‰..."
                                  value={searchTerm}
                                  onChange={(e) => setSearchTerm(e.target.value)}
                                  className="pl-9"
                                />
                                {searchTerm && (
                                  <Button
                                    variant="ghost"
                                    size="icon"
                                    className="absolute right-1 top-1/2 -translate-y-1/2 h-7 w-7"
                                    onClick={() => setSearchTerm("")}
                                  >
                                    <X className="h-4 w-4" />
                                  </Button>
                                )}
                              </div>
                              <Button 
                                onClick={async () => {
                                  setIsSearching(true);
                                  try {
                                    const url = searchTerm.trim() 
                                      ? `/api/plants/search?q=${encodeURIComponent(searchTerm)}` 
                                      : `/api/plants`;
                                    
                                    const response = await fetch(url);
                                    if (!response.ok) {
                                      throw new Error('ì‹ë¬¼ ê²€ìƒ‰ ì‹¤íŒ¨');
                                    }
                                    
                                    const data = await response.json();
                                    setSearchResults(data);
                                  } catch (error) {
                                    console.error('Error searching plants:', error);
                                    toast({
                                      title: "ê²€ìƒ‰ ì˜¤ë¥˜",
                                      description: "ì‹ë¬¼ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
                                      variant: "destructive",
                                    });
                                  } finally {
                                    setIsSearching(false);
                                  }
                                }}
                                disabled={isSearching}
                              >
                                {isSearching ? <Loader2 className="h-4 w-4 animate-spin" /> : "ê²€ìƒ‰"}
                              </Button>
                            </div>
                            
                            {isSearching ? (
                              <div className="grid grid-cols-2 gap-3">
                                {Array(4).fill(0).map((_, i) => (
                                  <div key={i} className="space-y-2">
                                    <Skeleton className="h-28 w-full rounded-md" />
                                    <Skeleton className="h-4 w-3/4" />
                                  </div>
                                ))}
                              </div>
                            ) : searchResults.length > 0 ? (
                              <div className="grid grid-cols-2 gap-3">
                                {searchResults.map((plant: any) => (
                                  <div
                                    key={plant.id}
                                    className="border rounded-md overflow-hidden cursor-pointer hover:border-primary transition-colors"
                                    onClick={() => {
                                      handleSelectPlant(plant.name);
                                      setInteractionMode("location-selection");
                                    }}
                                  >
                                    <div 
                                      className="h-28 bg-center bg-cover"
                                      style={{ backgroundImage: `url(${plant.imageUrl || '/assets/plants/default-plant.png'})` }}
                                    />
                                    <div className="p-2">
                                      <h3 className="font-medium text-sm truncate">{plant.name}</h3>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            ) : (
                              <div className="py-4 text-center">
                                <p className="text-muted-foreground text-sm">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ê³  ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</p>
                              </div>
                            )}
                          </div>
                        </div>
                      )}
                      
                      {/* êµ¬ê¸€ ì§€ë„ - ìœ„ì¹˜ ì„ íƒ ëª¨ë“œì¼ ë•Œ í‘œì‹œ */}
                      {message.role === "assistant" && 
                       (interactionMode === "location-selection" || interactionMode === "bid-requested") && 
                       (message.content.includes("ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ê²€ìƒ‰í•´ì„œ ì°¾ìœ¼ì„¸ìš”") || 
                        message.content.includes("ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”")) && (
                          <div className="mt-4 bg-background rounded-md border mb-4">
                            <div className="p-4 space-y-4">
                              {/* ì„ íƒëœ ì‹ë¬¼ ì •ë³´ */}
                              <div className="text-center p-2 bg-accent/20 rounded-md">
                                <p className="text-sm font-medium">ì„ íƒëœ ì‹ë¬¼: {selectedPlant}</p>
                              </div>
                              
                              <Card className="w-full">
                                <CardContent className="p-3">
                                  <div id="location-map-container" className="rounded-md overflow-hidden w-full">
                                    <GoogleMapWrapper 
                                      height="320px"
                                      width="100%"
                                      showSearchBar={interactionMode !== "bid-requested"}
                                      showRadiusControl={interactionMode !== "bid-requested"}
                                      showLocationInfo={true}
                                      onLocationSelect={(location: { lat: number; lng: number; address: string; radius?: number }) => {
                                        setSelectedLocation({
                                          lat: location.lat,
                                          lng: location.lng,
                                          address: location.address,
                                          radius: location.radius || 5
                                        });
                                        setRegion(location.address);
                                      }}
                                    />
                                  </div>
                                
                                {/* ì…ì°° ìš”ì²­ ë²„íŠ¼ - ìš”ì²­ ì™„ë£Œ í›„(bid-requested ëª¨ë“œ)ì—ëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ */}
                                {interactionMode !== "bid-requested" && (
                                  <Button 
                                    onClick={handleRequestBids}
                                    disabled={!selectedPlant || !region.trim()}
                                    className="w-full mt-4"
                                  >
                                    <MapPin className="h-4 w-4 mr-2" /> ì…ì°° ìš”ì²­í•˜ê¸°
                                  </Button>
                                )}
                              </CardContent>
                            </Card>

                          </div>
                        </div>
                      )}
                      
                      {/* ì•„ë˜ìª½ ì¶”ì²œ ì‹ë¬¼ ì„¹ì…˜ì€ ì‚­ì œí•¨ - ìœ„ìª½ì— ì´ë¯¸ í‘œì‹œë˜ê³  ìˆìŒ */}
                    </CardContent>
                  </Card>
                  
                  {/* íƒ€ì„ìŠ¤íƒ¬í”„ */}
                  <div
                    className={cn(
                      "text-xs text-muted-foreground",
                      message.role === "user" ? "text-right" : "text-left"
                    )}
                  >
                    {formatTime(message.timestamp)}
                  </div>
                </div>
              </div>
            </div>
          ))}
          
          {/* ì´ì œ ì§€ë„ëŠ” ì±„íŒ… ë©”ì‹œì§€ ë‚´ì—ì„œ ì§ì ‘ ë Œë”ë§ë©ë‹ˆë‹¤ */}
          
          {/* ë©”ì‹œì§€ ë¡œë”© í‘œì‹œ */}
          {isProcessing && !isSelectingRegion && (
            <div className="flex justify-start mb-4">
              <div className="bg-muted p-3 rounded-lg flex items-center">
                <Loader2 className="h-4 w-4 animate-spin mr-2" />
                <span>ì‘ë‹µ ìƒì„± ì¤‘...</span>
              </div>
            </div>
          )}
          
          {/* ìë™ ìŠ¤í¬ë¡¤ì„ ìœ„í•œ ì°¸ì¡° */}
          <div ref={messagesEndRef} />
        </div>
        
        {/* ë©”ì‹œì§€ ì…ë ¥ ì˜ì—­ */}
        <div className="flex flex-col gap-2">
          {/* ì°¸ê³  ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜ì—­ (ìˆëŠ” ê²½ìš°ë§Œ í‘œì‹œ) */}
          {(selectedImage || uploadedImageUrl) && (
            <div className="flex items-center gap-2 p-2 bg-muted rounded-md">
              <div className="flex-1 flex items-center">
                {uploadedImageUrl ? (
                  <div className="relative w-16 h-16 overflow-hidden rounded-md">
                    <img 
                      src={uploadedImageUrl} 
                      alt="ì°¸ê³  ì´ë¯¸ì§€" 
                      className="w-full h-full object-cover"
                    />
                  </div>
                ) : selectedImage ? (
                  <div className="flex items-center text-sm">
                    <div className="bg-primary/10 text-primary rounded-full p-1 mr-2">
                      <img 
                        src={URL.createObjectURL(selectedImage)} 
                        alt="ë¯¸ë¦¬ë³´ê¸°" 
                        className="w-14 h-14 object-cover rounded-md"
                      />
                    </div>
                    <span className="text-muted-foreground">{selectedImage.name}</span>
                  </div>
                ) : null}
              </div>
              <Button 
                variant="ghost" 
                size="icon"
                onClick={handleCancelImage}
                className="text-destructive hover:text-destructive/80"
              >
                <X className="h-4 w-4" />
              </Button>
            </div>
          )}

          <div className="flex gap-2">
            <div className="relative flex-1">
              <Textarea
                placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyDown={(e) => {
                  if (e.key === "Enter" && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                  }
                }}
                className="resize-none"
                disabled={isProcessing}
              />
              
              {/* ì´ë¯¸ì§€ ì—…ë¡œë“œ ë²„íŠ¼ */}
              <label 
                htmlFor="image-upload" 
                className={`absolute bottom-2 right-2 p-1 rounded-full cursor-pointer ${
                  isProcessing ? 'opacity-50 cursor-not-allowed' : 'hover:bg-muted'
                }`}
              >
                <input
                  id="image-upload"
                  type="file"
                  accept="image/*"
                  onChange={handleImageSelect}
                  disabled={isProcessing}
                  className="hidden"
                />
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-muted-foreground">
                  <rect width="18" height="18" x="3" y="3" rx="2" ry="2"/>
                  <circle cx="9" cy="9" r="2"/>
                  <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/>
                </svg>
              </label>
            </div>
            
            <Button
              onClick={handleSendMessage}
              disabled={!input.trim() || isProcessing}
              className="flex-shrink-0"
            >
              {isUploading ? (
                <Loader2 className="h-4 w-4 animate-spin" />
              ) : (
                <Send className="h-4 w-4" />
              )}
            </Button>
          </div>
        </div>
      </div>

      {/* ì‹ë¬¼ ì •ë³´ ëª¨ë‹¬ */}
      <Dialog open={infoDialogOpen} onOpenChange={setInfoDialogOpen}>
        <DialogContent className="max-w-3xl w-[90vw] max-h-[80vh] h-[600px] flex flex-col">
          <DialogHeader>
            <DialogTitle className="flex-1">{currentPlantInfo?.name}</DialogTitle>
            <DialogDescription className="sr-only">
              êµ¬ê¸€ì—ì„œ "{currentPlantInfo?.name}" ì‹ë¬¼ ì •ë³´ ë³´ê¸°
            </DialogDescription>
          </DialogHeader>
          
          <div className="flex flex-col h-full overflow-hidden">
            {currentPlantInfo && (
              <iframe 
                src={`https://www.google.com/search?q=${encodeURIComponent(currentPlantInfo.name)}&igu=1`}
                className="w-full h-full border-none"
                title={`${currentPlantInfo.name} ì •ë³´`}
              />
            )}
          </div>
          
          <DialogFooter className="flex justify-between items-center">
            <div className="text-sm text-muted-foreground">
              {currentPlantInfo?.priceRange}
            </div>
            <Button
              onClick={() => {
                if (currentPlantInfo) {
                  window.open(`https://www.google.com/search?q=${encodeURIComponent(currentPlantInfo.name)}`, '_blank');
                }
              }}
              size="sm"
              variant="outline"
              className="flex items-center gap-1"
            >
              <ExternalLink className="h-3.5 w-3.5" />
              ìƒˆ ì°½ì—ì„œ ì—´ê¸°
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </DashboardLayout>
  );
}