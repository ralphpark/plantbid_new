<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Firebase Phone Auth</title>
  <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-auth-compat.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #f5f5f5;
    }
    #recaptcha-container {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="recaptcha-container"></div>

  <script>
    // Firebase 초기화
    const firebaseConfig = {
      apiKey: "AIzaSyCqWzr9TTxdNV5DQKlXkLXkfM0pUKr_A-0",
      authDomain: "plantbid-9911d.firebaseapp.com",
      projectId: "plantbid-9911d",
      storageBucket: "plantbid-9911d.firebasestorage.app",
      messagingSenderId: "431605269632",
      appId: "1:431605269632:web:3e4cba5b0635dd79ac57fa"
    };

    firebase.initializeApp(firebaseConfig);

    // 메인 창에서 메시지 받기
    window.addEventListener('message', function(event) {
      if (event.data && event.data.action === 'sendVerificationCode') {
        sendVerificationCode(event.data.phoneNumber);
      } else if (event.data && event.data.action === 'verifyCode') {
        verifyCode(event.data.code);
      }
    });

    let confirmationResult = null;

    // 인증번호 전송
    function sendVerificationCode(phoneNumber) {
      const formattedPhoneNumber = "+82" + phoneNumber.replace(/-/g, "").substring(1);
      
      const recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
        'size': 'normal',
        'callback': (response) => {
          console.log('reCAPTCHA solved, sending verification code...');
        }
      });

      firebase.auth().signInWithPhoneNumber(formattedPhoneNumber, recaptchaVerifier)
        .then((result) => {
          // SMS 전송 성공
          confirmationResult = result;
          window.parent.postMessage({
            status: 'success',
            action: 'codeSent'
          }, '*');
          
          // reCAPTCHA 컨테이너 정리
          recaptchaVerifier.clear();
        })
        .catch((error) => {
          // SMS 전송 실패
          window.parent.postMessage({
            status: 'error',
            action: 'sendFailed',
            error: {
              code: error.code,
              message: error.message
            }
          }, '*');
        });
    }

    // 인증번호 확인
    function verifyCode(code) {
      if (!confirmationResult) {
        window.parent.postMessage({
          status: 'error',
          action: 'verifyFailed',
          error: {
            code: 'auth/no-confirmation-result',
            message: '인증 세션이 만료되었습니다. 다시 인증번호를 요청해주세요.'
          }
        }, '*');
        return;
      }

      confirmationResult.confirm(code)
        .then((result) => {
          // 인증 성공
          window.parent.postMessage({
            status: 'success',
            action: 'verifySuccess',
            user: {
              uid: result.user.uid,
              phoneNumber: result.user.phoneNumber
            }
          }, '*');
          
          // 인증 후 로그아웃
          firebase.auth().signOut();
        })
        .catch((error) => {
          // 인증 실패
          window.parent.postMessage({
            status: 'error',
            action: 'verifyFailed',
            error: {
              code: error.code,
              message: error.message
            }
          }, '*');
        });
    }
  </script>
</body>
</html>