/**
 * Vite ë¯¸ë“¤ì›¨ì–´ë¥¼ ìš°íšŒí•˜ëŠ” ì§ì ‘ API ê²½ë¡œ
 * ì´ ë¼ìš°í„°ëŠ” Viteì˜ ê°„ì„­ ì—†ì´ ì§ì ‘ ìš”ì²­ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
 */
import { Router, Request, Response, NextFunction } from 'express';
import { storage } from './storage';
import { eq } from 'drizzle-orm';
import inicisClient from './inicis-client';
import portoneV2Client, { convertToV2PaymentId, generatePortonePaymentId } from './portone-v2-client';
import axios from 'axios';

const router = Router();

// JSON ì‘ë‹µ ê°•ì œ ë¯¸ë“¤ì›¨ì–´ - ì´ ë¼ìš°í„°ì˜ ëª¨ë“  ì‘ë‹µì„ JSONìœ¼ë¡œ ê°•ì œ
router.use((req: Request, res: Response, next: NextFunction) => {
  console.log('API ìš”ì²­ ê°ì§€, JSON ì‘ë‹µ ì„¤ì •:', req.originalUrl);
  
  // ì›ë˜ send ë©”ì„œë“œ ì €ì¥
  const originalSend = res.send;
  
  // JSONë§Œ í—ˆìš©í•˜ëŠ” send ë©”ì„œë“œë¡œ ì˜¤ë²„ë¼ì´ë“œ
  res.send = function(body: any) {
    // bodyê°€ HTMLì¸ ê²½ìš° (ë¬¸ìì—´ì´ê³  <!DOCTYPE ë˜ëŠ” <htmlë¡œ ì‹œì‘)
    if (typeof body === 'string' && 
       (body.startsWith('<!DOCTYPE') || body.startsWith('<html'))) {
      console.error('HTML ì‘ë‹µ ê°ì§€ ë° ì°¨ë‹¨:', req.originalUrl);
      
      // JSON í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ë°˜í™˜
      res.set('Content-Type', 'application/json');
      
      // ì›ë˜ì˜ send ë©”ì„œë“œ í˜¸ì¶œ
      return originalSend.call(this, JSON.stringify({
        success: false,
        error: 'API ë¼ìš°í„°ì—ì„œ HTML ì‘ë‹µì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.',
        htmlDetected: true
      }));
    }
    
    // ì¼ë°˜ ì‘ë‹µì€ ê·¸ëŒ€ë¡œ í†µê³¼
    return originalSend.call(this, body);
  };
  
  // ëª…ì‹œì  í—¤ë” ì„¤ì •
  res.set({
    'Content-Type': 'application/json',
    'X-Content-Type-Options': 'nosniff'
  });
  
  next();
});

// UUID í˜•ì‹ ê²€ì¦ í…ŒìŠ¤íŠ¸ API
router.post('/payments/format-check', async (req: Request, res: Response) => {
  // ëª…ì‹œì ìœ¼ë¡œ JSON í—¤ë” ì„¤ì •
  res.setHeader('Content-Type', 'application/json; charset=utf-8');
  res.setHeader('X-Content-Type-Options', 'nosniff');
  
  try {
    const { paymentKey } = req.body;
    
    if (!paymentKey) {
      return res.status(400).json({
        success: false,
        error: 'ê²°ì œ í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }
    
    console.log(`[ì§ì ‘ ë¼ìš°í„°] ê²°ì œ í‚¤ í˜•ì‹ í…ŒìŠ¤íŠ¸: ${paymentKey}`);
    
    // UUID ë³€í™˜ í…ŒìŠ¤íŠ¸
    const formattedKey = convertToV2PaymentId(paymentKey);
    
    return res.status(200).json({
      success: true,
      originalKey: paymentKey,
      formattedKey,
      length: formattedKey.length,
      isV2Format: formattedKey.startsWith('pay_') && formattedKey.length === 26
    });
  } catch (error: any) {
    console.error('[ì§ì ‘ ë¼ìš°í„°] í˜•ì‹ ë³€í™˜ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error.message);
    return res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// ê²°ì œ ì •ë³´ ë™ê¸°í™” API
router.post('/payments/sync', async (req: Request, res: Response) => {
  // ëª…ì‹œì ìœ¼ë¡œ JSON í—¤ë” ì„¤ì •
  res.setHeader('Content-Type', 'application/json; charset=utf-8');
  res.setHeader('X-Content-Type-Options', 'nosniff');
  
  try {
    const { orderId } = req.body;
    
    if (!orderId) {
      return res.status(400).json({
        success: false,
        error: 'ì£¼ë¬¸ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }
    
    console.log(`[ì§ì ‘ ë¼ìš°í„°] ì£¼ë¬¸ ${orderId}ì— ëŒ€í•œ ê²°ì œ ì •ë³´ ë™ê¸°í™” ìš”ì²­`);
    
    // ì£¼ë¬¸ ì •ë³´ ì¡°íšŒ
    const order = await storage.getOrderByOrderId(orderId);
    
    if (!order) {
      return res.status(404).json({
        success: false,
        error: 'ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }
    
    // ê¸°ì¡´ ê²°ì œ ì •ë³´ í™•ì¸
    const existingPayment = await storage.getPaymentByOrderId(orderId);
    
    if (existingPayment) {
      return res.status(200).json({
        success: true,
        message: 'ì´ë¯¸ ê²°ì œ ì •ë³´ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.',
        payment: existingPayment
      });
    }
    
    // ê²°ì œ ì •ë³´ ìƒì„± (ìŠ¤í‚¤ë§ˆì— ë§ëŠ” í˜•ì‹ìœ¼ë¡œ)
    // í¬íŠ¸ì› V2 API ê·œê²©ì— ë§ëŠ” paymentKey ìƒì„±
    const paymentKey = generatePortonePaymentId();
    console.log(`V2 API ê·œê²© ê²°ì œ ID ìƒì„±: ${paymentKey} (${paymentKey.length}ì)`);
    
    const paymentData = {
      userId: order.userId,
      bidId: 21, // ì‹¤ì œ ì¡´ì¬í•˜ëŠ” bid ID ì‚¬ìš© (21)
      orderId: orderId,
      orderName: "ì‹ë¬¼ êµ¬ë§¤: " + orderId,
      amount: order.price.toString(),
      method: "CARD",
      status: "success",
      // í¬íŠ¸ì› V2 API í˜•ì‹ì˜ paymentKey ì‚¬ìš© - pay_ë¡œ ì‹œì‘í•˜ëŠ” 26ì ë¬¸ìì—´
      paymentKey: paymentKey,
      customerName: "êµ¬ë§¤ì",
      paymentUrl: `https://iniweb.inicis.com/receipt/MOI3204387_${orderId}`
    };
    
    // ê²°ì œ ì •ë³´ ì €ì¥
    const payment = await storage.createPayment(paymentData);
    
    return res.status(200).json({
      success: true,
      message: 'ê²°ì œ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.',
      payment
    });
  } catch (error: any) {
    console.error('[ì§ì ‘ ë¼ìš°í„°] ê²°ì œ ì •ë³´ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜:', error);
    return res.status(500).json({
      success: false,
      error: error.message || 'ê²°ì œ ì •ë³´ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

// íŠ¹ì • ì£¼ë¬¸ì˜ ê²°ì œ ì •ë³´ ì¡°íšŒ API
router.get('/payments/order/:orderId', async (req: Request, res: Response) => {
  // ëª…ì‹œì ìœ¼ë¡œ JSON í—¤ë” ì„¤ì •
  res.setHeader('Content-Type', 'application/json; charset=utf-8');
  res.setHeader('X-Content-Type-Options', 'nosniff');
  res.setHeader('Cache-Control', 'no-store');
  
  try {
    const { orderId } = req.params;
    console.log('[ì§ì ‘ ë¼ìš°í„°] ì£¼ë¬¸ IDë¡œ ê²°ì œ ì •ë³´ ì¡°íšŒ:', orderId);
    
    const payment = await storage.getPaymentByOrderId(orderId);
    
    if (!payment) {
      console.log('[ì§ì ‘ ë¼ìš°í„°] ì£¼ë¬¸ì— ëŒ€í•œ ê²°ì œ ì •ë³´ê°€ ì—†ìŒ:', orderId);
      return res.status(404).json({ 
        success: false,
        error: 'ê²°ì œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' 
      });
    }
    
    console.log('[ì§ì ‘ ë¼ìš°í„°] ê²°ì œ ì •ë³´ ì°¾ìŒ:', payment.id);
    return res.status(200).json(payment);
    
  } catch (error: any) {
    console.error('[ì§ì ‘ ë¼ìš°í„°] ê²°ì œ ì •ë³´ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜:', error);
    return res.status(500).json({ 
      success: false,
      error: error.message || 'ê²°ì œ ì •ë³´ ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' 
    });
  }
});

// V2 API ì „ìš© ê²°ì œ ì·¨ì†Œ í•¨ìˆ˜ (ìµœì‹  ê°€ì´ë“œ ê¸°ë°˜)
async function cancelPaymentV2(paymentId: string, reason: string, amount?: number) {
  console.log(`\n===== V2 API ê²°ì œ ì·¨ì†Œ ì§ì ‘ í˜¸ì¶œ =====`);
  
  try {
    // 1. ê²°ì œ ID ì •ì œ (í•˜ì´í”ˆ ì œê±° ë° í˜•ì‹ í™•ì¸)
    let cleanPaymentId = paymentId.replace(/-/g, '');
    console.log(`ê²°ì œ ID í•˜ì´í”ˆ ì œê±°: ${paymentId} â†’ ${cleanPaymentId}`);
    
    // 2. API URL êµ¬ì„±
    const apiUrl = 'https://api.portone.io/v2';
    const cancelUrl = `${apiUrl}/payments/${cleanPaymentId}/cancel`;
    console.log(`ê²°ì œ ì·¨ì†Œ URL: ${cancelUrl}`);
    
    // 3. ë©±ë“±ì„± í‚¤ ìƒì„± (UUID ë°©ì‹)
    const idempotencyKey = require('crypto').randomUUID();
    console.log(`Idempotency-Key: ${idempotencyKey}`);
    
    // 4. ìš”ì²­ ë³¸ë¬¸ êµ¬ì„±
    const requestBody: Record<string, any> = {
      reason: reason || 'ê³ ê° ìš”ì²­ì— ì˜í•œ ì·¨ì†Œ'
    };
    
    // ë¶€ë¶„ ì·¨ì†Œ ì‹œ ê¸ˆì•¡ ì¶”ê°€
    if (amount && amount > 0) {
      requestBody.amount = amount;
    }
    
    console.log(`ìš”ì²­ ë³¸ë¬¸: ${JSON.stringify(requestBody)}`);
    
    // 5. V2 API í‚¤ ì„¤ì •
    const apiSecret = "Q5xc87z1Sxd5uPQDuz72O7pDGqy7XAC2b9EPO9PWFPvFT5jCy2er5Ap9IWHMP1iRVfcF54qE2nXx22J4";
    
    // 6. V2 ê°€ì´ë“œì— ë”°ë¥¸ í—¤ë” ì„¤ì •
    const headers = {
      'Authorization': `PortOne ${apiSecret}`,  // PortOne ì ‘ë‘ì‚¬ í•„ìˆ˜
      'Content-Type': 'application/json',
      'Accept': 'application/json',
      'Idempotency-Key': idempotencyKey  // ë©±ë“±ì„± í‚¤ í•„ìˆ˜
    };
    
    console.log(`ì¸ì¦ í—¤ë”: PortOne ${apiSecret.substring(0, 5)}...${apiSecret.substring(apiSecret.length-5)}`);
    
    // 7. API í˜¸ì¶œ
    const response = await axios.post(cancelUrl, requestBody, { headers });
    
    console.log(`ì‘ë‹µ ìƒíƒœ: ${response.status}`);
    console.log(`ì‘ë‹µ ë°ì´í„°: ${JSON.stringify(response.data)}`);
    
    return {
      success: true,
      data: response.data
    };
  } catch (error: any) {
    console.error(`âŒ ê²°ì œ ì·¨ì†Œ ì‹¤íŒ¨: ${error.message}`);
    
    if (error.response) {
      console.error(`ì‘ë‹µ ìƒíƒœ: ${error.response.status}`);
      console.error(`ì‘ë‹µ ë°ì´í„°: ${JSON.stringify(error.response.data || {})}`);
    }
    
    return {
      success: false,
      error: error.message,
      details: error.response?.data || {}
    };
  }
}

// ê²°ì œ ì·¨ì†Œ API
router.post('/payments/cancel', async (req: Request, res: Response) => {
  // ê°€ì´ë“œì— ë”°ë¼ JSON ì‘ë‹µ ê°•ì œ (res.type())
  res.type('json');
  // JSON ì‘ë‹µ í˜•ì‹ ê°•ì œ ì„¤ì • - í•­ìƒ JSONìœ¼ë¡œ ì‘ë‹µ
  res.setHeader('Content-Type', 'application/json; charset=utf-8');
  res.setHeader('X-Content-Type-Options', 'nosniff');
  res.setHeader('Cache-Control', 'no-store, must-revalidate');
  
  console.log('\n\n======= ê²°ì œ ì·¨ì†Œ API í˜¸ì¶œ ì‹œì‘ =======');
  
  try {
    const { orderId, reason } = req.body;
    
    if (!orderId) {
      console.log('ì£¼ë¬¸ ID ëˆ„ë½ ì˜¤ë¥˜');
      return res.status(400).json({
        success: false,
        error: 'ì£¼ë¬¸ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }
    
    console.log(`ê²°ì œ ì·¨ì†Œ ìš”ì²­ ì •ë³´: ì£¼ë¬¸ ID=${orderId}, ì‚¬ìœ =${reason || 'ì‚¬ìš©ì ìš”ì²­'}`);
    
    // 1. ê²°ì œ ì •ë³´ ì¡°íšŒ - ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë¨¼ì € í™•ì¸
    console.log('\n1. ê²°ì œ ì •ë³´ ë°ì´í„°ë² ì´ìŠ¤ ì¡°íšŒ');
    const payment = await storage.getPaymentByOrderId(orderId);
    
    if (!payment) {
      console.log('ê²°ì œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
      return res.status(404).json({
        success: false,
        error: 'ê²°ì œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }
    
    console.log('ê²°ì œ ì •ë³´ ì°¾ìŒ:');
    console.log(`- ID: ${payment.id}`);
    console.log(`- ê²°ì œ í‚¤: ${payment.paymentKey}`);
    console.log(`- ê²°ì œ ìƒíƒœ: ${payment.status}`);
    console.log(`- ê²°ì œ ê¸ˆì•¡: ${payment.amount}`);
    
    // 2. ì´ë¯¸ ì·¨ì†Œëœ ê²°ì œì¸ ê²½ìš° ì²˜ë¦¬
    if (payment.status === 'CANCELLED' || payment.cancelledAt) {
      console.log('ì´ë¯¸ ì·¨ì†Œëœ ê²°ì œì…ë‹ˆë‹¤. ì¤‘ë³µ ì·¨ì†Œ ë°©ì§€');
      return res.status(200).json({
        success: true,
        message: 'ì´ë¯¸ ì·¨ì†Œëœ ê²°ì œì…ë‹ˆë‹¤.',
        payment
      });
    }
    
    // 3. í¬íŠ¸ì› V2 API í˜¸ì¶œ ì¤€ë¹„
    console.log('\n2. í¬íŠ¸ì› V2 API ì·¨ì†Œ í˜¸ì¶œ');
    let apiCallSuccess = false;
    let apiCallError = null;
    let apiResponse = null;
    
    // ê²°ì œ í‚¤ê°€ ì—†ìœ¼ë©´ ì˜¤ë¥˜ ë°˜í™˜
    if (!payment.paymentKey) {
      return res.status(400).json({
        success: false,
        error: 'ê²°ì œ í‚¤ê°€ ì—†ì–´ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
      });
    }
    
    // 4. ê²°ì œ ì·¨ì†Œ API ì§ì ‘ í˜¸ì¶œ (V2 ê°€ì´ë“œ ì¤€ìˆ˜)
    // ì£¼ë¬¸ID(orderId)ì—ëŠ” í•˜ì´í”ˆì´ ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì§ì ‘ ì·¨ì†Œ í˜¸ì¶œ
    const cancelResult = await cancelPaymentV2(
      orderId,  // ì£¼ë¬¸ ID ì‚¬ìš© (í•˜ì´í”ˆ ìë™ ì œê±°ë¨)
      reason || 'ê³ ê° ìš”ì²­ì— ì˜í•œ ì·¨ì†Œ'
    );
    
    // 5. ì·¨ì†Œ ê²°ê³¼ ì²˜ë¦¬
    if (cancelResult.success) {
      console.log('âœ… ê²°ì œ ì·¨ì†Œ ì„±ê³µ');
      apiCallSuccess = true;
      apiResponse = cancelResult.data;
      
      // ë°ì´í„°ë² ì´ìŠ¤ ê²°ì œ ì •ë³´ ì—…ë°ì´íŠ¸
      const updatedPayment = await storage.updatePayment(payment.id, {
        status: 'CANCELLED',
        cancelReason: reason || 'ê³ ê° ìš”ì²­ì— ì˜í•œ ì·¨ì†Œ',
        cancelledAt: new Date()
      });
      
      // ì£¼ë¬¸ ìƒíƒœë„ ì·¨ì†Œë¡œ ë³€ê²½
      const order = await storage.getOrderByOrderId(orderId);
      if (order) {
        await storage.updateOrderStatus(order.id, 'cancelled');
      }
      
      // ì„±ê³µ ì‘ë‹µ
      return res.status(200).json({
        success: true,
        message: 'ê²°ì œê°€ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.',
        payment: updatedPayment
      });
    } else {
      // ì·¨ì†Œ ì‹¤íŒ¨
      console.error('âŒ ê²°ì œ ì·¨ì†Œ ì‹¤íŒ¨:', cancelResult.error);
      return res.status(500).json({
        success: false,
        error: `ê²°ì œ ì·¨ì†Œ ì‹¤íŒ¨: ${cancelResult.error}`,
        details: cancelResult.details
      });
    }
  } catch (error: any) {
    console.error('ê²°ì œ ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
    return res.status(500).json({
      success: false,
      error: `ê²°ì œ ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`
    });
  }
    

      
      let portoneResponse = null;
      let portoneApiSuccess = false;
      
      try {
        // í¬íŠ¸ì› API í˜¸ì¶œ ì‹œë„ (ë¬´ì¡°ê±´ JSON ì‘ë‹µ ì„¤ì •)
        res.set('Content-Type', 'application/json');
        
        console.log('\n3. ê²°ì œ ID ê²€ì¦ ë° í™•ì¸');
        
        // ê²°ì œ ID ê²€ì¦ - pay_ í˜•ì‹ì´ í•„ìš”í•¨
        if (!payment.paymentKey.startsWith('pay_')) {
          console.log(`ğŸ’¡ ê²°ì œ IDê°€ pay_ í˜•ì‹ì´ ì•„ë‹˜: ${payment.paymentKey}`);
          console.log(`ğŸ’¡ ê²°ì œ IDë¥¼ pay_ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ ì‹œë„`);
          
          // pay_ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
          payment.paymentKey = convertToV2PaymentId(payment.paymentKey);
          console.log(`ğŸ’¡ ë³€í™˜ëœ ê²°ì œ ID: ${payment.paymentKey}`);
          
          // ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ - ë³€í™˜ëœ ID ì €ì¥
          await storage.updatePayment(payment.id, {
            paymentKey: payment.paymentKey
          });
          console.log(`ğŸ’¡ ë°ì´í„°ë² ì´ìŠ¤ ê²°ì œ ID ì—…ë°ì´íŠ¸ ì™„ë£Œ`);
        }
        
        console.log('\n4. ì§ì ‘ API í˜¸ì¶œë¡œ ê²°ì œ ì·¨ì†Œ');
        
        // ì§ì ‘ axiosë¥¼ ì‚¬ìš©í•˜ì—¬ API í˜¸ì¶œ
        // paymentId í˜•ì‹ ìˆ˜ì • (í•˜ì´í”ˆ ì œê±°)
        let cleanPaymentId = orderId.replace(/-/g, '');
        console.log(`ê²°ì œ ID í•˜ì´í”ˆ ì œê±°: ${orderId} â†’ ${cleanPaymentId}`);
        
        // ê°€ì´ë“œì— ë”°ë¥¸ ì—”ë“œí¬ì¸íŠ¸ ì„¤ì •
        const apiUrl = 'https://api.portone.io/v2/payments';
        const cancelUrl = `${apiUrl}/${cleanPaymentId}/cancel`;
        
        console.log(`ê²°ì œ ì·¨ì†Œ URL: ${cancelUrl}`);
        
        // ë©±ë“±ì„± í‚¤ ìƒì„± - UUID ì‚¬ìš© (ê°€ì´ë“œ ê¶Œì¥)
        const idempotencyKey = require('crypto').randomUUID();
        console.log(`Idempotency-Key (UUID): ${idempotencyKey}`);
        
        // ê²°ì œ ì·¨ì†Œ ìš”ì²­ ë³¸ë¬¸
        const cancelBody = {
          reason: reason || 'ê³ ê° ìš”ì²­ì— ì˜í•œ ì·¨ì†Œ'
        };
        
        // ê³ ì •ëœ ìƒì  ì‹ë³„ì
        const merchantId = "MOI3204387";
        console.log(`ìƒì  ì‹ë³„ì(MID): ${merchantId}`);
        
        // API í‚¤ ì„¤ì •
        const apiSecret = "Q5xc87z1Sxd5uPQDuz72O7pDGqy7XAC2b9EPO9PWFPvFT5jCy2er5Ap9IWHMP1iRVfcF54qE2nXx22J4";
        
        // í¬íŠ¸ì› ë¬¸ì„œ ê°€ì´ë“œì— ë§ëŠ” í—¤ë” ì„¤ì •
        const headers = {
          'Authorization': `PortOne ${apiSecret}`, // í¬íŠ¸ì› ê°€ì´ë“œì— ë”°ë¼ 'PortOne' í˜•ì‹ ì‚¬ìš©
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'Idempotency-Key': idempotencyKey // í•„ìˆ˜: ì¤‘ë³µ ìš”ì²­ ë°©ì§€ UUID
        };
        
        console.log('ê²°ì œ ì·¨ì†Œ ìš”ì²­ í—¤ë”:');
        console.log(`- Authorization: PortOne ${apiSecret.substring(0, 5)}...${apiSecret.substring(apiSecret.length-5)}`);
        console.log(`- Idempotency-Key: ${idempotencyKey}`);
        console.log('ê²°ì œ ì·¨ì†Œ ìš”ì²­ ë³¸ë¬¸:', JSON.stringify(cancelBody));
        
        try {
          // ì§ì ‘ axiosë¡œ API í˜¸ì¶œ
          const cancelResponse = await axios.post(cancelUrl, cancelBody, { headers });
          
          console.log('ê²°ì œ ì·¨ì†Œ ì‘ë‹µ ìƒíƒœ:', cancelResponse.status);
          console.log('ê²°ì œ ì·¨ì†Œ ì‘ë‹µ ë°ì´í„°:', cancelResponse.data);
          
          portoneResponse = cancelResponse.data;
          portoneApiSuccess = true;
          
          console.log('âœ… í¬íŠ¸ì› V2 API ì·¨ì†Œ ì„±ê³µ:', portoneResponse ? 'ì‘ë‹µ ë°›ìŒ' : 'ì‘ë‹µ ì—†ìŒ');
          apiCallSuccess = true;
          apiResponse = portoneResponse;
          
          // API ì„±ê³µ í›„ ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸
          console.log('\n5. ë°ì´í„°ë² ì´ìŠ¤ ê²°ì œ ì •ë³´ ì—…ë°ì´íŠ¸');
          const canceledPayment = await storage.updatePayment(payment.id, {
            status: 'CANCELLED',
            cancelReason: reason || 'ê³ ê° ìš”ì²­ì— ì˜í•œ ì·¨ì†Œ',
            cancelledAt: new Date()
          });
          console.log('âœ“ ë°ì´í„°ë² ì´ìŠ¤ ê²°ì œ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
          
          // ì£¼ë¬¸ ìƒíƒœë„ ì·¨ì†Œë¡œ ë³€ê²½
          const order = await storage.getOrderByOrderId(orderId);
          if (order) {
            await storage.updateOrderStatus(order.id, 'cancelled');
            console.log('âœ“ ì£¼ë¬¸ ìƒíƒœë„ ì·¨ì†Œë¡œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
          }
          
          // ì‘ë‹µ ê°ì²´ êµ¬ì„±
          const responseData = {
            success: true,
            message: 'ê²°ì œê°€ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.',
            payment: canceledPayment,
            apiCallSuccess: true,
            portoneResponse: 'ì„±ê³µ'
          };
          
          console.log('ì‘ë‹µ ë°ì´í„°:', JSON.stringify(responseData, null, 2));
          console.log('======= ê²°ì œ ì·¨ì†Œ API í˜¸ì¶œ ì™„ë£Œ =======\n\n');
          
          return res.status(200).json(responseData);
          
        } catch (portoneError: any) {
          console.error('âš ï¸ í¬íŠ¸ì› API í˜¸ì¶œ ì‹¤íŒ¨:', portoneError.message);
          
          if (portoneError.response) {
            console.error('ì‘ë‹µ ìƒíƒœ:', portoneError.response.status);
            console.error('ì‘ë‹µ ë°ì´í„°:', JSON.stringify(portoneError.response.data, null, 2));
            
            // 404 ì˜¤ë¥˜ - ê²°ì œ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ (ê¸¸ì´ ë¬¸ì œì¼ ê°€ëŠ¥ì„± ë†’ìŒ)
            if (portoneError.response.status === 404) {
              console.error(`ê²°ì œ ID 404 ì˜¤ë¥˜ - IDê°€ ìœ íš¨í•˜ì§€ ì•ŠìŒ: ${payment.paymentKey || 'ì•Œ ìˆ˜ ì—†ìŒ'}`);
              // null ì²´í¬ í›„ ê¸¸ì´ í™•ì¸
              if (payment.paymentKey) {
                console.error('ê²°ì œ IDëŠ” ë°˜ë“œì‹œ 26ìì—¬ì•¼ í•¨ (í˜„ì¬: ' + payment.paymentKey.length + 'ì)');
              } else {
                console.error('ê²°ì œ IDê°€ null ë˜ëŠ” undefinedì…ë‹ˆë‹¤.');
              }
            }
          }
          
          console.log('ğŸ’¡ ì°¸ê³ : í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œëŠ” ì´ ì˜¤ë¥˜ê°€ ì˜ˆìƒë©ë‹ˆë‹¤.');
          
          // í¬íŠ¸ì› API ì‹¤íŒ¨í•´ë„ ë°ì´í„°ë² ì´ìŠ¤ëŠ” ì·¨ì†Œ ìƒíƒœë¡œ ì„¤ì • (í…ŒìŠ¤íŠ¸ í™˜ê²½ìš©)
          console.log('\n5. API ì˜¤ë¥˜ í›„ ë°ì´í„°ë² ì´ìŠ¤ë§Œ ì—…ë°ì´íŠ¸');
          const canceledPayment = await storage.updatePayment(payment.id, {
            status: 'CANCELLED',
            cancelReason: reason || 'ê³ ê° ìš”ì²­ì— ì˜í•œ ì·¨ì†Œ (API ì˜¤ë¥˜)',
            cancelledAt: new Date()
          });
          console.log('âœ“ ë°ì´í„°ë² ì´ìŠ¤ ê²°ì œ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
          
          // ì£¼ë¬¸ ìƒíƒœë„ ì·¨ì†Œë¡œ ë³€ê²½
          const order = await storage.getOrderByOrderId(orderId);
          if (order) {
            await storage.updateOrderStatus(order.id, 'cancelled');
            console.log('âœ“ ì£¼ë¬¸ ìƒíƒœë„ ì·¨ì†Œë¡œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
          }
          
          // ì‘ë‹µ ê°ì²´ êµ¬ì„±
          const responseData = {
            success: true,
            message: 'ê²°ì œê°€ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì·¨ì†Œë˜ì—ˆì§€ë§Œ, í¬íŠ¸ì› API í˜¸ì¶œì€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
            apiCallSuccess: false,
            error: portoneError.message,
            details: portoneError.response?.data || null,
            note: "í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œëŠ” ì´ ì˜¤ë¥˜ê°€ ì˜ˆìƒë©ë‹ˆë‹¤. ë°ì´í„°ë² ì´ìŠ¤ ì·¨ì†ŒëŠ” ìœ íš¨í•©ë‹ˆë‹¤."
          };
          
          console.log('ê²°ì œ ì·¨ì†Œ API ì‘ë‹µ:', responseData);
          
          // í•­ìƒ JSON ì‘ë‹µ ì„¤ì •
          return res.status(200).json(responseData);
        }
      } catch (dbError: any) {
        console.error('ë°ì´í„°ë² ì´ìŠ¤ ì²˜ë¦¬ ì˜¤ë¥˜:', dbError.message);
        
        return res.status(500).json({
          success: false,
          message: 'ê²°ì œ ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
          error: dbError.message
        });
      }
      
    } catch (dbError: any) {
      // ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜ ì‹œ ì²˜ë¦¬
      console.error('ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', dbError.message);
      console.error('======= ë°ì´í„°ë² ì´ìŠ¤ ì²˜ë¦¬ ì‹¤íŒ¨ =======\n\n');
      
      return res.status(500).json({
        success: false,
        error: `ë°ì´í„°ë² ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${dbError.message}`
      });
    }
    
  } catch (error: any) {
    // ê¸°íƒ€ ì˜¤ë¥˜ ì²˜ë¦¬
    console.error('ê²°ì œ ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error.message);
    console.error('======= ê²°ì œ ì·¨ì†Œ API ì˜¤ë¥˜ ë°œìƒ =======\n\n');
    
    return res.status(500).json({
      success: false,
      error: error.message || 'ê²°ì œ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
    });
  }
});

export default router;