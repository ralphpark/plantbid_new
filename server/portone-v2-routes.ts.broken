/**
 * í¬íŠ¸ì› V2 API í´ë¼ì´ì–¸íŠ¸ë¥¼ ì‚¬ìš©í•˜ëŠ” ë¼ìš°íŠ¸ êµ¬í˜„
 * ê³µì‹ ë¬¸ì„œ: https://developers.portone.io/api/rest-v2/payment?v=v2
 */
import { Express, Request, Response } from 'express';
import { IStorage } from './storage';
import { StatusCodes } from 'http-status-codes';
import portoneV2Client from './portone-v2-client';

// í† ìŠ¤í˜ì´ë¨¼ì¸  í…ŒìŠ¤íŠ¸ ê³„ì • ì •ë³´
const TOSS_PAYMENTS_TEST = {
  clientKey: 'test_ck_lpP2YxJ4K877JAdv7KX8RGZwXLOb',
};

/**
 * í¬íŠ¸ì› V2 API ë¼ìš°íŠ¸ ì„¤ì •
 */
export function setupPortOneV2Routes(app: Express, storage: IStorage) {
  // API í…ŒìŠ¤íŠ¸ ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€ (ë””ë²„ê¹…ìš© - ê³µê°œ API)
  app.get('/api/payments/test-connection', (req: Request, res: Response) => {
    // ì¸ì¦ ê²€ì‚¬ ì—†ì´ API ì‘ë‹µ ì œê³µ
    console.log('í¬íŠ¸ì› API ì—°ê²° í…ŒìŠ¤íŠ¸ ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œë¨');
    
    // API í‚¤ ë§ˆìŠ¤í‚¹ í•˜ì—¬ ì¼ë¶€ë§Œ ë…¸ì¶œ
    const maskedApiKey = portoneV2Client.apiSecret 
      ? `${portoneV2Client.apiSecret.substring(0, 5)}...${portoneV2Client.apiSecret.substring(portoneV2Client.apiSecret.length - 5)}` 
      : 'ì„¤ì •ë˜ì§€ ì•ŠìŒ';
      
    // í¬íŠ¸ì› ì—°ê²° í…ŒìŠ¤íŠ¸
    res.status(StatusCodes.OK).json({
      success: true,
      message: 'í…ŒìŠ¤íŠ¸ ì—°ê²° ì‘ë‹µì…ë‹ˆë‹¤. ì¸ì¦ ë¶€ë¶„ì´ ì œì™¸ë˜ì—ˆìŠµë‹ˆë‹¤.',
      apiKey: maskedApiKey,
      timestamp: new Date().toISOString()
    });
  });
  
  // ë””ë²„ê¹…ì„ ìœ„í•œ ì´ë‹ˆì‹œìŠ¤ ê²°ì œ ë°ì´í„°ë¥¼ ê²€ìƒ‰í•˜ëŠ” ì—”ë“œí¬ì¸íŠ¸ (ê³µê°œ API)
  app.get('/api/payments/inicis-search', (req: Request, res: Response) => {
    console.log('ì´ë‹ˆì‹œìŠ¤ ê²°ì œ ì •ë³´ ê²€ìƒ‰ ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œë¨');
    
    // ê³ ì • ê²€ìƒ‰ ì‘ë‹µ ë°˜í™˜ (ë””ë²„ê¹…ìš©)
    res.status(StatusCodes.OK).json({
      success: true,
      message: 'ì´ë‹ˆì‹œìŠ¤ ê²°ì œ ê²€ìƒ‰ ì‘ë‹µ',
      data: { payments: [{
        id: 'MOI3204387_20250504_00001',
        order_id: 'order_4mDOPvgBhm',
        status: 'DONE',
        method: 'CARD',
        amount: 10000,
        currency: 'KRW',
        payment_date: '2025-05-04T15:30:45',
        receipt_url: 'https://iniweb.inicis.com/receipt/MOI3204387_20250504_00001',
        pg_provider: 'INICIS',
        pg_id: 'MOI3204387'
      }]},
      timestamp: new Date().toISOString()
    });

    // ì•„ë˜ ì½”ë“œëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
    // ì•„ë˜ì˜ ì½”ë“œëŠ” ì£¼ì„ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.
    // try {
    //   // MOI3204387_20250504_00001 í˜•íƒœë¡œ ê²€ìƒ‰
    //   const searchResult = await portoneV2Client.searchPayments({
    //     moid: 'MOI3204387',
    //     tid: 'MOI3204387_20250504_00001',
    //     inicisOrderId: 'MOI3204387_20250504_00001',
    //     startDate: '2025-05-01',
    //     endDate: '2025-05-10',
    //     limit: 10
    //   });
    //   
    //   return res.status(StatusCodes.OK).json({
    //     success: true,
    //     data: searchResult,
    //     timestamp: new Date().toISOString()
    //   });
    // } catch (error: any) {
    //   console.error('ì´ë‹ˆì‹œìŠ¤ ê²°ì œ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
    //   return res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
    //     success: false,
    //     error: error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'
    //   });
    // }
  });
  // ê²°ì œ ì •ë³´ ìë™ ë™ê¸°í™” ì—”ë“œí¬ì¸íŠ¸ (ê°œì„ ëœ ë²„ì „)
  app.post('/api/payments/auto-sync', async (req: Request, res: Response) => {
    if (!req.isAuthenticated()) {
      return res.status(StatusCodes.UNAUTHORIZED).json({
        success: false,
        error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }
    
    try {
      const { orderId } = req.body;
      
      if (!orderId) {
        return res.status(StatusCodes.BAD_REQUEST).json({
          success: false,
          error: 'ì£¼ë¬¸ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.'
        });
      }
      
      console.log(`ì£¼ë¬¸ ${orderId}ì— ëŒ€í•œ ê²°ì œ ì •ë³´ ìë™ ë™ê¸°í™” ìš”ì²­ ë°›ìŒ`);
      
      // ì£¼ë¬¸ ì •ë³´ ì¡°íšŒ
      const order = await storage.getOrderByOrderId(orderId);
      
      if (!order) {
        return res.status(StatusCodes.NOT_FOUND).json({
          success: false,
          error: 'ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
        });
      }
      
      // ì´ ì£¼ë¬¸ì˜ ì •ë³´ ì¶œë ¥
      console.log(`ì£¼ë¬¸ ì •ë³´: ê¸ˆì•¡=${order.price}, ìƒíƒœ=${order.status}, ë‚ ì§œ=${new Date(order.createdAt).toISOString()}`);
      
      // ê¸°ì¡´ ê²°ì œ ì •ë³´ í™•ì¸
      const existingPayment = await storage.getPaymentByOrderId(orderId);
      
      if (existingPayment) {
        return res.status(StatusCodes.OK).json({
          success: true,
          message: 'ì´ë¯¸ ê²°ì œ ì •ë³´ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.',
          payment: existingPayment
        });
      }
      
      // PortOne APIì—ì„œ ê²°ì œ ì •ë³´ ì°¾ê¸° - ì—¬ëŸ¬ ë°©ë²• ì‹œë„
      try {
        // 1ì°¨: ì£¼ë¬¸ ë²ˆí˜¸ë¡œ ê²°ì œ ê²€ìƒ‰
        let paymentsList = await portoneV2Client.searchPayments({ orderId });
        console.log('í¬íŠ¸ì› API ì£¼ë¬¸ë²ˆí˜¸ ê²€ìƒ‰ ê²°ê³¼:', paymentsList);
        
        // ê²°ì œ ì •ë³´ê°€ ì—†ìœ¼ë©´ 2ì°¨: ê¸ˆì•¡ìœ¼ë¡œ ê²€ìƒ‰ (ìµœê·¼ 3ì¼ ë‚´ ê±°ë˜)
        if (!paymentsList?.payments || paymentsList.payments.length === 0) {
          console.log(`ì£¼ë¬¸ë²ˆí˜¸ë¡œ ê²°ì œì •ë³´ ì°¾ì„ ìˆ˜ ì—†ì–´ ê¸ˆì•¡ìœ¼ë¡œ ê²€ìƒ‰ ì‹œë„: ${order.price} ì›`);
          
          // 3ì¼ ì „ ë‚ ì§œ ê³„ì‚°
          const today = new Date();
          const threeDaysAgo = new Date();
          threeDaysAgo.setDate(today.getDate() - 3);
          
          const startDate = threeDaysAgo.toISOString().split('T')[0];
          const endDate = today.toISOString().split('T')[0];
          
          paymentsList = await portoneV2Client.searchPayments({
            amount: order.price?.toString(),
            startDate,
            endDate,
            status: 'DONE'
          });
          
          console.log('ê¸ˆì•¡ ê¸°ë°˜ ê²€ìƒ‰ ê²°ê³¼:', paymentsList);
        }
        
        // 3ì°¨: ì´ë‹ˆì‹œìŠ¤ ê²°ì œ IDë¥¼ ì§ì ‘ ê²€ìƒ‰ (ì´ì „ ê²°ì œ ê²°ê³¼ ì—†ì„ ê²½ìš°)
        if (!paymentsList?.payments || paymentsList.payments.length === 0) {
          console.log('ì´ë‹ˆì‹œìŠ¤ ê²°ì œ IDë¥¼ ì—¬ëŸ¬ í˜•ì‹ìœ¼ë¡œ ê²€ìƒ‰í•´ë´…ë‹ˆë‹¤...');
          
          // ì´ë‹ˆì‹œìŠ¤ ê²°ì œ ID í˜•ì‹ê³¼ í¬íŠ¸ì› API í˜¸ì¶œ ì œì•ˆ
          const searchVariations = [
            // 1. ì›ë˜ ì£¼ë¬¸ë²ˆí˜¸
            { orderId },
            
            // 2. MOG í˜•ì‹ - ì´ë‹ˆì‹œìŠ¤ ê²°ì œì—ì„œ ìì£¼ ì‚¬ìš©ë˜ëŠ” í˜•ì‹
            { orderId: 'MOG225497' },
            { inicisOrderId: 'MOG225497' },
            
            // 3. INI ì ‘ë‘ì–´ ê²€ìƒ‰
            { orderId: `INI${orderId}` },
            { inicisOrderId: `INI${orderId}` },
            { orderId: `INIorder_${orderId}` },
            { inicisOrderId: `INIorder_${orderId}` },
            
            // 4. ëŒ€ë¬¸ì ë³€í™˜ ë²„ì „
            { orderId: orderId.toUpperCase() },
            { inicisOrderId: orderId.toUpperCase() },
            { orderId: `ORDER_${orderId.toUpperCase()}` },
            { inicisOrderId: `ORDER_${orderId.toUpperCase()}` },
            
            // 5. ì–¸ë”ìŠ¤ì½”ì–´ ì œê±° ë²„ì „
            { orderId: orderId.replace(/_/g, '') },
            { inicisOrderId: orderId.replace(/_/g, '') },
            
            // 6. ì£¼ë¬¸ë²ˆí˜¸ 'order' ì ‘ë‘ì–´ ì¶”ê°€
            { orderId: `order${orderId}` },
            { inicisOrderId: `order${orderId}` }
          ];
          
          // í…ŒìŠ¤íŠ¸ìš© TID ê²€ìƒ‰
          const inicisTids = [
            'INIpayTest' // í…ŒìŠ¤íŠ¸ë§Œ ì‚¬ìš©, ì‘ë™í•˜ëŠ” ê²½ìš° ë” ì¶”ê°€ ê°€ëŠ¥
          ];
          
          // TID ê²€ìƒ‰ íŒŒë¼ë¯¸í„° ì¶”ê°€
          for (const tid of inicisTids) {
            searchVariations.push({ orderId: tid });
          }
          
          // ê²€ìƒ‰ ì‹œë„ ìƒíƒœ ë³€ìˆ˜ ìƒì„±
          let paymentFound = false;
          
          // ëª¨ë“  ê°€ëŠ¥í•œ í˜•ì‹ìœ¼ë¡œ ê²€ìƒ‰ ì‹œë„ (ì´ë‹ˆì‹œìŠ¤ ID)
          for (const searchParams of searchVariations) {
            if (!paymentFound) {
              console.log(`ê²€ìƒ‰ ì‹œë„: ${JSON.stringify(searchParams)}`);
              try {
                paymentsList = await portoneV2Client.searchPayments(searchParams);
                
                if (paymentsList?.payments && paymentsList.payments.length > 0) {
                  console.log(`ê²€ìƒ‰ í˜•ì‹ ${JSON.stringify(searchParams)}ë¡œ ê²°ì œ ì •ë³´ ì°¾ìŒ:`, paymentsList.payments[0]);
                  paymentFound = true;
                  break;
                }
              } catch (error) {
                console.error(`ê²€ìƒ‰ í˜•ì‹ ${JSON.stringify(searchParams)} ì¤‘ ì˜¤ë¥˜:`, error);
              }
            }
          }
          
          // ì´ë‹ˆì‹œìŠ¤ ê²°ì œ í‚¤/ë²ˆí˜¸ í˜•ì‹ (MOI3204387_20250504_00001)ë¡œ ê²€ìƒ‰ ì‹œë„
          if (!paymentFound) {
            const paymentIds = [
              'MOI3204387_20250504_00001',  // í™”ë©´ì— ë³´ì´ëŠ” ì •í™•í•œ ê²°ì œ í‚¤/ë²ˆí˜¸
              'MOI3204387',                 // ìƒì  ID
              'MOI3204387_20250504',        // ìƒì  ID + ë‚ ì§œ
              'MOI3204387_00001'            // ìƒì  ID + ìˆœë²ˆ
            ];
            
            for (const paymentId of paymentIds) {
              if (paymentFound) break;
              
              console.log(`ì´ë‹ˆì‹œìŠ¤ ê²°ì œ í‚¤/ë²ˆí˜¸(${paymentId})ë¡œ ê²€ìƒ‰ ì‹œë„...`);
              try {
                // 1. paymentKeyë¡œ ê²€ìƒ‰
                try {
                  const paymentInfo = await portoneV2Client.getPayment(paymentId);
                  console.log('ê²°ì œ í‚¤ë¡œ ì§ì ‘ ê²€ìƒ‰ ê²°ê³¼:', paymentInfo?.payment ? 'ì„±ê³µ' : 'ì‹¤íŒ¨');
                  if (paymentInfo?.payment) {
                    paymentsList = { payments: [paymentInfo.payment] };
                    paymentFound = true;
                    break;
                  }
                } catch (directError: any) {
                  console.log(`ê²°ì œ í‚¤(${paymentId}) ì§ì ‘ ê²€ìƒ‰ ì‹¤íŒ¨:`, directError.message);
                }
                
                // 2. ë‹¤ì–‘í•œ íŒŒë¼ë¯¸í„°ë¡œ ê²€ìƒ‰ ì‹œë„
                const searchResults = await portoneV2Client.searchPayments({
                  paymentKey: paymentId,
                  moid: paymentId,
                  tid: paymentId
                });
                
                if (searchResults?.payments && searchResults.payments.length > 0) {
                  console.log(`ì´ë‹ˆì‹œìŠ¤ ê²°ì œ í‚¤/ë²ˆí˜¸(${paymentId})ë¡œ ê²°ì œ ì •ë³´ ì°¾ìŒ: ${searchResults.payments.length}ê°œ`);
                  paymentsList = searchResults;
                  paymentFound = true;
                  break;
                }
              } catch (error) {
                console.error(`ì´ë‹ˆì‹œìŠ¤ ê²°ì œ í‚¤/ë²ˆí˜¸(${paymentId}) ê²€ìƒ‰ ì˜¤ë¥˜:`, error);
              }
            }
          }
            
          // ì´ë‹ˆì‹œìŠ¤ ìƒì  IDì™€ ë‚ ì§œ ì •ë³´ë¥¼ í™œìš©í•œ ê²€ìƒ‰
          if (!paymentFound) {
            console.log('ì´ë‹ˆì‹œìŠ¤ ìƒì  ID(MOI3204387)ì™€ ë‚ ì§œ ì¡°í•©ìœ¼ë¡œ ê²€ìƒ‰ ì‹œë„...');
            try {
              // ì´ë‹ˆì‹œìŠ¤ ê²°ì œ ë‚ ì§œ ê¸°ë°˜ ê²€ìƒ‰ (ë‚ ì§œ ë²”ìœ„ ì†Œí•˜ê²Œ ì„¤ì •)
              const orderDate = new Date(2025, 4, 8); // 2025ë…„ 5ì›” 8ì¼ (í™”ë©´ì— ë³´ì´ëŠ” ë‚ ì§œ)
              const startDate = new Date(orderDate);
              const endDate = new Date(orderDate);
              startDate.setDate(startDate.getDate() - 1); // í•˜ë£¨ ì „
              endDate.setDate(endDate.getDate() + 1);    // í•˜ë£¨ í›„
              
              paymentsList = await portoneV2Client.searchPayments({
                moid: 'MOI3204387',
                startDate: startDate.toISOString().split('T')[0],
                endDate: endDate.toISOString().split('T')[0],
                limit: 10
              });
              
              if (paymentsList?.payments && paymentsList.payments.length > 0) {
                console.log(`ì´ë‹ˆì‹œìŠ¤ ìƒì ë²ˆí˜¸ì™€ ë‚ ì§œë¡œ ê²°ì œ ì •ë³´ ì°¾ìŒ: ${paymentsList.payments.length}ê°œ`);
                paymentFound = true;
              }
            } catch (error) {
              console.error('ì´ë‹ˆì‹œìŠ¤ ìƒì ë²ˆí˜¸ì™€ ë‚ ì§œ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
            }
          }
            
          // ì •í™•í•œ ê¸ˆì•¡(1,000ì›)ìœ¼ë¡œ ê²€ìƒ‰ ì‹œë„
          if (!paymentFound) {
            console.log('ê¸ˆì•¡(1000ì›)ìœ¼ë¡œ ê²°ì œ ì •ë³´ ê²€ìƒ‰ ì‹œë„...');
            try {
              paymentsList = await portoneV2Client.searchPayments({
                amount: '1000'
              });
              
              if (paymentsList?.payments && paymentsList.payments.length > 0) {
                console.log(`ê¸ˆì•¡ìœ¼ë¡œ ê²°ì œ ì •ë³´ ì°¾ìŒ: ${paymentsList.payments.length}ê°œ`);
                paymentFound = true;
              }
            } catch (error) {
              console.error('ê¸ˆì•¡ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
            }
          }
            
          // ìµœê·¼ 3ì¼ ë‚´ ê²°ì œ ì „ì²´ ì¡°íšŒ ì¶”ê°€ (í•„í„° ì—†ì´)
          if (!paymentFound) {
            console.log('ê²°ì œ ì „ì²´ë¥¼ ì¡°íšŒí•˜ì—¬ í•„í„°ë§ ì‹œë„...');
            
            try {
              // 3ì¼ ì „ ë‚ ì§œ ê³„ì‚°
              const today = new Date();
              const threeDaysAgo = new Date();
              threeDaysAgo.setDate(today.getDate() - 3);
              
              const startDate = threeDaysAgo.toISOString().split('T')[0];
              const endDate = today.toISOString().split('T')[0];
              
              // ìƒíƒœë¥¼ ì§€ì •í•˜ì§€ ì•Šê³  ëª¨ë“  ìƒíƒœì˜ ê²°ì œë¥¼ ì¡°íšŒ (í˜ì´ì§€ í¬ê¸° ì¦ê°€)
              paymentsList = await portoneV2Client.searchPayments({
                startDate,
                endDate,
                limit: 50
              });
              
              if (paymentsList?.payments && paymentsList.payments.length > 0) {
                console.log(`ìµœê·¼ ê²°ì œ ë¦¬ìŠ¤íŠ¸ ${paymentsList.payments.length}ê°œ ì¡°íšŒë¨`);
                
                // ìˆœíšŒí•˜ë©´ì„œ ì„±ê³µí•œ ê²°ì œë§Œ ì¶”ì¶œ
                const successfulPayments = paymentsList.payments.filter((p: any) => 
                  p.status === 'DONE' || p.status === 'APPROVED');
                  
                console.log(`ì„±ê³µí•œ ê²°ì œ ${successfulPayments.length}ê°œ ë°œê²¬`);
                
                if (successfulPayments.length > 0) {
                  // ê¸ˆì•¡ì´ ë™ì¼í•œ ê²°ì œë§Œ í•„í„°ë§
                  const sameAmountPayments = successfulPayments.filter((p: any) => 
                    Number(p.amount?.total || 0) === Number(order.price || 0));
                    
                  if (sameAmountPayments.length > 0) {
                    console.log(`ë™ì¼ ê¸ˆì•¡ì˜ ê²°ì œ ${sameAmountPayments.length}ê°œ ë°œê²¬`);  
                    paymentsList = { payments: sameAmountPayments };
                    paymentFound = true;
                  } else {
                    // ê¸ˆì•¡ì´ ë™ì¼í•œ ê²ƒì´ ì—†ë‹¤ë©´ ê°€ì¥ ìµœê·¼ì— ì„±ê³µí•œ ê²ƒ ì„ íƒ
                    console.log('ë™ì¼ ê¸ˆì•¡ ê²°ì œê°€ ì—†ì–´ ìµœê·¼ ì„±ê³µ ê²°ì œ ì‚¬ìš©');
                    paymentsList = { payments: [successfulPayments[0]] };
                    paymentFound = true;
                  }
                }
              }
            } catch (e) {
              console.error('ì „ì²´ ê²°ì œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜:', e);
            }
          }
          
          if (!paymentFound) {
            console.log('ëª¨ë“  ê²€ìƒ‰ ë°©ë²•ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        }
        
        // ì—¬ì „íˆ ê²°ì œ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì˜¤ë¥˜ ë°˜í™˜
        if (!paymentsList || !paymentsList.payments || paymentsList.payments.length === 0) {
          return res.status(StatusCodes.NOT_FOUND).json({
            success: false,
            error: 'í¬íŠ¸ì› APIì—ì„œ ê²°ì œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
          });
        }
        
        const foundPaymentData = paymentsList.payments.find((p: any) => p.order_id === orderId);
        if (!foundPaymentData) {
          return res.status(StatusCodes.NOT_FOUND).json({
            success: false,
            error: 'ì£¼ë¬¸ IDì— í•´ë‹¹í•˜ëŠ” ê²°ì œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
          });
        }
        const paymentKey = foundPaymentData.payment_id;
        
        // ê²°ì œ ì •ë³´ ìƒì„¸ ì¡°íšŒ
        const paymentInfo = await portoneV2Client.getPayment(paymentKey);
        console.log('í¬íŠ¸ì› APIì—ì„œ ì¡°íšŒí•œ ê²°ì œ ì •ë³´:', paymentInfo);
        
        // ê²°ì œ ì •ë³´ê°€ ìˆëŠ”ì§€ í™•ì¸
        if (!paymentInfo.payment) {
          return res.status(StatusCodes.NOT_FOUND).json({
            success: false,
            error: 'í¬íŠ¸ì› APIì—ì„œ ê²°ì œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
          });
        }
        
        if (paymentInfo.payment.order_id !== orderId) {
          return res.status(StatusCodes.BAD_REQUEST).json({
            success: false,
            error: 'ì£¼ë¬¸ ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
            expected: orderId,
            actual: paymentInfo.payment.order_id
          });
        }
        
        // ê²°ì œ ì •ë³´ ìƒì„±
        const payment = await storage.createPayment({
          userId: order.userId,
          bidId: 0, // ì…ì°° ì •ë³´ê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ê°’
          paymentKey: paymentKey,
          orderId: orderId,
          orderName: 'ì£¼ë¬¸ ìƒí’ˆ',
          amount: order.price?.toString() || '0',
          status: 'DONE', // ì´ë¯¸ ì™„ë£Œëœ ê²°ì œ
          method: 'CARD',
          approvedAt: paymentInfo.payment.approved_at || new Date()
        });
        
        // ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸
        if (order.status === 'created' || order.status === 'ready') {
          await storage.updateOrderStatusByOrderId(orderId, 'paid');
        }
        
        return res.status(StatusCodes.CREATED).json({
          success: true,
          message: 'ê²°ì œ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.',
          payment
        });
        
      } catch (apiError: any) {
        console.error('í¬íŠ¸ì› API ì˜¤ë¥˜:', apiError);
        return res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
          success: false,
          error: 'í¬íŠ¸ì› APIì—ì„œ ê²°ì œ ì •ë³´ë¥¼ ì¡°íšŒí•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
          details: apiError.message
        });
      }
      
    } catch (error: any) {
      console.error('ê²°ì œ ì •ë³´ ìë™ ë™ê¸°í™” ì˜¤ë¥˜:', error);
      return res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
        success: false,
        error: error.message || 'ê²°ì œ ì •ë³´ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
      });
    }
  });
  
  // ê²°ì œ ì •ë³´ ë™ê¸°í™” ì—”ë“œí¬ì¸íŠ¸ (KG ì´ë‹ˆì‹œìŠ¤ ê²°ì œ ì •ë³´ ìˆ˜ë™ ì¶”ê°€ìš©)
  app.post('/api/payments/sync', async (req: Request, res: Response) => {
    if (!req.isAuthenticated()) {
      return res.status(StatusCodes.UNAUTHORIZED).json({
        success: false,
        error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }
    
    try {
      const { orderId, paymentKey } = req.body;
      
      if (!orderId || !paymentKey) {
        return res.status(StatusCodes.BAD_REQUEST).json({
          success: false,
          error: 'ì£¼ë¬¸ IDì™€ ê²°ì œ í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
        });
      }
      
      // ì£¼ë¬¸ ì •ë³´ ì¡°íšŒ
      const order = await storage.getOrderByOrderId(orderId);
      
      if (!order) {
        return res.status(StatusCodes.NOT_FOUND).json({
          success: false,
          error: 'ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
        });
      }
      
      // ê¸°ì¡´ ê²°ì œ ì •ë³´ í™•ì¸
      const existingPayment = await storage.getPaymentByOrderId(orderId);
      
      if (existingPayment) {
        return res.status(StatusCodes.CONFLICT).json({
          success: false,
          error: 'ì´ë¯¸ ê²°ì œ ì •ë³´ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.',
          payment: existingPayment
        });
      }
      
      // PortOne APIì—ì„œ ê²°ì œ ì •ë³´ ì¡°íšŒ
      try {
        const paymentInfo = await portoneV2Client.getPayment(paymentKey);
        console.log('í¬íŠ¸ì› APIì—ì„œ ì¡°íšŒí•œ ê²°ì œ ì •ë³´:', paymentInfo);
        
        // ê²°ì œ ì •ë³´ê°€ ìˆëŠ”ì§€ í™•ì¸
        if (!paymentInfo.payment) {
          return res.status(StatusCodes.NOT_FOUND).json({
            success: false,
            error: 'í¬íŠ¸ì› APIì—ì„œ ê²°ì œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
          });
        }
        
        // ì£¼ë¬¸ ë²ˆí˜¸ ì¼ì¹˜ ì—¬ë¶€ í™•ì¸
        if (paymentInfo.payment.order_id !== orderId) {
          return res.status(StatusCodes.BAD_REQUEST).json({
            success: false,
            error: 'ì£¼ë¬¸ ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
            expected: orderId,
            actual: paymentInfo.payment.order_id
          });
        }
        
        // ê²°ì œ ì •ë³´ ìƒì„±
        const payment = await storage.createPayment({
          userId: order.userId,
          bidId: 0, // ì…ì°° ì •ë³´ê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ê°’
          paymentKey: paymentKey,
          orderId: orderId,
          orderName: 'ì£¼ë¬¸ ìƒí’ˆ',
          amount: order.price?.toString() || '0',
          status: 'DONE', // ì´ë¯¸ ì™„ë£Œëœ ê²°ì œ
          method: 'CARD',
          approvedAt: paymentInfo.payment.approved_at || new Date()
        });
        
        // ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸
        if (order.status === 'created' || order.status === 'ready') {
          await storage.updateOrderStatusByOrderId(orderId, 'paid');
        }
        
        return res.status(StatusCodes.CREATED).json({
          success: true,
          message: 'ê²°ì œ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.',
          payment
        });
        
      } catch (apiError: any) {
        console.error('í¬íŠ¸ì› API ì˜¤ë¥˜:', apiError);
        return res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
          success: false,
          error: 'í¬íŠ¸ì› APIì—ì„œ ê²°ì œ ì •ë³´ë¥¼ ì¡°íšŒí•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
          details: apiError.message
        });
      }
      
    } catch (error: any) {
      console.error('ê²°ì œ ì •ë³´ ë™ê¸°í™” ì˜¤ë¥˜:', error);
      return res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
        success: false,
        error: error.message || 'ê²°ì œ ì •ë³´ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
      });
    }
  });
  
  // ê²°ì œ ì·¨ì†Œ ì—”ë“œí¬ì¸íŠ¸
  app.post('/api/payments/cancel', async (req: Request, res: Response) => {
    if (!req.isAuthenticated()) {
      return res.status(StatusCodes.UNAUTHORIZED).json({
        success: false,
        error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }
    
    try {
      const { paymentKey, cancelReason } = req.body;
      
      if (!paymentKey) {
        return res.status(StatusCodes.BAD_REQUEST).json({
          success: false,
          error: 'ìœ íš¨í•œ ê²°ì œ í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.'
        });
      }
      
      // ê²°ì œ ì·¨ì†Œ API í˜¸ì¶œ
      console.log(`ê²°ì œ ì·¨ì†Œ ì‹œë„: ${paymentKey}, ì‚¬ìœ : ${cancelReason}`);
      
      const cancelResponse = await portoneV2Client.cancelPayment({
        paymentId: paymentKey,
        reason: cancelReason || 'ê³ ê° ìš”ì²­ì— ì˜í•œ ì·¨ì†Œ'
      });
      
      // ì·¨ì†Œ í›„ DB ì—…ë°ì´íŠ¸
      const payment = await storage.getPaymentByKey(paymentKey);
      if (payment) {
        await storage.updatePaymentStatus(payment.id, 'cancelled');
        
        // ì£¼ë¬¸ ìƒíƒœ ì—…ë°ì´íŠ¸
        if (payment.orderId) {
          await storage.updateOrderStatusByOrderId(payment.orderId, 'cancelled');
        }
      }
      
      return res.status(StatusCodes.OK).json({
        success: true,
        message: 'ê²°ì œê°€ ì„±ê³µì ìœ¼ë¡œ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.',
        data: cancelResponse
      });
    } catch (error: any) {
      console.error('ê²°ì œ ì·¨ì†Œ ì˜¤ë¥˜:', error);
      
      return res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
        success: false,
        error: error.message || 'ê²°ì œ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
      });
    }
  });
  
  // í¬íŠ¸ì› V2 APIë¥¼ ì‚¬ìš©í•˜ì—¬ ê²°ì œ ì¤€ë¹„ (ê°„ì†Œí™”ëœ ë²„ì „)
  app.post('/api/payments/portone-prepare-simple', async (req: Request, res: Response) => {
    if (!req.isAuthenticated()) {
      return res.status(StatusCodes.UNAUTHORIZED).json({
        success: false,
        error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }
    
    try {
      const { bidId, orderId, productName, amount } = req.body;
      
      if (!orderId || !productName || !amount) {
        return res.status(StatusCodes.BAD_REQUEST).json({
          success: false,
          error: 'í•„ìˆ˜ ê²°ì œ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.'
        });
      }
      
      // í˜„ì¬ ì„œë²„ ë„ë©”ì¸ êµ¬í•˜ê¸°
      const host = req.headers.host || req.get('host') || '';
      const protocol = req.headers['x-forwarded-proto'] || 
                    (host.includes('localhost') ? 'http' : 'https');
      const baseUrl = `${protocol}://${host}`;
      
      // ë¦¬ë‹¤ì´ë ‰íŠ¸ URL ì„¤ì •
      const successUrl = `${baseUrl}/api/payments/success?orderId=${orderId}`;
      const failUrl = `${baseUrl}/api/payments/fail?orderId=${orderId}`;
      
      console.log('ê°„ì†Œí™”ëœ í¬íŠ¸ì› V2 API ê²°ì œ ì¤€ë¹„ ìš”ì²­:', {
        orderId,
        productName,
        amount,
        successUrl,
        failUrl
      });
      
      try {
        // êµ¬ë§¤ì ë° ìˆ˜ë ¹ì¸ ì •ë³´ ì²˜ë¦¬
        const { buyerInfo, recipientInfo } = req.body;
        
        console.log('êµ¬ë§¤ì ì •ë³´:', buyerInfo);
        console.log('ìˆ˜ë ¹ì¸ ì •ë³´:', recipientInfo);
        
        // V2 APIë¥¼ í†µí•´ ê²°ì œ ìƒì„±
        const paymentResponse = await portoneV2Client.createPayment({
          orderId,
          orderName: productName,
          amount: Number(amount),
          redirectUrl: {
            successUrl: successUrl,
            failUrl: failUrl
          },
          pgProvider: 'inicis_v2',
          channelKey: 'channel-key-5cdfe609-e895-41ae-9efd-d6a7d3148e79',
          customer: {
            name: buyerInfo?.name || req.user?.username || 'ê²ŒìŠ¤íŠ¸',
            email: req.user?.email || 'guest@example.com',
            phoneNumber: buyerInfo?.phone || ''
          },
          // ê²°ì œ ê´€ë ¨ ì¶”ê°€ ì •ë³´ (ìˆ˜ë ¹ì¸ ì •ë³´ í¬í•¨)
          orderShippingAddress: recipientInfo ? {
            name: recipientInfo.name,
            address: recipientInfo.address + (recipientInfo.addressDetail ? ` ${recipientInfo.addressDetail}` : ''),
            phoneNumber: recipientInfo.phone
          } : undefined
        });
        
        console.log('ê°„ì†Œí™”ëœ í¬íŠ¸ì› V2 API ê²°ì œ ìƒì„± ì„±ê³µ:', paymentResponse);
        
        // ì‚¬ìš©ì ID
        const userId = req.user!.id;
        
        // ì‹œìŠ¤í…œì— ê²°ì œ ì •ë³´ ì €ì¥
        const payment = await storage.createPayment({
          bidId: bidId || 0,
          userId,
          paymentKey: paymentResponse.payment?.id || '',
          orderId,
          orderName: productName,
          amount: amount.toString(),
          status: 'READY',
          method: 'CARD'
        });
        
        // ì²´í¬ì•„ì›ƒ URL í™•ì¸
        const checkoutUrl = paymentResponse.payment?.checkout_url || null;
        
        if (!checkoutUrl) {
          console.error('ê²°ì œ URLì´ ì—†ìŠµë‹ˆë‹¤!');
          return res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
            success: false,
            error: 'ê²°ì œ URLì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
          });
        }
        
        // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì‚¬ìš©í•˜ê¸° ì‰½ë„ë¡ ê°„ì†Œí™”ëœ ì‘ë‹µ ë°˜í™˜
        return res.json({
          success: true,
          paymentId: payment.id,
          orderId,
          orderName: productName,
          amount: amount.toString(),
          url: checkoutUrl
        });
        
      } catch (apiError: any) {
        console.error('í¬íŠ¸ì› V2 API í˜¸ì¶œ ì˜¤ë¥˜:', apiError.message);
        
        if (apiError.response) {
          console.error('í¬íŠ¸ì› V2 API ì˜¤ë¥˜ ì‘ë‹µ:', apiError.response.data);
        }
        
        return res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
          success: false,
          error: 'ê²°ì œ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (API ì˜¤ë¥˜)'
        });
      }
      
    } catch (error: any) {
      console.error('ê²°ì œ ì¤€ë¹„ ì˜¤ë¥˜:', error);
      return res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
        success: false,
        error: error instanceof Error ? error.message : 'ê²°ì œ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
      });
    }
  });
  
  // ê¸°ì¡´ í¬íŠ¸ì› V2 APIë¥¼ ì‚¬ìš©í•˜ì—¬ ê²°ì œ ì¤€ë¹„
  app.post('/api/payments/portone-v2/prepare', async (req: Request, res: Response) => {
    if (!req.isAuthenticated()) {
      return res.status(StatusCodes.UNAUTHORIZED).json({
        success: false,
        error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }
    
    try {
      const { bidId, orderId, productName, amount } = req.body;
      
      if (!orderId || !productName || !amount) {
        return res.status(StatusCodes.BAD_REQUEST).json({
          success: false,
          error: 'í•„ìˆ˜ ê²°ì œ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.'
        });
      }
      
      // í˜„ì¬ ì„œë²„ ë„ë©”ì¸ êµ¬í•˜ê¸°
      const host = req.headers.host || req.get('host') || '';
      const protocol = req.headers['x-forwarded-proto'] || 
                    (host.includes('localhost') ? 'http' : 'https');
      const baseUrl = `${protocol}://${host}`;
      
      // ë¦¬ë‹¤ì´ë ‰íŠ¸ URL ì„¤ì •
      const returnUrl = `${baseUrl}/api/payments/portone-v2/success?orderId=${orderId}&amount=${amount}`;
      
      console.log('í¬íŠ¸ì› V2 API ê²°ì œ ì¤€ë¹„ ìš”ì²­:', {
        orderId,
        productName,
        amount,
        returnUrl
      });
      
      try {
        // V2 APIë¥¼ í†µí•´ ê²°ì œ ìƒì„±
        const paymentResponse = await portoneV2Client.createPayment({
          orderId,
          orderName: productName,
          amount: Number(amount),
          returnUrl,
          flowMode: 'REDIRECT',
          payMethod: 'CARD',
          customer: {
            name: req.user?.username || 'ê²ŒìŠ¤íŠ¸',
            email: req.user?.email || 'guest@example.com'
          }
        });
        
        console.log('í¬íŠ¸ì› V2 API ê²°ì œ ìƒì„± ì„±ê³µ:', paymentResponse);
        
        // ì‚¬ìš©ì ID
        const userId = req.user!.id;
        
        // ì‹œìŠ¤í…œì— ê²°ì œ ì •ë³´ ì €ì¥
        const payment = await storage.createPayment({
          bidId: bidId || 0,
          userId,
          paymentKey: paymentResponse.payment?.id || '',
          orderId,
          orderName: productName,
          amount: amount.toString(),
          status: 'READY',
          method: 'CARD'
        });
        
        // ë¦¬ë‹¤ì´ë ‰íŠ¸ URLì´ ìˆëŠ”ì§€ í™•ì¸
        const redirectUrl = paymentResponse.payment?.checkout_url || null;
        
        // ì‘ë‹µ ë°ì´í„° ìƒì„±
        const responseData = {
          success: true,
          paymentId: payment.id,
          orderId,
          orderName: productName,
          amount: amount.toString(),
          clientKey: TOSS_PAYMENTS_TEST.clientKey,
          url: redirectUrl || ''
        };
        
        if (!redirectUrl) {
          console.error('ê²°ì œ URLì´ ì—†ìŠµë‹ˆë‹¤!');
        }
        
        // ì‘ë‹µ ë°˜í™˜
        res.json(responseData);
        
      } catch (apiError: any) {
        console.error('í¬íŠ¸ì› V2 API í˜¸ì¶œ ì˜¤ë¥˜:', apiError.response?.data || apiError.message);
        
        res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
          success: false,
          error: 'ê²°ì œ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (API ì˜¤ë¥˜)'
        });
      }
      
    } catch (error) {
      console.error('ê²°ì œ ì¤€ë¹„ ì˜¤ë¥˜:', error);
      res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
        success: false,
        error: error instanceof Error ? error.message : 'ê²°ì œ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
      });
    }
  });
  
  // ê²°ì œ ì„±ê³µ ì²˜ë¦¬
  app.get('/api/payments/portone-v2/success', async (req: Request, res: Response) => {
    const { orderId, paymentId, amount, conversationId, bidId } = req.query;
    
    if (!orderId || !paymentId) {
      return res.status(StatusCodes.BAD_REQUEST).json({
        error: 'í•„ìˆ˜ íŒŒë¼ë¯¸í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'
      });
    }
    
    try {
      // ê²°ì œ ì •ë³´ í™•ì¸
      const paymentInfo = await portoneV2Client.getPayment(paymentId as string);
      console.log('í¬íŠ¸ì› V2 API ê²°ì œ ì •ë³´ ì¡°íšŒ ì„±ê³µ:', paymentInfo);
      
      // ê²°ì œ ìƒíƒœ í™•ì¸
      if (paymentInfo.payment?.status !== 'PAID' && 
          paymentInfo.payment?.status !== 'READY' && 
          paymentInfo.payment?.status !== 'WAITING_FOR_PAYMENT') {
        return res.status(StatusCodes.BAD_REQUEST).json({
          error: 'ê²°ì œê°€ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'
        });
      }
      
      // ì£¼ë¬¸ë²ˆí˜¸ í™•ì¸
      if (paymentInfo.payment?.orderId !== orderId) {
        return res.status(StatusCodes.BAD_REQUEST).json({
          error: 'ì£¼ë¬¸ ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'
        });
      }
      
      // ê¸ˆì•¡ í™•ì¸ (ì„ íƒì‚¬í•­)
      if (amount && paymentInfo.payment?.amount?.total !== Number(amount)) {
        return res.status(StatusCodes.BAD_REQUEST).json({
          error: 'ê²°ì œ ê¸ˆì•¡ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'
        });
      }
      
      // ëŒ€í™”ë°© IDê°€ ìˆëŠ” ê²½ìš° ëŒ€í™”ì— ê²°ì œ ì™„ë£Œ ë©”ì‹œì§€ ì¶”ê°€
      if (conversationId && bidId) {
        try {
          // ì…ì°° ì •ë³´ ì¡°íšŒ
          const bid = await storage.getBidById(Number(bidId));
          
          if (bid) {
            // ìƒí’ˆ ì •ë³´ ì¶”ì¶œ
            const productName = bid.product?.name || 'êµ¬ë§¤í•œ ìƒí’ˆ';
            const price = paymentInfo.payment?.amount?.total || bid.price;
            
            // ê²°ì œ ì™„ë£Œ ë©”ì‹œì§€ ì‘ì„±
            const paymentMessage = {
              role: 'assistant',
              content: `ğŸ‰ ì£¼ë¬¸ ë° ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n\nìƒí’ˆëª…: ${productName}\nê²°ì œê¸ˆì•¡: â‚©${Number(price).toLocaleString()}\nì£¼ë¬¸ë²ˆí˜¸: ${orderId}\n\níŒë§¤ìê°€ ê³§ ì£¼ë¬¸ì„ í™•ì¸í•˜ê³  ì—°ë½ë“œë¦´ ì˜ˆì •ì…ë‹ˆë‹¤. êµ¬ë§¤í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.`,
              timestamp: new Date(),
              isPaymentComplete: true
            };
            
            // ëŒ€í™”ì— ë©”ì‹œì§€ ì¶”ê°€
            await storage.addMessageToConversation(Number(conversationId), paymentMessage);
            
            // ì…ì°° ìƒíƒœ ì—…ë°ì´íŠ¸
            await storage.updateBidStatus(Number(bidId), 'paid');
            
            console.log(`ê²°ì œ ì™„ë£Œ ë©”ì‹œì§€ê°€ ëŒ€í™” ${conversationId}ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          }
        } catch (error) {
          console.error('ê²°ì œ ì™„ë£Œ ë©”ì‹œì§€ ì¶”ê°€ ì‹¤íŒ¨:', error);
          // ë©”ì‹œì§€ ì¶”ê°€ ì‹¤íŒ¨í•´ë„ ê²°ì œ ì²˜ë¦¬ëŠ” ê³„ì† ì§„í–‰
        }
      }
      
      // ì‹œìŠ¤í…œì— ê²°ì œ ì •ë³´ ì—…ë°ì´íŠ¸
      const payment = await storage.getPaymentByOrderId(orderId as string);
      
      if (payment) {
        // ê¸°ì¡´ ê²°ì œ ì •ë³´ ì—…ë°ì´íŠ¸
        await storage.updatePaymentStatus(payment.id, 'DONE', paymentId as string);
      } else {
        // ìƒˆ ê²°ì œ ì •ë³´ ìƒì„±
        // ì£¼ì˜: bidId ë° userId ê°€ì ¸ì˜¤ê¸° ì–´ë ¤ì›€
        // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì ì ˆí•œ ì˜¤ë¥˜ ì²˜ë¦¬ í•„ìš”
        console.error('ê²°ì œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', orderId);
      }
      
      // ì„±ê³µ í˜ì´ì§€ ë Œë”ë§
      res.send(`
        <html>
          <head>
            <title>ê²°ì œ ì™„ë£Œ</title>
            <script>
              // ë¶€ëª¨ ì°½ìœ¼ë¡œ ê²°ì œ ì„±ê³µ ë©”ì‹œì§€ ì „ì†¡
              window.opener.postMessage({
                type: 'PAYMENT_SUCCESS',
                paymentKey: '${paymentId}',
                orderId: '${orderId}',
                amount: '${paymentInfo.payment?.amount?.total || 0}'
              }, window.location.origin);
              
              // ì ì‹œ í›„ ì°½ ë‹«ê¸°
              setTimeout(() => window.close(), 1000);
            </script>
            <style>
              body {
                font-family: Arial, sans-serif;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                height: 100vh;
                margin: 0;
                background-color: #f8f9fa;
              }
              .success-icon {
                width: 80px;
                height: 80px;
                border-radius: 50%;
                background-color: #4caf50;
                display: flex;
                justify-content: center;
                align-items: center;
                margin-bottom: 20px;
              }
              .success-icon svg {
                width: 40px;
                height: 40px;
                fill: white;
              }
              h1 {
                color: #333;
                margin-bottom: 10px;
              }
              p {
                color: #666;
                text-align: center;
              }
              .details {
                background-color: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                margin-top: 20px;
                width: 300px;
              }
            </style>
          </head>
          <body>
            <div class="success-icon">
              <svg viewBox="0 0 24 24">
                <path d="M9 16.17l-4.17-4.17-1.42 1.41 5.59 5.59 12-12-1.41-1.41z"></path>
              </svg>
            </div>
            <h1>ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</h1>
            <p>ê²°ì œ ì •ë³´ê°€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ì°½ì€ ì ì‹œ í›„ ìë™ìœ¼ë¡œ ë‹«í™ë‹ˆë‹¤.</p>
            <div class="details">
              <p><strong>ì£¼ë¬¸ë²ˆí˜¸:</strong> ${orderId}</p>
              <p><strong>ê²°ì œê¸ˆì•¡:</strong> ${(paymentInfo.payment?.amount?.total || 0).toLocaleString()}ì›</p>
            </div>
          </body>
        </html>
      `);
      
    } catch (error) {
      console.error('í¬íŠ¸ì› V2 API ê²°ì œ ì„±ê³µ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
      res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
        error: 'ê²°ì œ ì •ë³´ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
      });
    }
  });
  
  // ê²°ì œ ì‹¤íŒ¨ ì²˜ë¦¬
  app.get('/api/payments/portone-v2/fail', async (req: Request, res: Response) => {
    const { message, code } = req.query;
    
    // ì‹¤íŒ¨ í˜ì´ì§€ HTML ì§ì ‘ ë Œë”ë§
    res.send(`
      <html>
        <head>
          <title>ê²°ì œ ì‹¤íŒ¨</title>
          <script>
            // ë¶€ëª¨ ì°½ìœ¼ë¡œ ê²°ì œ ì‹¤íŒ¨ ë©”ì‹œì§€ ì „ì†¡
            window.opener.postMessage({
              type: 'PAYMENT_FAIL',
              message: '${message || 'ê²°ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'}',
              code: '${code || 'UNKNOWN_ERROR'}'
            }, window.location.origin);
            
            // ì ì‹œ í›„ ì°½ ë‹«ê¸°
            setTimeout(() => window.close(), 2000);
          </script>
          <style>
            body {
              font-family: Arial, sans-serif;
              display: flex;
              flex-direction: column;
              justify-content: center;
              align-items: center;
              height: 100vh;
              margin: 0;
              background-color: #f8f9fa;
            }
            .error-icon {
              width: 80px;
              height: 80px;
              border-radius: 50%;
              background-color: #f44336;
              display: flex;
              justify-content: center;
              align-items: center;
              margin-bottom: 20px;
            }
            .error-icon svg {
              width: 40px;
              height: 40px;
              fill: white;
            }
            h1 {
              color: #333;
              margin-bottom: 10px;
            }
            p {
              color: #666;
              text-align: center;
            }
            .error-details {
              background-color: white;
              padding: 20px;
              border-radius: 10px;
              box-shadow: 0 2px 10px rgba(0,0,0,0.1);
              margin-top: 20px;
              width: 300px;
            }
          </style>
        </head>
        <body>
          <div class="error-icon">
            <svg viewBox="0 0 24 24">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
            </svg>
          </div>
          <h1>ê²°ì œ ì‹¤íŒ¨</h1>
          <p>ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
          <div class="error-details">
            <p><strong>ì˜¤ë¥˜ ì½”ë“œ:</strong> ${code || 'UNKNOWN_ERROR'}</p>
            <p><strong>ì˜¤ë¥˜ ë©”ì‹œì§€:</strong> ${message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'}</p>
          </div>
        </body>
      </html>
    `);
  });
  
  // ê²°ì œ ì¡°íšŒ API
  app.get('/api/payments/portone-v2/:paymentId', async (req: Request, res: Response) => {
    if (!req.isAuthenticated()) {
      return res.status(StatusCodes.UNAUTHORIZED).json({
        success: false,
        error: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'
      });
    }
    
    try {
      const { paymentId } = req.params;
      
      // í¬íŠ¸ì› APIë¡œ ê²°ì œ ì •ë³´ ì¡°íšŒ
      const paymentInfo = await portoneV2Client.getPayment(paymentId);
      
      res.json({
        success: true,
        data: paymentInfo
      });
      
    } catch (error) {
      console.error('ê²°ì œ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
      res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
        success: false,
        error: error instanceof Error ? error.message : 'ê²°ì œ ì •ë³´ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
      });
    }
  });
}
