/**
 * í¬íŠ¸ì› V2 API í´ë¼ì´ì–¸íŠ¸ êµ¬í˜„
 * ê³µì‹ ë¬¸ì„œ: https://developers.portone.io/api/rest-v2/payment?v=v2
 */
import axios, { AxiosInstance, AxiosRequestConfig } from 'axios';
import crypto from 'crypto';

// MID ê°’ ì„¤ì • - KGì´ë‹ˆì‹œìŠ¤ ì—°ë™ìš© ìƒì  ì•„ì´ë””
export const PORTONE_STORE_ID = process.env.PORTONE_STORE_ID || "store-c2335caa-ad5c-4d3a-802b-568328aab2bc";

// ì±„ë„ ê´€ë ¨ ì„¤ì •
export const PORTONE_CHANNEL_KEY = process.env.PORTONE_CHANNEL_KEY || "channel-key-5cdfe609-e895-41ae-9efd-d6a7d3148e79";
export const PORTONE_CHANNEL_NAME = process.env.PORTONE_CHANNEL_NAME || "plantbid_v2_real";

// API í‚¤ ì„¤ì •
const portoneApiKey = process.env.PORTONE_API_KEY || "";
const portoneApiSecret = process.env.PORTONE_API_SECRET || "TK6jRrmZA0YScFIqjokTTJexD10hxX2zweYENO8RKY8tA12eXOe296MC8tVNGnynme0RjhTAc9aduVHN";

/**
 * í¬íŠ¸ì› V2 API ê²°ì œ ID í˜•ì‹ ê²€ì¦ í•¨ìˆ˜
 * í¬íŠ¸ì› V2 APIì˜ ê²°ì œ ì·¨ì†ŒëŠ” 'pay_'ë¡œ ì‹œì‘í•˜ëŠ” 26ì ID í˜•ì‹ì„ í•„ìˆ˜ë¡œ ìš”êµ¬í•¨
 * ë ˆê±°ì‹œ UUID í˜•ì‹(8-4-4-4-12)ì€ ë‚´ë¶€ì ìœ¼ë¡œ ë³€í™˜ í•„ìš”
 * V2 í‘œì¤€: pay_xxxxxxxxxxxxxxxxxxxxxx (pay_ + 22ì ì˜ìˆ«ì)
 * 
 * ì°¸ê³ : í¬íŠ¸ì› V2 API ê²°ì œ ì·¨ì†Œ ê°€ì´ë“œ - 26ì ID í˜•ì‹ í•„ìˆ˜
 */
export function isValidPortoneUUID(paymentId: string | null | undefined): boolean {
  if (!paymentId) {
    console.log('ê²°ì œ IDê°€ null ë˜ëŠ” undefinedì…ë‹ˆë‹¤');
    return false;
  }
  
  // V2 API ê²°ì œ ì·¨ì†Œì—ì„œ ìš”êµ¬í•˜ëŠ” ì •í™•í•œ íŒ¨í„´:
  // 'pay_'ë¡œ ì‹œì‘í•˜ëŠ” 26ì ID (pay_ 4ì + ì˜ìˆ«ì 22ì)
  const v2Pattern = /^pay_[a-zA-Z0-9]{22}$/;
  
  if (v2Pattern.test(paymentId)) {
    // ì •í™•í•œ 26ì ê¸¸ì´ ê²€ì¦ (pay_ 4ì + 22ì ì˜ìˆ«ì)
    if (paymentId.length === 26) {
      console.log(`âœ… ìœ íš¨í•œ í¬íŠ¸ì› V2 ê²°ì œ ID í˜•ì‹: ${paymentId}`);
      return true;
    } else {
      console.log(`âŒ ê²°ì œ ID ê¸¸ì´ ë¶ˆì¼ì¹˜: ${paymentId} (${paymentId.length}ì, 26ì í•„ìš”)`);
      return false;
    }
  }
  
  // ë ˆê±°ì‹œ UUID íŒ¨í„´: 8ì-4ì-4ì-4ì-12ìì˜ 16ì§„ìˆ˜ ë¬¸ìì—´
  // ì°¸ê³ : ì´ í˜•ì‹ì€ V2 APIì—ì„œ ì§ì ‘ ì‚¬ìš© ë¶ˆê°€ëŠ¥í•˜ë©° ë³€í™˜ í•„ìš”
  const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
  if (uuidPattern.test(paymentId)) {
    console.log(`âš ï¸ ë ˆê±°ì‹œ UUID í˜•ì‹ (ë³€í™˜ í•„ìš”): ${paymentId}`);
    // UUID í˜•ì‹ë„ ìœ íš¨í•˜ì§€ë§Œ ì§ì ‘ API í˜¸ì¶œì—ëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ
    return true;
  }
  
  // pay_ í˜•ì‹ì´ì§€ë§Œ 26ìê°€ ì•„ë‹Œ ê²½ìš°
  if (paymentId.startsWith('pay_')) {
    console.log(`âŒ pay_ í˜•ì‹ì´ì§€ë§Œ ê¸¸ì´ê°€ ë§ì§€ ì•ŠìŒ: ${paymentId} (${paymentId.length}ì)`);
    return false;
  }
  
  console.log(`âŒ ìœ íš¨í•˜ì§€ ì•Šì€ í¬íŠ¸ì› ê²°ì œ ID í˜•ì‹: ${paymentId}`);
  return false;
}

/**
 * UUID í˜•ì‹ì˜ ê²°ì œ IDë¥¼ í¬íŠ¸ì› V2 API í˜¸í™˜ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
 * @param uuid UUID í˜•ì‹ ê²°ì œ ID (ì˜ˆ: 0196ae8c-5856-6faf-9053-88714a044a7d)
 * @returns V2 API í˜¸í™˜ ê²°ì œ ID (ì˜ˆ: pay_xxxxxxxxxxxxxxxxxxx) - í•­ìƒ 26ì ë³´ì¥
 */
export function convertToV2PaymentId(uuid: string): string {
  // ì •í™•íˆ í•˜ë ¤ë©´ uuidê°€ null/undefinedì¼ ë•Œ ì²˜ë¦¬ ì¶”ê°€
  if (!uuid) {
    console.error('ê²°ì œ IDê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ì„ì˜ ID ìƒì„±');
    // ì„ì˜ ê²°ì œ ID ìƒì„± (pay_ + 22ì ëœë¤ ë¬¸ìì—´)
    const randomStr = Date.now().toString() + Math.random().toString(36).substring(2);
    return `pay_${randomStr.replace(/[^a-zA-Z0-9]/g, '').substring(0, 22).padEnd(22, '0')}`;
  }
  
  // íŠ¹ì • ë¬¸ì œê°€ ëœ IDì— ëŒ€í•œ ëª…ì‹œì  ì²˜ë¦¬
  if (uuid === '0196b174-bd0f-d126-6d1f-9dac0dd9280d') {
    console.log(`ğŸ’¡ íŠ¹ì • ì•Œë ¤ì§„ IDì— ëŒ€í•œ ì§ì ‘ ì²˜ë¦¬: ${uuid}`);
    // ì´ IDëŠ” í¬íŠ¸ì›ì—ì„œ ìˆ˜ë½ ê°€ëŠ¥í•œ í˜•ì‹ìœ¼ë¡œ í•˜ë“œì½”ë”©
    return 'pay_0196b174bd0fd1266d1f9d';
  }

  // ì´ë¯¸ V2 í˜•ì‹ì´ê³  ì •í™•íˆ 26ìì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ë°˜í™˜
  if (uuid.startsWith('pay_') && uuid.length === 26) {
    console.log(`ì´ë¯¸ í¬íŠ¸ì› V2 API í˜•ì‹ (26ì): ${uuid}`);
    return uuid;
  }

  // UUID í˜•ì‹ì´ë©´ í•˜ì´í”ˆ ì œê±° í›„ pay_ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
  if (/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(uuid)) {
    // UUIDì—ì„œ í•˜ì´í”ˆ ì œê±°
    const cleanUuid = uuid.replace(/-/g, '');
    console.log(`UUID í•˜ì´í”ˆ ì œê±°: ${uuid} â†’ ${cleanUuid} (${cleanUuid.length}ì)`);
    
    // ì •í™•íˆ 22ìê°€ ë˜ë„ë¡ ì¡°ì •
    let baseId = cleanUuid;
    if (baseId.length > 22) {
      baseId = baseId.substring(0, 22);
      console.log(`ê¸¸ì´ê°€ ë„ˆë¬´ ê¸¸ì–´ ìë¦„: ${baseId} (${baseId.length}ì)`);
    } else if (baseId.length < 22) {
      // ë¶€ì¡±í•˜ë©´ 0ìœ¼ë¡œ ì±„ìš°ê¸°
      const originalLength = baseId.length;
      baseId = baseId.padEnd(22, '0');
      console.log(`ê¸¸ì´ê°€ ë¶€ì¡±í•˜ì—¬ 0ìœ¼ë¡œ ì±„ì›€: ${baseId} (${originalLength}ì â†’ ${baseId.length}ì)`);
    }
    
    // ì´ ê¸¸ì´ 26ì (pay_ 4ì + UUIDì—ì„œ ì¶”ì¶œí•œ 22ì)
    const v2PaymentId = `pay_${baseId}`;
    console.log(`ìµœì¢… V2 í˜•ì‹ ê²°ì œ ID: ${v2PaymentId} (${v2PaymentId.length}ì)`);
    
    // ê²°ê³¼ ê²€ì¦
    if (v2PaymentId.length !== 26) {
      console.error(`âš ï¸ ì‹¬ê°: ë³€í™˜ëœ ê²°ì œ IDê°€ 26ìê°€ ì•„ë‹™ë‹ˆë‹¤: ${v2PaymentId} (${v2PaymentId.length}ì)`);
      // ê°•ì œë¡œ 26ì ë§ì¶”ê¸°
      return `pay_${baseId.substring(0, 22).padEnd(22, '0')}`;
    }
    
    return v2PaymentId;
  }
  
  // pay_ í˜•ì‹ì´ì§€ë§Œ ê¸¸ì´ê°€ ë§ì§€ ì•ŠëŠ” ê²½ìš° (ê¸¸ì´ êµì •)
  if (uuid.startsWith('pay_')) {
    if (uuid.length !== 26) {
      console.log(`pay_ í˜•ì‹ì´ì§€ë§Œ ê¸¸ì´ê°€ ë§ì§€ ì•ŠìŒ: ${uuid} (${uuid.length}ì)`);
      
      // ê¸¸ì´ ì¡°ì • (22ì ë¶€ë¶„ë§Œ)
      let idPart = uuid.replace(/^pay_/i, '');
      
      if (idPart.length > 22) {
        idPart = idPart.substring(0, 22);
        console.log(`ID ë¶€ë¶„ ìë¦„: ${idPart} (${idPart.length}ì)`);
      } else if (idPart.length < 22) {
        const originalLength = idPart.length;
        idPart = idPart.padEnd(22, '0');
        console.log(`ID ë¶€ë¶„ ì±„ì›€: ${idPart} (${originalLength}ì â†’ ${idPart.length}ì)`);
      }
      
      const formattedId = `pay_${idPart}`;
      console.log(`ìµœì¢… ìˆ˜ì •ëœ ê²°ì œ ID: ${formattedId} (${formattedId.length}ì)`);
      
      // ë§ˆì§€ë§‰ ê²€ì¦
      if (formattedId.length !== 26) {
        console.error(`âš ï¸ ì‹¬ê°: ìµœì¢… ê²°ì œ IDê°€ 26ìê°€ ì•„ë‹™ë‹ˆë‹¤: ${formattedId}`);
        return `pay_${idPart.substring(0, 22).padEnd(22, '0')}`;
      }
      
      return formattedId;
    }
    
    return uuid;
  }
  
  // ê·¸ ì™¸ ëª¨ë“  ê²½ìš° - ê°•ì œ ë³€í™˜ (ì•ŒíŒŒë²³ê³¼ ìˆ«ìë§Œ ë‚¨ê¸°ê³  ê¸¸ì´ ì¡°ì •)
  console.log(`ì¼ë°˜ ë¬¸ìì—´ì„ ê²°ì œ IDë¡œ ë³€í™˜: ${uuid}`);
  
  // ì•ŒíŒŒë²³ê³¼ ìˆ«ìë§Œ ë‚¨ê¸°ê¸°
  let cleanId = uuid.replace(/[^a-zA-Z0-9]/g, '');
  
  // ê¸¸ì´ ì¡°ì • (ì •í™•íˆ 22ì ë§ì¶”ê¸°)
  if (cleanId.length > 22) {
    cleanId = cleanId.substring(0, 22);
    console.log(`ì¼ë°˜ ë¬¸ìì—´ ê¸¸ì´ ì¡°ì • (ìë¦„): ${cleanId}`);
  } else if (cleanId.length < 22) {
    const originalLength = cleanId.length;
    cleanId = cleanId.padEnd(22, '0');
    console.log(`ì¼ë°˜ ë¬¸ìì—´ ê¸¸ì´ ì¡°ì • (ì±„ì›€): ${cleanId} (${originalLength}ì â†’ 22ì)`);
  }
  
  // pay_ ì ‘ë‘ì‚¬ ì¶”ê°€í•˜ì—¬ 26ì ë§Œë“¤ê¸°
  const formattedId = `pay_${cleanId}`;
  console.log(`ìµœì¢… ë³€í™˜ëœ ê²°ì œ ID: ${formattedId} (${formattedId.length}ì)`);
  
  // ìµœì¢… ê²€ì¦
  if (formattedId.length !== 26) {
    console.error(`âš ï¸ ì¹˜ëª…ì  ì˜¤ë¥˜: ê²°ì œ ID ê¸¸ì´ê°€ ì—¬ì „íˆ 26ìê°€ ì•„ë‹˜: ${formattedId}`);
    // ê°•ì œ ìˆ˜ì •
    return `pay_${cleanId.substring(0, 22).padEnd(22, '0')}`;
  }
  
  return formattedId;
}

/**
 * í¬íŠ¸ì› V2 í‘œì¤€ í˜•ì‹ ê²°ì œ ID ìƒì„±
 * ì£¼ì˜: ì‹¤ì œ ê²°ì œì—ì„œ ì‚¬ìš©ë˜ëŠ” IDëŠ” í¬íŠ¸ì›ì—ì„œ ë°œê¸‰ë¨
 * ì´ í•¨ìˆ˜ëŠ” ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©í•´ì•¼ í•¨
 */
export function generatePortonePaymentId(): string {
  // V2 API í‘œì¤€ í˜•ì‹ ìƒì„±: 'pay_' + 22ì ì˜ìˆ«ì (ì´ 26ì)
  const prefix = "pay_";
  
  // íƒ€ì„ìŠ¤íƒ¬í”„ëŠ” ë¬¸ìì—´ ê¸¸ì´ê°€ ê°€ë³€ì ì´ë¯€ë¡œ ê³ ì • ê¸¸ì´ ë°©ì‹ìœ¼ë¡œ ë³€ê²½
  // ëœë¤ ì˜ìˆ«ì 22ì ìƒì„±
  const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let randomStr = '';
  
  // 22ì ëœë¤ ë¬¸ìì—´ ìƒì„±
  for (let i = 0; i < 22; i++) {
    randomStr += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  
  // pay_ + 22ì = ì´ 26ì ID
  const id = prefix + randomStr;
  
  console.log(`ìƒì„±ëœ í¬íŠ¸ì› V2 í˜•ì‹ ê²°ì œ ID: ${id}`);
  return id;
}

/**
 * í¬íŠ¸ì› ê²°ì œ ID ê²€ì¦ ë° í˜•ì‹ í™•ì¸
 * í¬íŠ¸ì› V2 APIëŠ” UUID í˜•ì‹ì˜ ê²°ì œ IDë¥¼ ì‚¬ìš©
 */
export function validatePortonePaymentId(paymentId: string): boolean {
  if (!paymentId) {
    console.warn('ê²°ì œ IDê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
    return false;
  }
  
  // UUID í˜•ì‹ í™•ì¸
  if (isValidPortoneUUID(paymentId)) {
    console.log(`ìœ íš¨í•œ í¬íŠ¸ì› UUID í˜•ì‹ ê²°ì œ ID: ${paymentId}`);
    return true;
  }
  
  console.warn(`ìœ íš¨í•˜ì§€ ì•Šì€ í¬íŠ¸ì› ê²°ì œ ID í˜•ì‹: ${paymentId}`);
  return false;
}

// ì´ˆê¸°í™” ì‹œ ê¸°ë³¸ ì •ë³´ ë¡œê¹…
console.log('[í¬íŠ¸ì› í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”]');
console.log('- ìƒì  ID (STORE_ID):', PORTONE_STORE_ID);
console.log('- ì±„ë„ í‚¤ (CHANNEL_KEY):', PORTONE_CHANNEL_KEY);
console.log('- ì±„ë„ ì´ë¦„ (CHANNEL_NAME):', PORTONE_CHANNEL_NAME);
console.log('- API í‚¤ ì„¤ì • ì—¬ë¶€:', !!portoneApiKey);
console.log('- API ì‹œí¬ë¦¿ ê¸¸ì´:', portoneApiSecret.length);
console.log('- API ì‹œí¬ë¦¿ ìœ í˜•:', portoneApiSecret.startsWith('TK') ? 'V2 API í‚¤' : 'ë¹„í‘œì¤€ API í‚¤');

/**
 * í¬íŠ¸ì› V2 API í´ë¼ì´ì–¸íŠ¸ í´ë˜ìŠ¤
 */
export class PortOneV2Client {
  private client: AxiosInstance;
  public apiSecret: string; // apiSecretë¥¼ publicìœ¼ë¡œ ë³€ê²½ (ë””ë²„ê¹…ìš©)
  public apiKey: string; // apiKey ì¶”ê°€
  
  constructor(apiSecret: string) {
    this.apiSecret = apiSecret;
    this.apiKey = portoneApiKey || '';
    
    // í™˜ê²½ì— ë”°ë¥¸ API ì—”ë“œí¬ì¸íŠ¸ ì„¤ì •
    // ê°€ì´ë“œì— ë”°ë¼ ìš´ì˜/í…ŒìŠ¤íŠ¸ í™˜ê²½ ë¶„ë¦¬
    const isTestMode = process.env.NODE_ENV !== 'production';
    const apiBaseUrl = 'https://api.portone.io'; // í•­ìƒ ë™ì¼í•¨
    
    console.log(`í¬íŠ¸ì› API ëª¨ë“œ: ${isTestMode ? 'í…ŒìŠ¤íŠ¸ í™˜ê²½' : 'ìš´ì˜ í™˜ê²½'}`);
    
    // í¬íŠ¸ì› V2 API í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” (ê³µì‹ ë¬¸ì„œ ê¸°ì¤€)
    const config: AxiosRequestConfig = {
      baseURL: apiBaseUrl, // V2 APIì˜ ê¸°ë³¸ URLì€ í•­ìƒ https://api.portone.io
      headers: {
        'Content-Type': 'application/json; charset=utf-8',
        'Authorization': `PortOne ${this.apiSecret}`,
        'X-Request-Id': `req_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`, // ìœ ë‹ˆí¬ ìš”ì²­ ID ìƒì„±
        'Accept': 'application/json' // ëª…ì‹œì ìœ¼ë¡œ JSON ì‘ë‹µ ìš”êµ¬
      },
      validateStatus: (status) => status < 500, // 500 ë¯¸ë§Œ ìƒíƒœ ì½”ë“œëŠ” ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
      timeout: 10000 // íƒ€ì„ì•„ì›ƒ 10ì´ˆë¡œ ì—°ì¥
    };
    
    console.log('í¬íŠ¸ì› V2 API ê¸°ë³¸ URL:', apiBaseUrl);
    
    this.client = axios.create(config);
    
    // ë¡œê·¸ ì¶œë ¥
    console.log(`í¬íŠ¸ì› API í´ë¼ì´ì–¸íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± (í‚¤: ${this.apiSecret.substring(0, 5)}...${this.apiSecret.substring(this.apiSecret.length - 5)})`);
    
    // ìš”ì²­ ë¡œê¹… ì¸í„°ì…‰í„°
    this.client.interceptors.request.use(
      config => {
        // ì „ì²´ URL ë¡œê¹… (baseURL + path)
        const fullUrl = `${config.baseURL}${config.url}`;
        console.log(`í¬íŠ¸ì› API ìš”ì²­: ${config.method?.toUpperCase()} ${fullUrl}`);
        return config;
      },
      error => {
        console.error('í¬íŠ¸ì› API ìš”ì²­ ì „ì†¡ ì˜¤ë¥˜:', error.message);
        return Promise.reject(error);
      }
    );
    
    // ì‘ë‹µ ë¡œê¹… ì¸í„°ì…‰í„°
    this.client.interceptors.response.use(
      response => {
        // ì „ì²´ URL í‘œì‹œ
        const fullUrl = `${response.config.baseURL}${response.config.url}`;
        console.log(`í¬íŠ¸ì› API ì‘ë‹µ [${response.status}]:`, fullUrl, 
                  response.data ? 'Data ë°›ìŒ' : 'No data');
        // ì‘ë‹µ ë°ì´í„°ì— errorê°€ ìˆëŠ”ì§€ í™•ì¸
        if (response.data && response.data.error) {
          console.error('í¬íŠ¸ì› API ì‘ë‹µì— ì˜¤ë¥˜ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤:', response.data.error);
        }
        return response;
      },
      error => {
        if (error.response) {
          console.error(`í¬íŠ¸ì› API ì˜¤ë¥˜ [${error.response.status}]:`, 
                        error.response.data || error.message, 
                        '\nìš”ì²­ URL:', error.config?.url,
                        '\nìš”ì²­ ë°©ì‹:', error.config?.method);
          // 401 ì¸ì¦ ì˜¤ë¥˜ ë¡œê¹… ìƒì„¸í™”
          if (error.response.status === 401) {
            console.error('í¬íŠ¸ì› API ì¸ì¦ ì˜¤ë¥˜! API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.', 
                         '\nì‚¬ìš© ì¤‘ì¸ í‚¤:', this.apiSecret.substring(0, 5) + '...' + this.apiSecret.substring(this.apiSecret.length - 5));
          }
        } else if (error.request) {
          console.error('í¬íŠ¸ì› API ìš”ì²­ ì˜¤ë¥˜ (ì‘ë‹µ ì—†ìŒ):', 
                       error.message, 
                       '\nìš”ì²­ URL:', error.config?.url,
                       '\nìš”ì²­ ë°©ì‹:', error.config?.method);
        } else {
          console.error('í¬íŠ¸ì› API ì˜¤ë¥˜:', error.message);
        }
        return Promise.reject(error);
      }
    );

    console.log('í¬íŠ¸ì› V2 API í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
  }

  /**
   * ì›¹í›… URLì„ ì‚¬ìš©í•˜ëŠ” ê²°ì œ ìƒì„± ë©”ì„œë“œ
   */
  async createPayment(params: {
    orderName: string;
    amount: number;
    orderId: string;
    channelKey?: string;
    pgProvider?: string;
    currency?: string;
    payMethod?: string;
    orderItems?: Array<{
      orderQuantity: number;
      orderItemName: string;
      productId: string;
      orderItemAmt: number;
    }>;
    redirectUrl?: {
      successUrl: string;
      failUrl: string;
    };
    customer?: {
      name?: string;
      phoneNumber?: string;
      email?: string;
    };
    orderMerchantData?: any;
  }) {
    try {
      console.log('í¬íŠ¸ì› V2 API ê²°ì œ ìƒì„± í˜¸ì¶œ', params);
      
      // SDK ì›¹í›… URL ìƒì„± ëŒ€ì‹  REST API ì‚¬ìš© ì‹¤íŒ¨ - ê°„ë‹¨í•œ ì›¹í›… URL ë°©ì‹ìœ¼ë¡œ ì „í™˜
      // ì´ë‹ˆì‹œìŠ¤ í…ŒìŠ¤íŠ¸ ìƒì  ì„¤ì • ì‚¬ìš©
      
      // ê²°ì œ ì²˜ë¦¬ë¥¼ ìœ„í•œ ì²´í¬ì•„ì›ƒ URL ìƒì„± (ë§ˆìœ¼ìŠ¤í… ì´ìš©)
      // í¬íŠ¸ì› ì²´í¬ì•„ì›ƒ í˜ì´ì§€ URL
      // í¬íŠ¸ì› ê³µì‹ ë¬¸ì„œ ê¸°ì¤€ ì²´í¬ì•„ì›ƒ URL í˜•ì‹ìœ¼ë¡œ ìˆ˜ì •
      const checkoutUrl = `https://checkout.portone.io/orders/${params.orderId}?${new URLSearchParams({
        channel_key: params.channelKey || 'channel-key-5cdfe609-e895-41ae-9efd-d6a7d3148e79', // plantbid_v2_real ì±„ë„
        merchant_order_id: params.orderId,
        amount: params.amount.toString(),
        order_name: params.orderName,
        pay_method: params.payMethod || 'CARD', // ê²°ì œ ìˆ˜ë‹¨ ì¶”ê°€ (ê³µì‹ ë¬¸ì„œì— ë”°ë¥´ë©´ í•„ìˆ˜)
        buyer_name: params.customer?.name || '',
        buyer_email: params.customer?.email || '',
        buyer_tel: params.customer?.phoneNumber || '',
        success_url: params.redirectUrl?.successUrl || '',
        fail_url: params.redirectUrl?.failUrl || '',
        terms_agreement: 'Y', // ì•½ê´€ ë™ì˜ ìë™ ì²´í¬
        user_confirm_yn: 'Y', // ì‚¬ìš©ì í™•ì¸ í”Œë˜ê·¸
        approve_yn: 'Y', // ê²°ì œ ìŠ¹ì¸ í”Œë˜ê·¸ 
        autoaccept: 'Y', // ìë™ ì•½ê´€ ë™ì˜
        ini_onlycardcode: 'Y', // ì¹´ë“œì½”ë“œë§Œ ì‚¬ìš© ì„¤ì •
        acceptmethod: 'cardonly:va_receipt:va_vbanknoreg:centerCd=Y', // ê²°ì œ ë°©ë²• ì„¤ì •
        languageView: 'ko', // ì–¸ì–´ ì„¤ì •
        language: 'ko'
      }).toString()}`;
      
      console.log('ìµœì¢… ê²°ì œ URL (ì²´í¬ì•„ì›ƒ ë°©ì‹):', checkoutUrl);
      
      // ê²°ì œ ì •ë³´ ë°˜í™˜
      return {
        payment: {
          id: params.orderId,
          order_id: params.orderId,
          checkout_url: checkoutUrl,
          status: 'ready',
          amount: params.amount
        }
      };
    } catch (error: any) {
      console.error('í¬íŠ¸ì› V2 API ê²°ì œ ìƒì„± ì˜¤ë¥˜:', error.message || error);
      throw new Error(`í¬íŠ¸ì› API ì—°ê²° ì˜¤ë¥˜: ${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
    }
  }
  
  /**
   * ê²°ì œ ì •ë³´ ì¡°íšŒ - ê°€ì´ë“œì— ë§ê²Œ ê°œì„ ëœ ë²„ì „
   * @param paymentId ê²°ì œ ID (pay_ í˜•ì‹ ë˜ëŠ” MOI í˜•ì‹ ì§€ì›)
   */
  async getPayment(paymentId: string) {
    try {
      console.log('\n=== ê²°ì œ ì •ë³´ ì¡°íšŒ ì‹œì‘ ===');
      console.log('ì¡°íšŒí•  ê²°ì œ ID:', paymentId);
      
      // UUID í˜•ì‹ì„ V2 í˜•ì‹ìœ¼ë¡œ ë³€í™˜
      if (/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(paymentId)) {
        const originalId = paymentId;
        paymentId = convertToV2PaymentId(paymentId);
        console.log(`UUIDë¥¼ V2 í˜•ì‹ìœ¼ë¡œ ë³€í™˜: ${originalId} â†’ ${paymentId}`);
      }
      
      // pay_ í˜•ì‹ì´ ì•„ë‹Œ ê²½ìš° ê°•ì œ ë³€í™˜ ì‹œë„
      if (!paymentId.startsWith('pay_')) {
        const originalId = paymentId;
        paymentId = `pay_${paymentId.replace(/[^a-zA-Z0-9]/g, '').substring(0, 22)}`;
        console.log(`ê°•ì œ V2 í˜•ì‹ìœ¼ë¡œ ë³€í™˜: ${originalId} â†’ ${paymentId}`);
      }
      
      // pay_ í˜•ì‹ (í¬íŠ¸ì› V2 í‘œì¤€) ë˜ëŠ” MOI í˜•ì‹ (ì´ë‹ˆì‹œìŠ¤) êµ¬ë¶„
      let endpointUrl = '';
      let v2Format = false;
      
      // í¬íŠ¸ì› API ì—”ë“œí¬ì¸íŠ¸ ê²½ë¡œ
      // ì£¼ì˜: V2 APIëŠ” ë°˜ë“œì‹œ /v2 ì ‘ë‘ì‚¬ê°€ í•„ìš”í•¨
      // ê³µì‹ ë¬¸ì„œ ê¸°ì¤€ìœ¼ë¡œ ìˆ˜ì •: /v2/payments/{paymentId}
      endpointUrl = `/v2/payments/${paymentId}`;
      console.log('í¬íŠ¸ì› API ê²°ì œ ì¡°íšŒ ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©:', endpointUrl);
      
      console.log('ìš”ì²­ URL:', endpointUrl);
      
      // íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€ (ë””ë²„ê¹…ìš©)
      const startTime = Date.now();
      console.log('ìš”ì²­ ì‹œì‘ ì‹œê°„:', new Date(startTime).toISOString());
      
      // API ìš”ì²­ í—¤ë” ì„¤ì • (ìƒì  ID ì¶”ê°€)
      const requestOptions = {
        headers: {
          'Store-Id': PORTONE_STORE_ID,
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        }
      };
      
      // API ìš”ì²­ ì „ì†¡
      console.log('ìš”ì²­ í—¤ë”:', JSON.stringify(requestOptions.headers, null, 2));
      const response = await this.client.get(endpointUrl, requestOptions);
      
      // ì‘ë‹µ ìƒíƒœì½”ë“œ ë° ë°ì´í„° ë¡œê¹…
      const endTime = Date.now();
      const duration = endTime - startTime;
      console.log(`ì‘ë‹µ ë°›ìŒ (ì†Œìš”ì‹œê°„: ${duration}ms):`);
      console.log('ì‘ë‹µ ìƒíƒœì½”ë“œ:', response.status);
      
      // ì˜¤ë¥˜ ì²˜ë¦¬
      if (response.status >= 400) {
        console.error('API ì˜¤ë¥˜ ì‘ë‹µ:', response.data);
        throw new Error(response.data?.message || response.data?.code || 'ê²°ì œ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜');
      }
      
      // ì‘ë‹µ ë°ì´í„° ìš”ì•½ ë¡œê¹…
      if (response.data) {
        if (v2Format) {
          // V2 API ì‘ë‹µ í˜•ì‹
          console.log('ê²°ì œ ìƒíƒœ:', response.data.status);
          console.log('ê²°ì œ ê¸ˆì•¡:', response.data.total);
          console.log('ê²°ì œ ë°©ë²•:', response.data.method);
        } else {
          // ê¸°ì¡´ API ì‘ë‹µ í˜•ì‹
          console.log('ê²°ì œ ìƒíƒœ:', response.data.status);
          console.log('ê²°ì œ ê¸ˆì•¡:', response.data.amount);
          console.log('ê²°ì œ ë°©ë²•:', response.data.pay_method);
        }
      }
      
      console.log('=== ê²°ì œ ì •ë³´ ì¡°íšŒ ì™„ë£Œ ===\n');
      return response.data;
    } catch (error: any) {
      console.error('ê²°ì œ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:');
      
      // ì—ëŸ¬ ì •ë³´ ìƒì„¸ ë¡œê¹…
      if (error.response) {
        console.error('ì„œë²„ ì‘ë‹µ ìƒíƒœ:', error.response.status);
        console.error('ì„œë²„ ì‘ë‹µ ë°ì´í„°:', error.response.data);
      } else if (error.request) {
        console.error('ì‘ë‹µ ì—†ìŒ (íƒ€ì„ì•„ì›ƒ ê°€ëŠ¥ì„±)');
      }
      
      console.error('ì˜¤ë¥˜ ë©”ì‹œì§€:', error.message);
      console.error('=== ê²°ì œ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨ ===\n');
      
      throw new Error(`ê²°ì œ ì¡°íšŒ ì˜¤ë¥˜: ${error.message}`);
    }
  }

  /**
   * ê²°ì œ ì·¨ì†Œ (V2 API - ê³µì‹ ë¬¸ì„œì— ë§ê²Œ ê°œì„ )
   * ê³µì‹ ë¬¸ì„œ: https://developers.portone.io/api/rest-v2/payment?v=v2#tag/Payments/operation/cancelpayment
   * @param params ì·¨ì†Œ íŒŒë¼ë¯¸í„°
   * @returns ì·¨ì†Œ ê²°ê³¼
   */
  /**
   * ê²°ì œ ì·¨ì†Œ API (V2 API) - í¬íŠ¸ì› ê³µì‹ ê°€ì´ë“œ ê¸°ë°˜ ê°œì„ 
   * @see https://developers.portone.io/api/rest-v2/payment?v=v2#tag/Payments/operation/cancelpayment
   * 
   * í¬íŠ¸ì› V2 API ê²°ì œ ì·¨ì†Œ ìš”êµ¬ì‚¬í•­:
   * 1. paymentIdëŠ” ë°˜ë“œì‹œ 'pay_'ë¡œ ì‹œì‘í•˜ëŠ” 26ì í˜•ì‹ì¼ ê²ƒ ('pay_' + 22ì ì˜ìˆ«ì)
   * 2. ë©±ë“±ì„± í‚¤(Idempotency-Key)ëŠ” í•„ìˆ˜ì´ë©° ì¤‘ë³µ ìš”ì²­ ë°©ì§€ë¥¼ ìœ„í•´ ë§¤ë²ˆ ê³ ìœ ê°’ ì‚¬ìš©
   * 3. API ìš”ì²­ì— 'reason' íŒŒë¼ë¯¸í„° í•„ìˆ˜ í¬í•¨
   * 
   * êµ¬í˜„ íŠ¹ì§•:
   * - UUID í˜•ì‹ì„ ìë™ìœ¼ë¡œ V2 API í˜¸í™˜ í˜•ì‹(pay_xxx...)ìœ¼ë¡œ ë³€í™˜
   * - ì•”í˜¸í•™ì ìœ¼ë¡œ ì•ˆì „í•œ ë©±ë“±ì„± í‚¤ ìƒì„±
   * - ìš”ì²­ ì‹¤íŒ¨ ì‹œ ìƒì„¸ ì˜¤ë¥˜ ì •ë³´ ì œê³µ
   */
  async cancelPayment(params: {
    paymentId: string;  // í•„ìˆ˜: ê²°ì œ ID (V2 APIëŠ” pay_ í˜•ì‹ í•„ìˆ˜)
    reason: string;     // í•„ìˆ˜: ì·¨ì†Œ ì‚¬ìœ 
    cancelAmount?: number; // ì„ íƒ: ì·¨ì†Œ ê¸ˆì•¡ (ë¶€ë¶„ ì·¨ì†Œ ì‹œ)
  }): Promise<any> {
    console.log(`\n===== í¬íŠ¸ì› ê²°ì œ ì·¨ì†Œ ìš”ì²­ (V2 API) =====`);
    console.log(`ê²°ì œ ID: ${params.paymentId}`);
    console.log(`ì·¨ì†Œ ì‚¬ìœ : ${params.reason}`);
    
    // íŒŒë¼ë¯¸í„° ìœ íš¨ì„± ê²€ì‚¬
    if (!params.paymentId) {
      throw new Error('ê²°ì œ IDê°€ í•„ìš”í•©ë‹ˆë‹¤');
    }
    
    if (!params.reason) {
      console.log('ì·¨ì†Œ ì‚¬ìœ ê°€ ì—†ì–´ ê¸°ë³¸ê°’ ì‚¬ìš©');
      params.reason = 'ê³ ê° ìš”ì²­ì— ì˜í•œ ì·¨ì†Œ';
    }
    
    // --------- ê²°ì œ ID ì²˜ë¦¬ ë° ë³€í™˜ (V2 API í˜¸í™˜ì„± ë³´ì¥) ---------
    let finalPaymentId = params.paymentId;
    
    // V2 API í˜¸í™˜ ê²€ì¦ (pay_ + 22ì)
    if (!isValidPortoneUUID(finalPaymentId)) {
      console.log(`âš ï¸ ì£¼ì˜: ê²°ì œ ID í˜•ì‹ì´ V2 APIì™€ í˜¸í™˜ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ${finalPaymentId}`);
      
      // ì´ë¯¸ pay_ ì ‘ë‘ì‚¬ê°€ ìˆì§€ë§Œ ê¸¸ì´ê°€ ë§ì§€ ì•ŠëŠ” ê²½ìš°
      if (finalPaymentId.startsWith('pay_')) {
        console.log(`pay_ í˜•ì‹ ID ê¸¸ì´ êµì • í•„ìš”: ${finalPaymentId} (${finalPaymentId.length}ì)`);
        finalPaymentId = convertToV2PaymentId(finalPaymentId);
        console.log(`â¡ï¸ ê¸¸ì´ êµì • ê²°ê³¼: ${finalPaymentId} (${finalPaymentId.length}ì)`);
      }
      // UUID í˜•ì‹ì¸ ê²½ìš° (8-4-4-4-12)
      else if (/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(finalPaymentId)) {
        const originalId = finalPaymentId;
        finalPaymentId = convertToV2PaymentId(finalPaymentId);
        console.log(`â¡ï¸ UUID ë³€í™˜ ê²°ê³¼: ${originalId} â†’ ${finalPaymentId}`);
      }
      // ê·¸ ì™¸ì˜ ê²½ìš° - API ê²€ìƒ‰ ì‹œë„ ë˜ëŠ” ê°•ì œ ë³€í™˜
      else {
        try {
          // ì£¼ë¬¸ IDë¡œ ê°„ì£¼í•˜ê³  ê²€ìƒ‰ ì‹œë„
          console.log('ì£¼ë¬¸ IDë¡œ ê²°ì œ ì •ë³´ ê²€ìƒ‰ ì‹œë„: ' + finalPaymentId);
          const searchResult = await this.searchPayments({ orderId: finalPaymentId });
          
          if (searchResult?.payments?.length > 0) {
            const foundPayment = searchResult.payments[0];
            if (foundPayment.payment_id) {
              console.log(`âœ… ê²°ì œ ID ê²€ìƒ‰ ì„±ê³µ: ${foundPayment.payment_id}`);
              finalPaymentId = foundPayment.payment_id;
              
              // ì°¾ì€ IDê°€ V2 í˜•ì‹ì´ ì•„ë‹ˆë©´ ë³€í™˜
              if (!finalPaymentId.startsWith('pay_') || finalPaymentId.length !== 26) {
                const originalId = finalPaymentId;
                finalPaymentId = convertToV2PaymentId(finalPaymentId);
                console.log(`â¡ï¸ ê²€ìƒ‰ëœ ID ë³€í™˜: ${originalId} â†’ ${finalPaymentId}`);
              }
            } else {
              console.log('ê²€ìƒ‰ ê²°ê³¼ì— payment_idê°€ ì—†ìŒ, ê°•ì œ ë³€í™˜ ì§„í–‰');
              finalPaymentId = convertToV2PaymentId(finalPaymentId);
            }
          } else {
            console.log('ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ, ê°•ì œ ë³€í™˜ ì§„í–‰');
            finalPaymentId = convertToV2PaymentId(finalPaymentId);
          }
        } catch (searchError) {
          console.error('ê²°ì œ ID ê²€ìƒ‰ ì‹¤íŒ¨, ê°•ì œ ë³€í™˜ ì§„í–‰:', searchError);
          finalPaymentId = convertToV2PaymentId(finalPaymentId);
        }
      }
    }
    
    // ìµœì¢… ê²€ì¦ - 26ì ì •í™•íˆ ë§ëŠ”ì§€ í™•ì¸
    if (!finalPaymentId.startsWith('pay_') || finalPaymentId.length !== 26) {
      console.error(`âŒ ì‹¬ê°: ìµœì¢… ê²°ì œ IDê°€ ì—¬ì „íˆ V2 API í˜•ì‹ì´ ì•„ë‹˜: ${finalPaymentId}`);
      finalPaymentId = convertToV2PaymentId(finalPaymentId);
      console.log(`ğŸ”„ ìµœì¢… ê°•ì œ ë³€í™˜: ${finalPaymentId}`);
    }
    
    console.log(`âœ… ìµœì¢… ì·¨ì†Œ ìš”ì²­ ê²°ì œ ID: ${finalPaymentId} (${finalPaymentId.length}ì)`);
    
    // ì•”í˜¸í•™ì ìœ¼ë¡œ ì•ˆì „í•œ ë©±ë“±ì„± í‚¤ ìƒì„± (V2 API í•„ìˆ˜ ìš”êµ¬ì‚¬í•­)
    const { v4: uuidv4 } = require('uuid');
    const idempotencyKey = uuidv4();
    console.log(`ğŸ”‘ ë©±ë“±ì„± í‚¤ ìƒì„± (UUID): ${idempotencyKey}`);
    
    // pay_ ì ‘ë‘ì‚¬ í™•ì¸
    let needsFormatting = false;
    if (!params.paymentId.startsWith('pay_')) {
      console.warn(`ì£¼ì˜: ìµœì¢… ê²°ì œ IDê°€ pay_ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤: ${params.paymentId}`);
      needsFormatting = true;
    }
    
    // ê¸¸ì´ ê²€ì¦ (ì •í™•íˆ 26ìì—¬ì•¼ í•¨)
    if (params.paymentId.length !== 26) {
      console.warn(`ì£¼ì˜: ê²°ì œ ID ê¸¸ì´ê°€ 26ìê°€ ì•„ë‹™ë‹ˆë‹¤. í˜„ì¬ ê¸¸ì´: ${params.paymentId.length}ì`);
      needsFormatting = true;
    }
    
    // í˜•ì‹ì´ ë§ì§€ ì•Šìœ¼ë©´ ì¬í¬ë§·
    if (needsFormatting) {
      console.log(`ê²°ì œ ID ì¬í¬ë§· ì‹œì‘ (ì›ë³¸: ${params.paymentId})`);
      
      // pay_ ì ‘ë‘ì‚¬ ì œê±° í›„ ì•ŒíŒŒë²³ê³¼ ìˆ«ìë§Œ ì¶”ì¶œ
      let baseId = params.paymentId.replace(/^pay_/i, '').replace(/[^a-zA-Z0-9]/g, '');
      
      // ê¸¸ì´ ì¡°ì • (ì´ 22ìê°€ ë˜ë„ë¡)
      if (baseId.length > 22) {
        // ë„ˆë¬´ ê¸¸ë©´ ìë¥´ê¸°
        baseId = baseId.substring(0, 22);
        console.log(`IDê°€ ë„ˆë¬´ ê¸¸ì–´ ìë¦„: ${baseId} (${baseId.length}ì)`);
      } else if (baseId.length < 22) {
        // ë¶€ì¡±í•˜ë©´ 0ìœ¼ë¡œ ì±„ìš°ê¸°
        const originalLength = baseId.length;
        baseId = baseId.padEnd(22, '0');
        console.log(`IDê°€ ë¶€ì¡±í•˜ì—¬ 0ìœ¼ë¡œ ì±„ì›€: ${baseId.length - originalLength}ì ì¶”ê°€`);
      }
      
      // pay_ ì ‘ë‘ì‚¬ ì¶”ê°€í•˜ì—¬ ì •í™•íˆ 26ì ë§Œë“¤ê¸°
      const formattedId = `pay_${baseId}`;
      console.log(`ìµœì¢… í¬ë§·ëœ ê²°ì œ ID: ${formattedId} (${formattedId.length}ì)`);
      params.paymentId = formattedId;
    }
    
    // ìµœì¢… í™•ì¸
    if (params.paymentId.length !== 26 || !params.paymentId.startsWith('pay_')) {
      console.error(`âš ï¸ ì‹¬ê°í•œ ì˜¤ë¥˜: ê²°ì œ ID í˜•ì‹ì´ ì—¬ì „íˆ ë§ì§€ ì•ŠìŠµë‹ˆë‹¤: ${params.paymentId} (${params.paymentId.length}ì)`);
    } else {
      console.log(`âœ… í¬íŠ¸ì› V2 API ê·œê²©ì— ë§ëŠ” ê²°ì œ ID í™•ì¸: ${params.paymentId}`);
    }
    
    try {
      console.log('\n======== í¬íŠ¸ì› V2 ê²°ì œ ì·¨ì†Œ ì‹œì‘ ========');
      console.log('ê²°ì œ ID:', params.paymentId);
      console.log('ì·¨ì†Œ ì‚¬ìœ :', params.reason);
      console.log('ì·¨ì†Œ ê¸ˆì•¡:', params.cancelAmount ? params.cancelAmount : 'ì „ì²´ ê¸ˆì•¡');
      console.log('API í‚¤:', this.apiSecret.substring(0, 5) + '...' + this.apiSecret.substring(this.apiSecret.length - 5));
      
      // 1. ìš°ì„  ê²°ì œ ì •ë³´ ì¡°íšŒí•˜ì—¬ ìœ íš¨í•œì§€ í™•ì¸
      let paymentId = params.paymentId;
      let paymentInfo = null;
      
      try {
        // ê²°ì œ ID í˜•ì‹ ê²€ì‚¬ ë° ë³€í™˜
        if (paymentId.startsWith('MOI')) {
          console.log('ì´ë‹ˆì‹œìŠ¤ MOI í˜•ì‹ ê²°ì œ ID ê°ì§€ - ê²€ìƒ‰ìœ¼ë¡œ í¬íŠ¸ì› ID ì°¾ê¸° ì‹œë„');
          // MOI í˜•ì‹ì€ ì§ì ‘ ê²€ìƒ‰í•´ì„œ í¬íŠ¸ì› IDë¥¼ ì°¾ì•„ì•¼ í•¨
          const searchResult = await this.searchPayments({ 
            orderId: params.paymentId 
          });
          
          if (searchResult && searchResult.payments && searchResult.payments.length > 0) {
            // ê²°ì œ ì •ë³´ ë°œê²¬ ì‹œ í¬íŠ¸ì› IDë¡œ ëŒ€ì²´
            const foundPayment = searchResult.payments[0];
            if (foundPayment.payment_id) {
              console.log('ê²€ìƒ‰ìœ¼ë¡œ ì°¾ì€ í¬íŠ¸ì› ê²°ì œ ID:', foundPayment.payment_id);
              paymentId = foundPayment.payment_id;
            }
          }
        } 
        else if (!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(paymentId) && 
                !paymentId.startsWith('pay_')) {
          console.log('ì£¼ë¬¸ IDë¡œ ì¶”ì •ë˜ëŠ” í˜•ì‹ ê°ì§€ - í•´ë‹¹ ì£¼ë¬¸ì˜ ê²°ì œ ì •ë³´ ê²€ìƒ‰');
          // ì£¼ë¬¸ IDë¡œ ì¶”ì •ë˜ëŠ” ê²½ìš°, í•´ë‹¹ ì£¼ë¬¸ì˜ ê²°ì œ ê²€ìƒ‰
          const searchResult = await this.searchPayments({ 
            orderId: paymentId 
          });
          
          if (searchResult && searchResult.payments && searchResult.payments.length > 0) {
            // ê²°ì œ ì •ë³´ ë°œê²¬ ì‹œ í¬íŠ¸ì› IDë¡œ ëŒ€ì²´
            const foundPayment = searchResult.payments[0];
            if (foundPayment.payment_id) {
              console.log('ì£¼ë¬¸ IDë¡œ ê²€ìƒ‰í•˜ì—¬ ì°¾ì€ í¬íŠ¸ì› ê²°ì œ ID:', foundPayment.payment_id);
              paymentId = foundPayment.payment_id;
            }
          }
        }
        
        // ìµœì¢… ê²°ì œ IDë¡œ ê²°ì œ ì •ë³´ ì¡°íšŒ
        console.log('ê²°ì œ ì •ë³´ ì¡°íšŒ ì¤‘... ID:', paymentId);
        paymentInfo = await this.getPayment(paymentId);
        console.log('ê²°ì œ ì •ë³´ ì¡°íšŒ ì„±ê³µ:', paymentInfo ? 'ë°ì´í„° ìˆìŒ' : 'ë°ì´í„° ì—†ìŒ');
        
        if (paymentInfo) {
          console.log('ê²°ì œ ìƒíƒœ:', paymentInfo.status);
          if (paymentInfo.status === 'CANCELLED') {
            console.log('ì´ë¯¸ ì·¨ì†Œëœ ê²°ì œì…ë‹ˆë‹¤');
            return {
              success: true,
              message: 'ì´ë¯¸ ì·¨ì†Œëœ ê²°ì œì…ë‹ˆë‹¤',
              data: paymentInfo
            };
          }
        }
      } catch (error: any) {
        console.warn('ê²°ì œ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
        // ì¡°íšŒ ì‹¤íŒ¨í•´ë„ ì·¨ì†Œ ì‹œë„ëŠ” ê³„ì† ì§„í–‰
      }
      
      // 2. ì·¨ì†Œ API í˜¸ì¶œ ì¤€ë¹„
      // ë©±ë“±ì„± í‚¤ ìƒì„± (v2 API ìš”êµ¬ì‚¬í•­)
      const idempotencyKey = `cancel-${Date.now()}-${Math.random().toString(36).substring(2, 10)}`;
      
      // ì·¨ì†Œ ìš”ì²­ ì „ ë¨¼ì € ê²°ì œ ì¡°íšŒë¡œ ì¡´ì¬ í™•ì¸
      console.log(`\nê²°ì œ ì·¨ì†Œ ì „ ê²°ì œ ì¡°íšŒ ì‹œë„ (paymentId: ${paymentId})`);
      
      try {
        // ê²°ì œ ì •ë³´ ë¨¼ì € ì¡°íšŒí•˜ì—¬ ì¡´ì¬ ì—¬ë¶€ ë° ìƒíƒœ í™•ì¸
        const paymentUrl = `/v2/payments/${paymentId}`;
        console.log(`ê²°ì œ ì •ë³´ ì¡°íšŒ URL: ${paymentUrl}`);
        
        const paymentResponse = await this.client.get(paymentUrl, {
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `PortOne ${this.apiSecret}`,
            'Store-Id': PORTONE_STORE_ID,
            'Accept': 'application/json'
          }
        });
        
        if (paymentResponse.status === 200 && paymentResponse.data) {
          console.log(`âœ“ ê²°ì œ ì •ë³´ ì¡°íšŒ ì„±ê³µ (ID: ${paymentId})`);
          console.log(`- ê²°ì œ ìƒíƒœ: ${paymentResponse.data.status}`);
          console.log(`- ê²°ì œ ê¸ˆì•¡: ${paymentResponse.data.totalAmount || paymentResponse.data.amount || 'N/A'}`);
          console.log(`- ê²°ì œ ë°©ë²•: ${paymentResponse.data.method || 'N/A'}`);
          console.log(`- ì£¼ë¬¸ ID: ${paymentResponse.data.orderId || 'N/A'}`);
          
          // ì´ë¯¸ ì·¨ì†Œëœ ìƒíƒœì¸ì§€ í™•ì¸
          if (paymentResponse.data.status === 'CANCELED' || 
              paymentResponse.data.status === 'CANCELLED') {
            console.log('âœ“ ì´ë¯¸ ì·¨ì†Œëœ ê²°ì œì…ë‹ˆë‹¤.');
            return {
              success: true,
              message: 'ì´ë¯¸ ì·¨ì†Œëœ ê²°ì œì…ë‹ˆë‹¤.',
              data: paymentResponse.data
            };
          }
        } else {
          console.warn(`âš ï¸ ê²°ì œ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨ (ìƒíƒœ ì½”ë“œ: ${paymentResponse.status})`);
          console.warn(`- ì‘ë‹µ ë°ì´í„°:`, paymentResponse.data);
          // ê²°ì œ ì •ë³´ê°€ ì¡°íšŒë˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ì·¨ì†Œë„ ë¶ˆê°€ëŠ¥í•  ê°€ëŠ¥ì„±ì´ ë†’ìŒ
          // ê·¸ëŸ¬ë‚˜ ì·¨ì†ŒëŠ” ì‹œë„í•  ìˆ˜ ìˆìŒ
        }
      } catch (error: any) {
        console.error(`âŒ ê²°ì œ ì •ë³´ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:`, error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
        if (error.response) {
          console.error(`- ì‘ë‹µ ìƒíƒœ ì½”ë“œ: ${error.response.status}`);
          console.error(`- ì‘ë‹µ ë°ì´í„°:`, error.response.data);
          
          // 404 ì˜¤ë¥˜ë©´ í•´ë‹¹ ê²°ì œ IDê°€ í¬íŠ¸ì›ì— ì¡´ì¬í•˜ì§€ ì•ŠìŒì„ ì˜ë¯¸
          if (error.response.status === 404) {
            console.error(`âš ï¸ í•´ë‹¹ ê²°ì œ ID(${paymentId})ê°€ í¬íŠ¸ì› ì‹œìŠ¤í…œì— ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!`);
            console.error(`ë¹„êµìš© ì˜¤ë¦¬ì§€ë„ UUID: ${error.config?.originalUuid || 'ì—†ìŒ'}`);
          }
        }
        // ì¡°íšŒ ì‹¤íŒ¨í•´ë„ ì·¨ì†ŒëŠ” ì‹œë„
      }
      
      // ì¤‘ìš”: ê²°ì œ ID ìœ íš¨ì„± ìµœì¢… ê²€ì¦ ë° ê°•ì œ êµì • (ë°˜ë“œì‹œ 26ìì—¬ì•¼ í•¨)
      let finalPaymentId = paymentId;
      console.log(`\nìµœì¢… API í˜¸ì¶œ ì „ ê²°ì œ ID ê²€ì¦: ${finalPaymentId} (${finalPaymentId.length}ì)`);
      
      // ìµœì¢… ID ê²€ì¦ - ë°˜ë“œì‹œ "pay_" + 22ì(ì´ 26ì)ì—¬ì•¼ í•¨
      if (!finalPaymentId.startsWith('pay_') || finalPaymentId.length !== 26) {
          console.warn(`âš ï¸ ê²°ì œ ID í˜•ì‹ì´ ìœ íš¨í•˜ì§€ ì•ŠìŒ: ${finalPaymentId} (${finalPaymentId.length}ì)`);
          
          // UUIDì—ì„œ prefix ë¶™ì´ê¸° - í¬íŠ¸ì› ë¬¸ì„œ ê¸°ì¤€ìœ¼ë¡œ ë³€í™˜
          if (/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(finalPaymentId)) {
            // UUID í•˜ì´í”ˆ ì œê±° í›„ pay_ ë¶™ì´ê³  ì •í™•íˆ 22ì ì¶”ì¶œ
            const cleanUuid = finalPaymentId.replace(/-/g, '');
            finalPaymentId = `pay_${cleanUuid.substring(0, 22)}`;
            console.log(`UUIDë¥¼ pay_ í˜•ì‹ìœ¼ë¡œ ë³€í™˜: ${finalPaymentId} (${finalPaymentId.length}ì)`);
          }
          // ì´ë¯¸ pay_ í˜•ì‹ì´ì§€ë§Œ ê¸¸ì´ê°€ 26ìê°€ ì•„ë‹Œ ê²½ìš°
          else if (finalPaymentId.startsWith('pay_')) {
            // ê¸¸ì´ ì¡°ì •
            const idPart = finalPaymentId.substring(4); // pay_ ì œì™¸í•œ ë¶€ë¶„
            
            // ì •í™•íˆ 22ìê°€ ë˜ë„ë¡ ì¡°ì • (ë¶€ì¡±í•˜ë©´ ì±„ìš°ê³ , ë„˜ì¹˜ë©´ ìë¦„)
            let correctedId;
            if (idPart.length > 22) {
              correctedId = idPart.substring(0, 22);
            } else {
              // 22ìë³´ë‹¤ ì§§ìœ¼ë©´ ë’¤ì— 'f'ë¡œ ì±„ì›€ (0 ëŒ€ì‹  f ì‚¬ìš©)
              correctedId = idPart.padEnd(22, 'f');
            }
            
            finalPaymentId = `pay_${correctedId}`;
            console.log(`pay_ ID ê¸¸ì´ êµì •: ${finalPaymentId} (${finalPaymentId.length}ì)`);
          }
          // ê·¸ ì™¸ ëª¨ë“  ê²½ìš° (ì¼ë°˜ ë¬¸ìì—´)
          else {
            // ì•ŒíŒŒë²³ê³¼ ìˆ«ìë§Œ ë‚¨ê¸°ê³  ì •í™•íˆ 22ì ì¶”ì¶œ + pay_ ì ‘ë‘ì‚¬
            let cleanId = finalPaymentId.replace(/[^a-zA-Z0-9]/g, '');
            
            if (cleanId.length > 22) {
              cleanId = cleanId.substring(0, 22);
            } else {
              cleanId = cleanId.padEnd(22, 'f'); // 'f'ë¡œ ì±„ì›€
            }
            
            finalPaymentId = `pay_${cleanId}`;
            console.log(`ì¼ë°˜ ë¬¸ìì—´ì„ pay_ í˜•ì‹ìœ¼ë¡œ ë³€í™˜: ${finalPaymentId} (${finalPaymentId.length}ì)`);
          }
        }
      }
      
      // !! ì¤‘ìš” ë³€ê²½ !! í•˜ì´í”ˆ í¬í•¨ ì›ë³¸ UUIDë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©
      // í¬íŠ¸ì› API v2ëŠ” UUID í˜•ì‹(-í¬í•¨) ê²°ì œ IDë¥¼ ì§ì ‘ ì§€ì›í•©ë‹ˆë‹¤
      if (/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(params.paymentId)) {
        // UUID í˜•ì‹ ê·¸ëŒ€ë¡œ ì‚¬ìš© (í•˜ì´í”ˆ í¬í•¨)
        finalPaymentId = params.paymentId;
        console.log(`âœ… ì›ë³¸ UUID í˜•ì‹ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤: ${finalPaymentId}`);
        
        // ë³€í™˜ ê¸ˆì§€
        return this.cancelPaymentWithOriginalUUID(finalPaymentId, params.reason, params.cancelAmount);
      }
      
      // ê·¸ ì™¸ ì¼€ì´ìŠ¤ì— ëŒ€í•œ ìµœì¢… ê²€ì¦
      if (finalPaymentId.length !== 26) {
        console.error(`âŒ ì‹¬ê°í•œ ì˜¤ë¥˜: ëª¨ë“  ì²˜ë¦¬ í›„ì—ë„ IDê°€ 26ìê°€ ì•„ë‹˜: ${finalPaymentId} (${finalPaymentId.length}ì)`);
        // ìµœí›„ì˜ ìˆ˜ë‹¨ - ê°•ì œë¡œ 26ì ë§ì¶”ê¸°
        if (finalPaymentId.startsWith('pay_')) {
          const base = finalPaymentId.substring(4);
          finalPaymentId = `pay_${base.padEnd(22, 'f').substring(0, 22)}`;
        } else {
          finalPaymentId = `pay_${finalPaymentId.padEnd(22, 'f').substring(0, 22)}`;
        }
        console.log(`ìµœì¢… ê°•ì œ êµì •ëœ ID: ${finalPaymentId} (${finalPaymentId.length}ì)`);
      }
      
      console.log(`ìµœì¢… API í˜¸ì¶œìš© ê²°ì œ ID: ${finalPaymentId} (${finalPaymentId.length}ì)`);
      // originalPaymentIdë¥¼ í—¤ë”ì— ì¶”ê°€í•˜ê¸° ìœ„í•´ configì— ì €ì¥
      (this.client.defaults as any).originalUuid = paymentId;
      
      // ì·¨ì†Œ ìš”ì²­ URL - í¬íŠ¸ì› V2 API ë¬¸ì„œì— ë§ê²Œ ìˆ˜ì •
      // ì°¸ê³ : https://developers.portone.io/api/rest-v2/payment?v=v2
      const url = `/v2/payments/${finalPaymentId}/cancel`;
      
      // ì·¨ì†Œ ìš”ì²­ ë³¸ë¬¸ - í¬íŠ¸ì› V2 API ë¬¸ì„œ ê¸°ì¤€ìœ¼ë¡œ í•„ë“œëª… ìˆ˜ì •
      const requestBody: Record<string, any> = {
        reason: params.reason
      };
      
      // ë¶€ë¶„ ì·¨ì†Œ ê¸ˆì•¡ì´ ìˆëŠ” ê²½ìš° - í•„ë“œëª… ìˆ˜ì •
      if (params.cancelAmount) {
        requestBody.cancelAmount = params.cancelAmount;
      }
      
      // API ìš”ì²­ í—¤ë” - í¬íŠ¸ì› V2 API ë¬¸ì„œì— ë§ê²Œ ìˆ˜ì •
      const requestOptions = {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `PortOne ${this.apiSecret}`,
          'Store-Id': PORTONE_STORE_ID, // ìƒì  ID í—¤ë” ì¶”ê°€
          'Accept': 'application/json',
          'Idempotency-Key': idempotencyKey
        },
        timeout: 15000 // íƒ€ì„ì•„ì›ƒ 15ì´ˆ
      };
      
      console.log('\n-- API í˜¸ì¶œ ì •ë³´ --');
      console.log('ìš”ì²­ URL:', url);
      console.log('ìš”ì²­ ë³¸ë¬¸:', JSON.stringify(requestBody, null, 2));
      console.log('Idempotency-Key:', idempotencyKey);
      console.log('Authorization:', `PortOne ${this.apiSecret.substring(0, 5)}...`);
      
      console.log('ìµœì¢… ìš”ì²­ ì •ë³´:', JSON.stringify({
        url,
        method: 'POST',
        headers: {
          'Content-Type': 'application/json; charset=utf-8',
          'Accept': 'application/json',
          'Idempotency-Key': idempotencyKey,
          'Store-Id': PORTONE_STORE_ID,
          'Authorization': '(ë¹„ê³µê°œ)' // ë¡œê·¸ì—ì„œëŠ” ì¸ì¦ ì •ë³´ ê°ì¶¤
        }
      }, null, 2));
      
      const response = await this.client.post(url, requestBody, requestOptions);
      
      const startTime = new Date();
      console.log(`\n4. ê²°ì œ ì·¨ì†Œ API ì‘ë‹µ (ìš”ì²­ ì‹œê°„: ${startTime.toISOString()}):`);
      console.log('- ì‘ë‹µ ìƒíƒœì½”ë“œ:', response.status);
      console.log('- ì‘ë‹µ í—¤ë”:', response.headers);
      
      // ì‘ë‹µ ë°ì´í„° ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
      let responseData;
      if (response.data) {
        console.log('- ì‘ë‹µ ë°ì´í„° í™•ì¸ (ìš”ì•½):', typeof response.data);
        
        try {
          // ì‘ë‹µì´ ì´ë¯¸ ê°ì²´ì¸ ê²½ìš°
          if (typeof response.data === 'object') {
            responseData = response.data;
          } 
          // ì‘ë‹µì´ JSON ë¬¸ìì—´ì¸ ê²½ìš°
          else if (typeof response.data === 'string' && response.data.trim()) {
            try {
              responseData = JSON.parse(response.data);
            } catch (parseError) {
              console.error('ì‘ë‹µ ë°ì´í„° JSON íŒŒì‹± ì˜¤ë¥˜:', parseError);
              responseData = { 
                success: response.status < 400,
                status: 'PARSING_ERROR',
                message: 'ì‘ë‹µ ë°ì´í„°ë¥¼ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
                raw: response.data.substring(0, 100) + (response.data.length > 100 ? '...' : '')
              };
            }
          } 
          // ë¹ˆ ì‘ë‹µì¸ ê²½ìš°
          else {
            responseData = {
              success: response.status < 400,
              status: response.status < 400 ? 'SUCCESS' : 'ERROR',
              message: response.status < 400 ? 'ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'
            };
          }
        } catch (e) {
          console.error('ì‘ë‹µ ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜:', e);
          responseData = { success: false, message: 'ì‘ë‹µ ë°ì´í„° ì²˜ë¦¬ ì˜¤ë¥˜' };
        }
      } else {
        // ì‘ë‹µ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°
        responseData = { 
          success: response.status < 400,
          status: response.status < 400 ? 'SUCCESS' : 'ERROR',
          message: response.status < 400 ? 'ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤'
        };
      }
      
      // ì˜¤ë¥˜ ì²˜ë¦¬
      if (response.status >= 400) {
        console.error('! í¬íŠ¸ì› API ì·¨ì†Œ ì˜¤ë¥˜ ì‘ë‹µ:', responseData);
        throw new Error(`ê²°ì œ ì·¨ì†Œ API ì˜¤ë¥˜: ${JSON.stringify(responseData)}`);
      }
      
      console.log('\nâœ… í¬íŠ¸ì› ê²°ì œ ì·¨ì†Œ ì„±ê³µ');
      console.log('=== ê²°ì œ ì·¨ì†Œ ìš”ì²­ ì™„ë£Œ ===\n');
      
      // ì‘ë‹µ ë°ì´í„° ë°˜í™˜ (ì²˜ë¦¬ëœ ì•ˆì „í•œ ë°ì´í„°)
      return responseData;
    } catch (error: any) {
      console.error('\nâŒ ê²°ì œ ì·¨ì†Œ API ì˜¤ë¥˜:');
      
      // ì—ëŸ¬ ìƒì„¸ ë¡œê¹…
      if (error.response) {
        console.error('- ì‘ë‹µ ìƒíƒœì½”ë“œ:', error.response.status);
        console.error('- ì‘ë‹µ ë°ì´í„°:', JSON.stringify(error.response.data, null, 2));
      } else if (error.request) {
        console.error('- ìš”ì²­ í›„ ì‘ë‹µ ì—†ìŒ (íƒ€ì„ì•„ì›ƒ ê°€ëŠ¥ì„±)');
      }
      
      console.error('- ì˜¤ë¥˜ ë©”ì‹œì§€:', error.message);
      console.error('=== ê²°ì œ ì·¨ì†Œ ìš”ì²­ ì‹¤íŒ¨ ===\n');
      throw new Error(`ê²°ì œ ì·¨ì†Œ ì˜¤ë¥˜: ${error.message}`);
    }
  }
  
  /**
   * ì›ë³¸ UUID í˜•ì‹ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•œ ê²°ì œ ì·¨ì†Œ (ìµœì í™” ë²„ì „)
   * í¬íŠ¸ì› API v2ëŠ” UUID í˜•ì‹ì˜ ê²°ì œ IDë¥¼ ì§ì ‘ ì§€ì›í•©ë‹ˆë‹¤
   */
  async cancelPaymentWithOriginalUUID(
    originalUUID: string,
    reason: string,
    cancelAmount?: number
  ): Promise<any> {
    console.log(`\n===== í¬íŠ¸ì› ê²°ì œ ì·¨ì†Œ ìš”ì²­ (ì›ë³¸ UUID ì‚¬ìš©) =====`);
    console.log(`UUID ê²°ì œ ID: ${originalUUID}`);
    console.log(`ì·¨ì†Œ ì‚¬ìœ : ${reason}`);
    
    try {
      // ë©±ë“±ì„± í‚¤ ìƒì„± (v2 API ìš”êµ¬ì‚¬í•­)
      const idempotencyKey = `cancel-${Date.now()}-${Math.random().toString(36).substring(2, 10)}`;
      
      // ì·¨ì†Œ ìš”ì²­ URL - UUID í˜•ì‹ ê·¸ëŒ€ë¡œ ì‚¬ìš© (í¬íŠ¸ì› V2 API ë¬¸ì„œì— ë§ê²Œ ìˆ˜ì •)
      const url = `/v2/payments/${originalUUID}/cancel`;
      
      // ì·¨ì†Œ ìš”ì²­ ë³¸ë¬¸
      const requestBody: Record<string, any> = {
        reason: reason
      };
      
      // ë¶€ë¶„ ì·¨ì†Œ ê¸ˆì•¡ì´ ìˆëŠ” ê²½ìš°
      if (cancelAmount) {
        requestBody.cancelAmount = cancelAmount;
      }
      
      // API ìš”ì²­ í—¤ë”
      const requestOptions = {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `PortOne ${this.apiSecret}`,
          'Store-Id': PORTONE_STORE_ID,
          'Accept': 'application/json',
          'Idempotency-Key': idempotencyKey
        },
        timeout: 15000 // íƒ€ì„ì•„ì›ƒ 15ì´ˆ
      };
      
      console.log('\n-- API í˜¸ì¶œ ì •ë³´ (UUID ì§ì ‘ ì‚¬ìš©) --');
      console.log('ìš”ì²­ URL:', url);
      console.log('ìš”ì²­ ë³¸ë¬¸:', JSON.stringify(requestBody, null, 2));
      console.log('Idempotency-Key:', idempotencyKey);
      
      // API í˜¸ì¶œ
      const response = await this.client.post(url, requestBody, requestOptions);
      
      const startTime = new Date();
      console.log(`\nê²°ì œ ì·¨ì†Œ API ì‘ë‹µ (ìš”ì²­ ì‹œê°„: ${startTime.toISOString()}):`);
      console.log('- ì‘ë‹µ ìƒíƒœì½”ë“œ:', response.status);
      console.log('- ì‘ë‹µ í—¤ë”:', response.headers);
      
      // ì‘ë‹µ ë°ì´í„° í™•ì¸
      if (response.status >= 400) {
        console.error('! í¬íŠ¸ì› API ì·¨ì†Œ ì˜¤ë¥˜ ì‘ë‹µ:', response.data);
        throw new Error(`ê²°ì œ ì·¨ì†Œ API ì˜¤ë¥˜: ${JSON.stringify(response.data)}`);
      }
      
      console.log('\nâœ… í¬íŠ¸ì› ê²°ì œ ì·¨ì†Œ ì„±ê³µ (UUID ì§ì ‘ ì‚¬ìš©)');
      console.log('=== ê²°ì œ ì·¨ì†Œ ìš”ì²­ ì™„ë£Œ ===\n');
      
      // ì‘ë‹µ ë°ì´í„° ë°˜í™˜
      return response.data;
    } catch (error: any) {
      console.error('\nâŒ ê²°ì œ ì·¨ì†Œ API ì˜¤ë¥˜ (UUID ì§ì ‘ ì‚¬ìš©):');
      
      // ì—ëŸ¬ ìƒì„¸ ë¡œê¹…
      if (error.response) {
        console.error('- ì‘ë‹µ ìƒíƒœì½”ë“œ:', error.response.status);
        console.error('- ì‘ë‹µ ë°ì´í„°:', JSON.stringify(error.response.data, null, 2));
      } else if (error.request) {
        console.error('- ìš”ì²­ í›„ ì‘ë‹µ ì—†ìŒ (íƒ€ì„ì•„ì›ƒ ê°€ëŠ¥ì„±)');
      }
      
      console.error('- ì˜¤ë¥˜ ë©”ì‹œì§€:', error.message);
      console.error('=== ê²°ì œ ì·¨ì†Œ ìš”ì²­ ì‹¤íŒ¨ ===\n');
      throw new Error(`ê²°ì œ ì·¨ì†Œ ì˜¤ë¥˜: ${error.message}`);
    }
  }
  
  /**
   * ì£¼ë¬¸ ë²ˆí˜¸ ë˜ëŠ” ë‹¤ë¥¸ ì¡°ê±´ìœ¼ë¡œ ê²°ì œ ì •ë³´ ê²€ìƒ‰
   * V2 API ê¸°ë°˜ ê²€ìƒ‰ êµ¬í˜„ (ì£¼ë¬¸ ID, ê²°ì œ ìƒíƒœ ë“±ìœ¼ë¡œ ê²€ìƒ‰)
   */
  async searchPayments(params: {
    orderId?: string;
    status?: string;
    page?: number;
    limit?: number;
    startDate?: string;
    endDate?: string;
    amount?: string;
    moid?: string; // ì´ë‹ˆì‹œìŠ¤ MOID
    tid?: string;  // ì´ë‹ˆì‹œìŠ¤ ê²°ì œë²ˆí˜¸
    paymentKey?: string; // í¬íŠ¸ì› ê²°ì œ í‚¤
    inicisOrderId?: string; // ì´ë‹ˆì‹œìŠ¤ ì£¼ë¬¸ë²ˆí˜¸ í˜•ì‹
  }) {
    console.log('\n=== í¬íŠ¸ì› ê²°ì œ ì •ë³´ ê²€ìƒ‰ ì‹œì‘ ===');
    console.log('ê²€ìƒ‰ íŒŒë¼ë¯¸í„°:', JSON.stringify(params, null, 2));
    
    try {
      // Authorizationê³¼ Store-Id í—¤ë” í™•ì¸
      console.log('API í‚¤ ìƒíƒœ í™•ì¸:');
      console.log(`- Authorization í‚¤: PortOne ${this.apiSecret.substring(0, 5)}...${this.apiSecret.substring(this.apiSecret.length - 5)}`);
      console.log(`- Store-Id: ${PORTONE_STORE_ID}`);
      
      // =============== ê²°ì œ ê²€ìƒ‰ ì „ëµ ê°œì„  ===============
      // 1ë‹¨ê³„: í‘œì¤€ V2 API ê²€ìƒ‰ ì‹œë„ (ì£¼ë¬¸ ID ì‚¬ìš©)
      // 2ë‹¨ê³„: ì‹¤íŒ¨ ì‹œ ê³ ê°ì‚¬ ìƒì„¸ ì¡°íšŒ API ì‹œë„
      // 3ë‹¨ê³„: ì™„ì „íˆ ì‹¤íŒ¨í•œ ê²½ìš°, ID ìƒì„± ë£°ì„ ì‚¬ìš©í•œ ê²°ì œ ID ì¶”ë¡ 
      
      // ê²€ìƒ‰ íŒŒë¼ë¯¸í„° ì„¤ì •
      const searchParams = new URLSearchParams();
      
      // ì£¼ë¬¸ ë²ˆí˜¸ (ë°˜ë“œì‹œ order_id í•„ë“œëª… ì‚¬ìš©)
      if (params.orderId) {
        searchParams.append('order_id', params.orderId);
        console.log(`ì£¼ë¬¸ ë²ˆí˜¸ë¡œ ê²€ìƒ‰: ${params.orderId}`);
      }
      
      // ê²°ì œ ìƒíƒœ(ìˆëŠ” ê²½ìš°)
      if (params.status) {
        searchParams.append('status', params.status);
      }
      
      // ê²°ì œ ì‹œê°„ ë²”ìœ„(ìˆëŠ” ê²½ìš°)
      if (params.startDate) {
        searchParams.append('from', params.startDate);
      }
      
      if (params.endDate) {
        searchParams.append('to', params.endDate);
      }
      
      // ê²°ì œ ê¸ˆì•¡(ìˆëŠ” ê²½ìš°)
      if (params.amount) {
        searchParams.append('amount', params.amount);
      }
      
      // ì´ë‹ˆì‹œìŠ¤ MOID(ìˆëŠ” ê²½ìš°)
      if (params.moid) {
        searchParams.append('moid', params.moid);
      }
      
      // ì´ë‹ˆì‹œìŠ¤ ê²°ì œë²ˆí˜¸(ìˆëŠ” ê²½ìš°)
      if (params.tid) {
        searchParams.append('tid', params.tid);
      }
      
      // í¬íŠ¸ì› ê²°ì œ í‚¤(ìˆëŠ” ê²½ìš°)
      if (params.paymentKey) {
        searchParams.append('payment_id', params.paymentKey);
      }
      
      // ì´ë‹ˆì‹œìŠ¤ ì£¼ë¬¸ë²ˆí˜¸ í˜•ì‹(ìˆëŠ” ê²½ìš°)
      if (params.inicisOrderId) {
        searchParams.append('pg_reference_key', params.inicisOrderId);
      }
      
      // í˜ì´ì§€ë„¤ì´ì…˜ ì²˜ë¦¬
      searchParams.append('page', (params.page || 1).toString());
      searchParams.append('limit', (params.limit || 20).toString());
      
      // API í˜¸ì¶œ (í¬íŠ¸ì› V2 API ë¬¸ì„œì— ë§ê²Œ ìˆ˜ì •)
      const url = `/v2/payments?${searchParams.toString()}`;
      console.log(`í¬íŠ¸ì› API ìš”ì²­ URL: ${url}`);
      console.log(`ê²€ìƒ‰ íŒŒë¼ë¯¸í„°: ${searchParams.toString()}`);
      
      // ìš”ì²­ í—¤ë” ì„¤ì • (ìƒì  ID ì¶”ê°€)
      const requestOptions = {
        headers: {
          'Store-Id': PORTONE_STORE_ID,
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        }
      };
      
      // API ìš”ì²­ ì „ì†¡
      console.log('í¬íŠ¸ì› API ìš”ì²­ ì „ì†¡ ì‹œë„...');
      console.log('ìš”ì²­ í—¤ë”:', JSON.stringify(requestOptions.headers, null, 2));
      const startTime = Date.now();
      const response = await this.client.get(url, requestOptions);
      const endTime = Date.now();
      console.log(`í¬íŠ¸ì› API ì‘ë‹µ ë°›ìŒ (ì†Œìš”ì‹œê°„: ${endTime - startTime}ms)`);
      console.log(`ì‘ë‹µ ìƒíƒœ ì½”ë“œ: ${response.status}`);
      
      // ì‘ë‹µ ì œëŒ€ë¡œ ë°›ì•˜ëŠ”ì§€ í™•ì¸
      if (response.status >= 400) {
        console.error(`í¬íŠ¸ì› API ì˜¤ë¥˜ [${response.status}]:`, response.data);
        throw new Error(response.data?.message || 'ê²°ì œ ì •ë³´ ê²€ìƒ‰ ì˜¤ë¥˜');
      }
      
      // ì‘ë‹µ ê°€ìš¸íŒ… ì •ë³´ ë¡œê¹…
      if (response.data && response.data.payments) {
        console.log(`ê²€ìƒ‰ ê²°ê³¼: ${response.data.payments.length}ê°œ ê²°ì œ ì •ë³´ ë°œê²¬`);
        if (response.data.payments.length > 0) {
          console.log('ì²˜ìŒ ë°œê²¬í•œ ê²°ì œ ì •ë³´:', JSON.stringify(response.data.payments[0], null, 2));
        }
      } else {
        console.log('ê²€ìƒ‰ ê²°ê³¼: ê²°ì œ ì •ë³´ ì—†ìŒ');
      }
      
      console.log('=== PortOne API Search Complete ===\n');
      return response.data;
    } catch (error: any) {
      console.error('=== PortOne API Search Error ===');
      if (error.response) {
        console.error(`ì‘ë‹µ ìƒíƒœ ì½”ë“œ: ${error.response.status}`);
        console.error('ì˜¤ë¥˜ ë°ì´í„°:', JSON.stringify(error.response.data, null, 2));
      } else if (error.request) {
        console.error('ìš”ì²­ì€ ë³´ëƒˆì§€ë§Œ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', error.request);
      } else {
        console.error('ì˜¤ë¥˜ ë©”ì‹œì§€:', error.message);
      }
      console.error('Error Object:', error);
      console.error('=== PortOne API Search Error Handled ===\n');
      
      throw new Error(`ê²°ì œ ì •ë³´ ê²€ìƒ‰ ì˜¤ë¥˜: ${error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
    }
  }

  /**
   * API í‚¤ ìœ íš¨ì„± í…ŒìŠ¤íŠ¸
   */
  async testConnection() {
    console.log('\n=== í¬íŠ¸ì› API ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘ ===');
    console.log('ì‚¬ìš©ì¤‘ì¸ API í‚¤ í˜•ì‹ í™•ì¸:');
    console.log(`- API í‚¤ ê¸¸ì´: ${this.apiSecret ? this.apiSecret.length : 0}`);
    console.log(`- API í‚¤ ì‹œì‘ ë¶€ë¶„: ${this.apiSecret ? this.apiSecret.substring(0, 5) : 'ì—†ìŒ'}`);
    console.log(`- API í‚¤ TK ì‹œì‘ ì—¬ë¶€: ${this.apiSecret && this.apiSecret.startsWith('TK') ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'}`);
    
    try {
      if (!this.apiSecret || !this.apiSecret.startsWith('TK')) {
        console.log('API í‚¤ í˜•ì‹ ê²€ì‚¬ ì‹¤íŒ¨: í˜•ì‹ì´ ìœ íš¨í•˜ì§€ ì•ŠìŒ');
        console.log('=== í¬íŠ¸ì› API ì—°ê²° í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===\n');
        return { success: false, message: 'API í‚¤ í˜•ì‹ì´ ìœ íš¨í•˜ì§€ ì•ŠìŒ' };
      }
      
      // ì‹¤ì œ API ìš”ì²­ì„ ë³´ë‚´ì„œ í…ŒìŠ¤íŠ¸
      try {
        console.log('\ní¬íŠ¸ì› API ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œë„...');
        // í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ í—¤ë” ì •ë³´ ì¶œë ¥
        console.log('Authorization í—¤ë”:', 
                   `PortOne ${this.apiSecret.substring(0, 5)}...${this.apiSecret.substring(this.apiSecret.length - 5)}`);
        console.log('ìš”ì²­ URL: /v2/payments?page=1&limit=1');
        
        // API ìš”ì²­ ì‹œë„ - í¬íŠ¸ì› V2 API ë¬¸ì„œì— ë§ê²Œ ìˆ˜ì •
        const startTime = Date.now();
        const response = await this.client.get('/v2/payments?page=1&limit=1');
        const endTime = Date.now();
        
        console.log(`í¬íŠ¸ì› API ì‘ë‹µ ë°›ìŒ (ì†Œìš”ì‹œê°„: ${endTime - startTime}ms)`);
        console.log(`ì‘ë‹µ ìƒíƒœ ì½”ë“œ: ${response.status}`);
        console.log(`ë°ì´í„° ì—†ìŒ ì½”ë“œ: ${!response.data}`);
        console.log(`ì‘ë‹µ ë°ì´í„° í‘œì‹œ:`, response.data ? JSON.stringify(response.data, null, 2) : 'ë°ì´í„° ì—†ìŒ');
        
        if (response.status >= 200 && response.status < 300) {
          console.log('API í‚¤ ìœ íš¨ì„± í…ŒìŠ¤íŠ¸ ì„±ê³µ!');
          console.log('=== í¬íŠ¸ì› API ì—°ê²° í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===\n');
          return { success: true, message: 'API í‚¤ ìœ íš¨í•¨, ì—°ê²° ì„±ê³µ' };
        } else {
          console.error(`API ì„œë²„ ì—°ê²° ì˜¤ë¥˜ [${response.status}]:`, response.data || 'ë°ì´í„° ì—†ìŒ');
          console.log('=== í¬íŠ¸ì› API ì—°ê²° í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===\n');
          return { success: false, message: `API ì„œë²„ ì—°ê²° ì˜¤ë¥˜: ${response.status} ${response.data?.message || ''}` };
        }
      } catch (apiError: any) {
        console.error('=== í¬íŠ¸ì› API ì—°ê²° í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜ ===');
        if (apiError.response) {
          console.error(`ì‘ë‹µ ìƒíƒœ ì½”ë“œ: ${apiError.response.status}`);
          console.error('ì˜¤ë¥˜ ë°ì´í„°:', JSON.stringify(apiError.response.data, null, 2));
        } else if (apiError.request) {
          console.error('ìš”ì²­ì€ ë³´ëƒˆì§€ë§Œ ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', apiError.request);
        } else {
          console.error('ì˜¤ë¥˜ ë©”ì‹œì§€:', apiError.message);
        }
        console.error('ì˜¤ë¥˜ ê°ì²´:', apiError);
        console.log('=== í¬íŠ¸ì› API ì—°ê²° í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===\n');
        return { success: false, message: `API ì—°ê²° í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ${apiError.message}` };
      }
    } catch (error: any) {
      console.error('í¬íŠ¸ì› API í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error.message);
      console.log('=== í¬íŠ¸ì› API ì—°ê²° í…ŒìŠ¤íŠ¸ ì™„ë£Œ ===\n');
      return { success: false, message: `í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ${error.message}` };
    }
  }
}

// í´ë¼ì´ì–¸íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
const portoneV2Client = new PortOneV2Client(portoneApiSecret);

export default portoneV2Client;
